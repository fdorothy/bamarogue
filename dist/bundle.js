!function(t){var e={};function i(n){if(e[n])return e[n].exports;var r=e[n]={i:n,l:!1,exports:{}};return t[n].call(r.exports,r,r.exports,i),r.l=!0,r.exports}i.m=t,i.c=e,i.d=function(t,e,n){i.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:n})},i.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},i.t=function(t,e){if(1&e&&(t=i(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var n=Object.create(null);if(i.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var r in t)i.d(n,r,function(e){return t[e]}.bind(null,r));return n},i.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return i.d(e,"a",e),e},i.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},i.p="/dist/",i(i.s=8)}([function(t,e,i){"use strict";const n=2.3283064365386963e-10;class r{constructor(){this._seed=0,this._s0=0,this._s1=0,this._s2=0,this._c=0}getSeed(){return this._seed}setSeed(t){return t=t<1?1/t:t,this._seed=t,this._s0=(t>>>0)*n,t=69069*t+1>>>0,this._s1=t*n,t=69069*t+1>>>0,this._s2=t*n,this._c=1,this}getUniform(){let t=2091639*this._s0+this._c*n;return this._s0=this._s1,this._s1=this._s2,this._c=0|t,this._s2=t-this._c,this._s2}getUniformInt(t,e){let i=Math.max(t,e),n=Math.min(t,e);return Math.floor(this.getUniform()*(i-n+1))+n}getNormal(t=0,e=1){let i,n,r;do{i=2*this.getUniform()-1,n=2*this.getUniform()-1,r=i*i+n*n}while(r>1||0==r);return t+i*Math.sqrt(-2*Math.log(r)/r)*e}getPercentage(){return 1+Math.floor(100*this.getUniform())}getItem(t){return t.length?t[Math.floor(this.getUniform()*t.length)]:null}shuffle(t){let e=[],i=t.slice();for(;i.length;){let t=i.indexOf(this.getItem(i));e.push(i.splice(t,1)[0])}return e}getWeightedValue(t){let e=0;for(let i in t)e+=t[i];let i,n=this.getUniform()*e,r=0;for(i in t)if(r+=t[i],n<r)return i;return i}getState(){return[this._s0,this._s1,this._s2,this._c]}setState(t){return this._s0=t[0],this._s1=t[1],this._s2=t[2],this._c=t[3],this}clone(){return(new r).setState(this.getState())}}e.a=(new r).setSeed(Date.now())},function(t,e,i){"use strict";function n(t,e){return(t%e+e)%e}function r(t,e=0,i=1){return t<e?e:t>i?i:t}function s(t){return t.charAt(0).toUpperCase()+t.substring(1)}function a(t,...e){let i=a.map;return t.replace(/%(?:([a-z]+)|(?:{([^}]+)}))/gi,(function(n,r,a,o){if("%"==t.charAt(o-1))return n.substring(1);if(!e.length)return n;let l=e[0],h=(r||a).split(","),u=h.shift()||"",c=i[u.toLowerCase()];if(!c)return n;l=e.shift();let d=l[c].apply(l,h),p=u.charAt(0);return p!=p.toLowerCase()&&(d=s(d)),d}))}i.r(e),i.d(e,"mod",(function(){return n})),i.d(e,"clamp",(function(){return r})),i.d(e,"capitalize",(function(){return s})),i.d(e,"format",(function(){return a})),a.map={s:"toString"}},function(t,e,i){"use strict";i.r(e),i.d(e,"fromString",(function(){return s})),i.d(e,"add",(function(){return a})),i.d(e,"add_",(function(){return o})),i.d(e,"multiply",(function(){return l})),i.d(e,"multiply_",(function(){return h})),i.d(e,"interpolate",(function(){return u})),i.d(e,"lerp",(function(){return c})),i.d(e,"interpolateHSL",(function(){return d})),i.d(e,"lerpHSL",(function(){return p})),i.d(e,"randomize",(function(){return f})),i.d(e,"rgb2hsl",(function(){return m})),i.d(e,"hsl2rgb",(function(){return _})),i.d(e,"toRGB",(function(){return y})),i.d(e,"toHex",(function(){return v}));var n=i(1),r=i(0);function s(t){let e,i;if(t in S)e=S[t];else{if("#"==t.charAt(0)){let i=(t.match(/[0-9a-f]/gi)||[]).map(t=>parseInt(t,16));if(3==i.length)e=i.map(t=>17*t);else{for(let t=0;t<3;t++)i[t+1]+=16*i[t],i.splice(t,1);e=i}}else e=(i=t.match(/rgb\(([0-9, ]+)\)/i))?i[1].split(/\s*,\s*/).map(t=>parseInt(t)):[0,0,0];S[t]=e}return e.slice()}function a(t,...e){let i=t.slice();for(let t=0;t<3;t++)for(let n=0;n<e.length;n++)i[t]+=e[n][t];return i}function o(t,...e){for(let i=0;i<3;i++)for(let n=0;n<e.length;n++)t[i]+=e[n][i];return t}function l(t,...e){let i=t.slice();for(let t=0;t<3;t++){for(let n=0;n<e.length;n++)i[t]*=e[n][t]/255;i[t]=Math.round(i[t])}return i}function h(t,...e){for(let i=0;i<3;i++){for(let n=0;n<e.length;n++)t[i]*=e[n][i]/255;t[i]=Math.round(t[i])}return t}function u(t,e,i=.5){let n=t.slice();for(let r=0;r<3;r++)n[r]=Math.round(n[r]+i*(e[r]-t[r]));return n}const c=u;function d(t,e,i=.5){let n=m(t),r=m(e);for(let t=0;t<3;t++)n[t]+=i*(r[t]-n[t]);return _(n)}const p=d;function f(t,e){e instanceof Array||(e=Math.round(r.a.getNormal(0,e)));let i=t.slice();for(let t=0;t<3;t++)i[t]+=e instanceof Array?Math.round(r.a.getNormal(0,e[t])):e;return i}function m(t){let e,i=t[0]/255,n=t[1]/255,r=t[2]/255,s=Math.max(i,n,r),a=Math.min(i,n,r),o=0,l=(s+a)/2;if(s==a)e=0;else{let t=s-a;switch(e=l>.5?t/(2-s-a):t/(s+a),s){case i:o=(n-r)/t+(n<r?6:0);break;case n:o=(r-i)/t+2;break;case r:o=(i-n)/t+4}o/=6}return[o,e,l]}function g(t,e,i){return i<0&&(i+=1),i>1&&(i-=1),i<1/6?t+6*(e-t)*i:i<.5?e:i<2/3?t+(e-t)*(2/3-i)*6:t}function _(t){let e=t[2];if(0==t[1])return e=Math.round(255*e),[e,e,e];{let i=t[1],n=e<.5?e*(1+i):e+i-e*i,r=2*e-n,s=g(r,n,t[0]+1/3),a=g(r,n,t[0]),o=g(r,n,t[0]-1/3);return[Math.round(255*s),Math.round(255*a),Math.round(255*o)]}}function y(t){return`rgb(${t.map(t=>Object(n.clamp)(t,0,255)).join(",")})`}function v(t){return"#"+t.map(t=>Object(n.clamp)(t,0,255).toString(16).padStart(2,"0")).join("")}const S={black:[0,0,0],navy:[0,0,128],darkblue:[0,0,139],mediumblue:[0,0,205],blue:[0,0,255],darkgreen:[0,100,0],green:[0,128,0],teal:[0,128,128],darkcyan:[0,139,139],deepskyblue:[0,191,255],darkturquoise:[0,206,209],mediumspringgreen:[0,250,154],lime:[0,255,0],springgreen:[0,255,127],aqua:[0,255,255],cyan:[0,255,255],midnightblue:[25,25,112],dodgerblue:[30,144,255],forestgreen:[34,139,34],seagreen:[46,139,87],darkslategray:[47,79,79],darkslategrey:[47,79,79],limegreen:[50,205,50],mediumseagreen:[60,179,113],turquoise:[64,224,208],royalblue:[65,105,225],steelblue:[70,130,180],darkslateblue:[72,61,139],mediumturquoise:[72,209,204],indigo:[75,0,130],darkolivegreen:[85,107,47],cadetblue:[95,158,160],cornflowerblue:[100,149,237],mediumaquamarine:[102,205,170],dimgray:[105,105,105],dimgrey:[105,105,105],slateblue:[106,90,205],olivedrab:[107,142,35],slategray:[112,128,144],slategrey:[112,128,144],lightslategray:[119,136,153],lightslategrey:[119,136,153],mediumslateblue:[123,104,238],lawngreen:[124,252,0],chartreuse:[127,255,0],aquamarine:[127,255,212],maroon:[128,0,0],purple:[128,0,128],olive:[128,128,0],gray:[128,128,128],grey:[128,128,128],skyblue:[135,206,235],lightskyblue:[135,206,250],blueviolet:[138,43,226],darkred:[139,0,0],darkmagenta:[139,0,139],saddlebrown:[139,69,19],darkseagreen:[143,188,143],lightgreen:[144,238,144],mediumpurple:[147,112,216],darkviolet:[148,0,211],palegreen:[152,251,152],darkorchid:[153,50,204],yellowgreen:[154,205,50],sienna:[160,82,45],brown:[165,42,42],darkgray:[169,169,169],darkgrey:[169,169,169],lightblue:[173,216,230],greenyellow:[173,255,47],paleturquoise:[175,238,238],lightsteelblue:[176,196,222],powderblue:[176,224,230],firebrick:[178,34,34],darkgoldenrod:[184,134,11],mediumorchid:[186,85,211],rosybrown:[188,143,143],darkkhaki:[189,183,107],silver:[192,192,192],mediumvioletred:[199,21,133],indianred:[205,92,92],peru:[205,133,63],chocolate:[210,105,30],tan:[210,180,140],lightgray:[211,211,211],lightgrey:[211,211,211],palevioletred:[216,112,147],thistle:[216,191,216],orchid:[218,112,214],goldenrod:[218,165,32],crimson:[220,20,60],gainsboro:[220,220,220],plum:[221,160,221],burlywood:[222,184,135],lightcyan:[224,255,255],lavender:[230,230,250],darksalmon:[233,150,122],violet:[238,130,238],palegoldenrod:[238,232,170],lightcoral:[240,128,128],khaki:[240,230,140],aliceblue:[240,248,255],honeydew:[240,255,240],azure:[240,255,255],sandybrown:[244,164,96],wheat:[245,222,179],beige:[245,245,220],whitesmoke:[245,245,245],mintcream:[245,255,250],ghostwhite:[248,248,255],salmon:[250,128,114],antiquewhite:[250,235,215],linen:[250,240,230],lightgoldenrodyellow:[250,250,210],oldlace:[253,245,230],red:[255,0,0],fuchsia:[255,0,255],magenta:[255,0,255],deeppink:[255,20,147],orangered:[255,69,0],tomato:[255,99,71],hotpink:[255,105,180],coral:[255,127,80],darkorange:[255,140,0],lightsalmon:[255,160,122],orange:[255,165,0],lightpink:[255,182,193],pink:[255,192,203],gold:[255,215,0],peachpuff:[255,218,185],navajowhite:[255,222,173],moccasin:[255,228,181],bisque:[255,228,196],mistyrose:[255,228,225],blanchedalmond:[255,235,205],papayawhip:[255,239,213],lavenderblush:[255,240,245],seashell:[255,245,238],cornsilk:[255,248,220],lemonchiffon:[255,250,205],floralwhite:[255,250,240],snow:[255,250,250],yellow:[255,255,0],lightyellow:[255,255,224],ivory:[255,255,240],white:[255,255,255]}},function(t,e,i){"use strict";i.d(e,"a",(function(){return n}));class n{getContainer(){return null}setOptions(t){this._options=t}}},function(t,e,i){"use strict";(function(t){i.d(e,"a",(function(){return a}));var n=i(3),r=i(2);function s(t){let e=r.fromString(t);return 36*Math.floor(e[0]*(6/256))+6*Math.floor(e[1]*(6/256))+1*Math.floor(e[2]*(6/256))+16}class a extends n.a{constructor(){super(),this._offset=[0,0],this._cursor=[-1,-1],this._lastColor=""}schedule(t){setTimeout(t,1e3/60)}setOptions(t){super.setOptions(t);let e=[t.width,t.height],i=this.computeSize();this._offset=i.map((t,i)=>Math.floor((t-e[i])/2))}clear(){t.stdout.write(`[0;48;5;${s(this._options.bg)}m[2J`)}draw(e,i){let[n,r,a,o,l]=e,h=this._offset[0]+n,u=this._offset[1]+r,c=this.computeSize();if(h<0||h>=c[0])return;if(u<0||u>=c[1])return;if(h===this._cursor[0]&&u===this._cursor[1]||(t.stdout.write(function(t,e){return`[${e+1};${t+1}H`}(h,u)),this._cursor[0]=h,this._cursor[1]=u),i&&(a||(a=" ")),!a)return;let d=function(t,e){return`[0;38;5;${s(t)};48;5;${s(e)}m`}(o,l);if(d!==this._lastColor&&(t.stdout.write(d),this._lastColor=d),"\t"!=a){let e=[].concat(a);t.stdout.write(e[0])}this._cursor[0]++,this._cursor[0]>=c[0]&&(this._cursor[0]=0,this._cursor[1]++)}computeFontSize(){throw new Error("Terminal backend has no notion of font size")}eventToPosition(t,e){return[t,e]}computeSize(){return[t.stdout.columns,t.stdout.rows]}}}).call(this,i(5))},function(t,e){var i,n,r=t.exports={};function s(){throw new Error("setTimeout has not been defined")}function a(){throw new Error("clearTimeout has not been defined")}function o(t){if(i===setTimeout)return setTimeout(t,0);if((i===s||!i)&&setTimeout)return i=setTimeout,setTimeout(t,0);try{return i(t,0)}catch(e){try{return i.call(null,t,0)}catch(e){return i.call(this,t,0)}}}!function(){try{i="function"==typeof setTimeout?setTimeout:s}catch(t){i=s}try{n="function"==typeof clearTimeout?clearTimeout:a}catch(t){n=a}}();var l,h=[],u=!1,c=-1;function d(){u&&l&&(u=!1,l.length?h=l.concat(h):c=-1,h.length&&p())}function p(){if(!u){var t=o(d);u=!0;for(var e=h.length;e;){for(l=h,h=[];++c<e;)l&&l[c].run();c=-1,e=h.length}l=null,u=!1,function(t){if(n===clearTimeout)return clearTimeout(t);if((n===a||!n)&&clearTimeout)return n=clearTimeout,clearTimeout(t);try{n(t)}catch(e){try{return n.call(null,t)}catch(e){return n.call(this,t)}}}(t)}}function f(t,e){this.fun=t,this.array=e}function m(){}r.nextTick=function(t){var e=new Array(arguments.length-1);if(arguments.length>1)for(var i=1;i<arguments.length;i++)e[i-1]=arguments[i];h.push(new f(t,e)),1!==h.length||u||o(p)},f.prototype.run=function(){this.fun.apply(null,this.array)},r.title="browser",r.browser=!0,r.env={},r.argv=[],r.version="",r.versions={},r.on=m,r.addListener=m,r.once=m,r.off=m,r.removeListener=m,r.removeAllListeners=m,r.emit=m,r.prependListener=m,r.prependOnceListener=m,r.listeners=function(t){return[]},r.binding=function(t){throw new Error("process.binding is not supported")},r.cwd=function(){return"/"},r.chdir=function(t){throw new Error("process.chdir is not supported")},r.umask=function(){return 0}},function(t,e,i){!function(t){"use strict";class e{constructor(){if(this._components=[],this._componentsString=null,this._isRelative=!1,"string"==typeof arguments[0]){let t=arguments[0];this.componentsString=t}else if(arguments[0]instanceof e.Component&&arguments[1]instanceof e){let t=arguments[0],e=arguments[1];this._components.push(t),this._components=this._components.concat(e._components)}else if(arguments[0]instanceof Array){let t=arguments[0],e=!!arguments[1];this._components=this._components.concat(t),this._isRelative=e}}get isRelative(){return this._isRelative}get componentCount(){return this._components.length}get head(){return this._components.length>0?this._components[0]:null}get tail(){if(this._components.length>=2){let t=this._components.slice(1,this._components.length);return new e(t)}return e.self}get length(){return this._components.length}get lastComponent(){let t=this._components.length-1;return t>=0?this._components[t]:null}get containsNamedComponent(){for(let t=0,e=this._components.length;t<e;t++)if(!this._components[t].isIndex)return!0;return!1}static get self(){let t=new e;return t._isRelative=!0,t}GetComponent(t){return this._components[t]}PathByAppendingPath(t){let i=new e,n=0;for(let e=0;e<t._components.length&&t._components[e].isParent;++e)n++;for(let t=0;t<this._components.length-n;++t)i._components.push(this._components[t]);for(let e=n;e<t._components.length;++e)i._components.push(t._components[e]);return i}get componentsString(){return null==this._componentsString&&(this._componentsString=this._components.join("."),this.isRelative&&(this._componentsString="."+this._componentsString)),this._componentsString}set componentsString(t){if(this._components.length=0,this._componentsString=t,null==this._componentsString||""==this._componentsString)return;"."==this._componentsString[0]&&(this._isRelative=!0,this._componentsString=this._componentsString.substring(1));let i=this._componentsString.split(".");for(let t of i)/^(\-|\+)?([0-9]+|Infinity)$/.test(t)?this._components.push(new e.Component(parseInt(t))):this._components.push(new e.Component(t))}toString(){return this.componentsString}Equals(t){if(null==t)return!1;if(t._components.length!=this._components.length)return!1;if(t.isRelative!=this.isRelative)return!1;for(let e=0,i=t._components.length;e<i;e++)if(!t._components[e].Equals(this._components[e]))return!1;return!0}PathByAppendingComponent(t){let i=new e;return i._components.push.apply(i._components,this._components),i._components.push(t),i}}var i,n,r;function s(t,e){return t instanceof e?u(t):null}function a(t,e){if(t instanceof e)return u(t);throw new Error(`${t} is not of type ${e}`)}function o(t){return t.hasValidName&&t.name?t:null}function l(t){return void 0===t?null:t}function h(t){return"object"==typeof t&&"function"==typeof t.Equals}function u(t,e){return t}e.parentId="^",function(t){class e{constructor(t){this.index=-1,this.name=null,"string"==typeof t?this.name=t:this.index=t}get isIndex(){return this.index>=0}get isParent(){return this.name==t.parentId}static ToParent(){return new e(t.parentId)}toString(){return this.isIndex?this.index.toString():this.name}Equals(t){return null!=t&&t.isIndex==this.isIndex&&(this.isIndex?this.index==t.index:this.name==t.name)}}t.Component=e}(e||(e={})),function(t){function e(t,e){if(!t)throw void 0!==e&&console.warn(e),console.trace&&console.trace(),new Error("")}t.AssertType=function(t,i,n){e(t instanceof i,n)},t.Assert=e}(i||(i={}));class c extends Error{}function d(t){throw new c(t+" is null or undefined")}class p{constructor(){this.parent=null,this._debugMetadata=null,this._path=null}get debugMetadata(){return null===this._debugMetadata&&this.parent?this.parent.debugMetadata:this._debugMetadata}set debugMetadata(t){this._debugMetadata=t}get ownDebugMetadata(){return this._debugMetadata}DebugLineNumberOfPath(t){if(null===t)return null;let e=this.rootContentContainer;if(e){let i=e.ContentAtPath(t).obj;if(i){let t=i.debugMetadata;if(null!==t)return t.startLineNumber}}return null}get path(){if(null==this._path)if(null==this.parent)this._path=new e;else{let t=[],i=this,n=s(i.parent,k);for(;null!==n;){let r=o(i);null!=r&&r.hasValidName?t.unshift(new e.Component(r.name)):t.unshift(new e.Component(n.content.indexOf(i))),i=n,n=s(n.parent,k)}this._path=new e(t)}return this._path}ResolvePath(t){if(null===t)return d("path");if(t.isRelative){let e=s(this,k);return null===e&&(i.Assert(null!==this.parent,"Can't resolve relative path because we don't have a parent"),e=s(this.parent,k),i.Assert(null!==e,"Expected parent to be a container"),i.Assert(t.GetComponent(0).isParent),t=t.tail),null===e?d("nearestContainer"):e.ContentAtPath(t)}{let e=this.rootContentContainer;return null===e?d("contentContainer"):e.ContentAtPath(t)}}ConvertPathToRelative(t){let i=this.path,n=Math.min(t.length,i.length),r=-1;for(let e=0;e<n;++e){let n=i.GetComponent(e),s=t.GetComponent(e);if(!n.Equals(s))break;r=e}if(-1==r)return t;let s=i.componentCount-1-r,a=[];for(let t=0;t<s;++t)a.push(e.Component.ToParent());for(let e=r+1;e<t.componentCount;++e)a.push(t.GetComponent(e));return new e(a,!0)}CompactPathString(t){let e=null,i=null;return t.isRelative?(i=t.componentsString,e=this.path.PathByAppendingPath(t).componentsString):(i=this.ConvertPathToRelative(t).componentsString,e=t.componentsString),i.length<e.length?i:e}get rootContentContainer(){let t=this;for(;t.parent;)t=t.parent;return s(t,k)}Copy(){throw Error("Not Implemented: Doesn't support copying")}SetChild(t,e,i){t[e]&&(t[e]=null),t[e]=i,t[e]&&(t[e].parent=this)}}class f{constructor(t){t=void 0!==t?t.toString():"",this.string=t}get Length(){return this.string.length}Append(t){null!==t&&(this.string+=t)}AppendLine(t){void 0!==t&&this.Append(t),this.string+="\n"}AppendFormat(t,...e){this.string+=t.replace(/{(\d+)}/g,(t,i)=>void 0!==e[i]?e[i]:t)}toString(){return this.string}}class m{constructor(){if(this.originName=null,this.itemName=null,void 0!==arguments[1]){let t=arguments[0],e=arguments[1];this.originName=t,this.itemName=e}else if(arguments[0]){let t=arguments[0].toString().split(".");this.originName=t[0],this.itemName=t[1]}}static get Null(){return new m(null,null)}get isNull(){return null==this.originName&&null==this.itemName}get fullName(){return(null!==this.originName?this.originName:"?")+"."+this.itemName}toString(){return this.fullName}Equals(t){if(t instanceof m){let e=t;return e.itemName==this.itemName&&e.originName==this.originName}return!1}copy(){return new m(this.originName,this.itemName)}serialized(){return JSON.stringify({originName:this.originName,itemName:this.itemName})}static fromSerializedKey(t){let e=JSON.parse(t);if(!m.isLikeInkListItem(e))return m.Null;let i=e;return new m(i.originName,i.itemName)}static isLikeInkListItem(t){return!("object"!=typeof t||!t.hasOwnProperty("originName")||!t.hasOwnProperty("itemName")||"string"!=typeof t.originName&&null!==typeof t.originName||"string"!=typeof t.itemName&&null!==typeof t.itemName)}}class g extends Map{constructor(){if(super(arguments[0]instanceof g?arguments[0]:[]),this.origins=null,this._originNames=[],arguments[0]instanceof g){let t=arguments[0];t._originNames&&(this._originNames=t._originNames.slice())}else if("string"==typeof arguments[0]){let t=arguments[0],e=arguments[1];this.SetInitialOriginName(t);let i=e.listDefinitions.TryListGetDefinition(t,null);if(!i.exists)throw new Error("InkList origin could not be found in story when constructing new list: "+t);this.origins=[i.result]}else if("object"==typeof arguments[0]&&arguments[0].hasOwnProperty("Key")&&arguments[0].hasOwnProperty("Value")){let t=arguments[0];this.Add(t.Key,t.Value)}}AddItem(t){if(t instanceof m){let e=t;if(null==e.originName)return void this.AddItem(e.itemName);if(null===this.origins)return d("this.origins");for(let t of this.origins)if(t.name==e.originName){let i=t.TryGetValueForItem(e,0);if(i.exists)return void this.Add(e,i.result);throw new Error("Could not add the item "+e+" to this list because it doesn't exist in the original list definition in ink.")}throw new Error("Failed to add item to list because the item was from a new list definition that wasn't previously known to this list. Only items from previously known lists can be used, so that the int value can be found.")}{let e=t,i=null;if(null===this.origins)return d("this.origins");for(let t of this.origins){if(null===e)return d("itemName");if(t.ContainsItemWithName(e)){if(null!=i)throw new Error("Could not add the item "+e+" to this list because it could come from either "+t.name+" or "+i.name);i=t}}if(null==i)throw new Error("Could not add the item "+e+" to this list because it isn't known to any list definitions previously associated with this list.");let n=new m(i.name,e),r=i.ValueForItem(n);this.Add(n,r)}}ContainsItemNamed(t){for(let[e]of this)if(m.fromSerializedKey(e).itemName==t)return!0;return!1}ContainsKey(t){return this.has(t.serialized())}Add(t,e){let i=t.serialized();if(this.has(i))throw new Error("The Map already contains an entry for "+t);this.set(i,e)}Remove(t){return this.delete(t.serialized())}get Count(){return this.size}get originOfMaxItem(){if(null==this.origins)return null;let t=this.maxItem.Key.originName,e=null;return this.origins.every(i=>i.name!=t||(e=i,!1)),e}get originNames(){if(this.Count>0){null==this._originNames&&this.Count>0?this._originNames=[]:(this._originNames||(this._originNames=[]),this._originNames.length=0);for(let[t]of this){let e=m.fromSerializedKey(t);if(null===e.originName)return d("item.originName");this._originNames.push(e.originName)}}return this._originNames}SetInitialOriginName(t){this._originNames=[t]}SetInitialOriginNames(t){this._originNames=null==t?null:t.slice()}get maxItem(){let t={Key:m.Null,Value:0};for(let[e,i]of this){let n=m.fromSerializedKey(e);(t.Key.isNull||i>t.Value)&&(t={Key:n,Value:i})}return t}get minItem(){let t={Key:m.Null,Value:0};for(let[e,i]of this){let n=m.fromSerializedKey(e);(t.Key.isNull||i<t.Value)&&(t={Key:n,Value:i})}return t}get inverse(){let t=new g;if(null!=this.origins)for(let e of this.origins)for(let[i,n]of e.items){let e=m.fromSerializedKey(i);this.ContainsKey(e)||t.Add(e,n)}return t}get all(){let t=new g;if(null!=this.origins)for(let e of this.origins)for(let[i,n]of e.items){let e=m.fromSerializedKey(i);t.set(e.serialized(),n)}return t}Union(t){let e=new g(this);for(let[i,n]of t)e.set(i,n);return e}Intersect(t){let e=new g;for(let[i,n]of this)t.has(i)&&e.set(i,n);return e}Without(t){let e=new g(this);for(let[i]of t)e.delete(i);return e}Contains(t){for(let[e]of t)if(!this.has(e))return!1;return!0}GreaterThan(t){return 0!=this.Count&&(0==t.Count||this.minItem.Value>t.maxItem.Value)}GreaterThanOrEquals(t){return 0!=this.Count&&(0==t.Count||this.minItem.Value>=t.minItem.Value&&this.maxItem.Value>=t.maxItem.Value)}LessThan(t){return 0!=t.Count&&(0==this.Count||this.maxItem.Value<t.minItem.Value)}LessThanOrEquals(t){return 0!=t.Count&&(0==this.Count||this.maxItem.Value<=t.maxItem.Value&&this.minItem.Value<=t.minItem.Value)}MaxAsList(){return this.Count>0?new g(this.maxItem):new g}MinAsList(){return this.Count>0?new g(this.minItem):new g}ListWithSubRange(t,e){if(0==this.Count)return new g;let i=this.orderedItems,n=0,r=Number.MAX_SAFE_INTEGER;Number.isInteger(t)?n=t:t instanceof g&&t.Count>0&&(n=t.minItem.Value),Number.isInteger(e)?r=e:t instanceof g&&t.Count>0&&(r=e.maxItem.Value);let s=new g;s.SetInitialOriginNames(this.originNames);for(let t of i)t.Value>=n&&t.Value<=r&&s.Add(t.Key,t.Value);return s}Equals(t){if(t instanceof g==0)return!1;if(t.Count!=this.Count)return!1;for(let[e]of this)if(!t.has(e))return!1;return!0}get orderedItems(){let t=new Array;for(let[e,i]of this){let n=m.fromSerializedKey(e);t.push({Key:n,Value:i})}return t.sort((t,e)=>null===t.Key.originName?d("x.Key.originName"):null===e.Key.originName?d("y.Key.originName"):t.Value==e.Value?t.Key.originName.localeCompare(e.Key.originName):t.Value<e.Value?-1:t.Value>e.Value?1:0),t}toString(){let t=this.orderedItems,e=new f;for(let i=0;i<t.length;i++){i>0&&e.Append(", ");let n=t[i].Key;if(null===n.itemName)return d("item.itemName");e.Append(n.itemName)}return e.toString()}valueOf(){return NaN}}class _ extends Error{constructor(t){super(t),this.useEndLineNumber=!1,this.message=t,this.name="StoryException"}}function y(t,e,i){if(null===t)return{result:i,exists:!1};let n=t.get(e);return void 0===n?{result:i,exists:!1}:{result:n,exists:!0}}class v extends p{static Create(t,i){if(i){if(i===n.Int&&Number.isInteger(Number(t)))return new C(Number(t));if(i===n.Float&&!isNaN(t))return new b(Number(t))}return"boolean"==typeof t&&(t=t?1:0),"string"==typeof t?new w(String(t)):Number.isInteger(Number(t))?new C(Number(t)):isNaN(t)?t instanceof e?new T(a(t,e)):t instanceof g?new P(a(t,g)):null:new b(Number(t))}Copy(){return a(v.Create(this),p)}BadCastException(t){return new _("Can't cast "+this.valueObject+" from "+this.valueType+" to "+t)}}class S extends v{constructor(t){super(),this.value=t}get valueObject(){return this.value}toString(){return null===this.value?d("Value.value"):this.value.toString()}}class C extends S{constructor(t){super(t||0)}get isTruthy(){return 0!=this.value}get valueType(){return n.Int}Cast(t){if(null===this.value)return d("Value.value");if(t==this.valueType)return this;if(t==n.Float)return new b(this.value);if(t==n.String)return new w(""+this.value);throw this.BadCastException(t)}}class b extends S{constructor(t){super(t||0)}get isTruthy(){return 0!=this.value}get valueType(){return n.Float}Cast(t){if(null===this.value)return d("Value.value");if(t==this.valueType)return this;if(t==n.Int)return new C(this.value);if(t==n.String)return new w(""+this.value);throw this.BadCastException(t)}}class w extends S{constructor(t){if(super(t||""),this._isNewline="\n"==this.value,this._isInlineWhitespace=!0,null===this.value)return d("Value.value");this.value.length>0&&this.value.split("").every(t=>" "==t||"\t"==t||(this._isInlineWhitespace=!1,!1))}get valueType(){return n.String}get isTruthy(){return null===this.value?d("Value.value"):this.value.length>0}get isNewline(){return this._isNewline}get isInlineWhitespace(){return this._isInlineWhitespace}get isNonWhitespace(){return!this.isNewline&&!this.isInlineWhitespace}Cast(t){if(t==this.valueType)return this;if(t==n.Int){let e=function(t,e=0){let i=parseInt(t);return Number.isNaN(i)?{result:e,exists:!1}:{result:i,exists:!0}}(this.value);if(e.exists)return new C(e.result);throw this.BadCastException(t)}if(t==n.Float){let e=function(t,e=0){let i=parseFloat(t);return Number.isNaN(i)?{result:e,exists:!1}:{result:i,exists:!0}}(this.value);if(e.exists)return new b(e.result);throw this.BadCastException(t)}throw this.BadCastException(t)}}class T extends S{constructor(t){super(t)}get valueType(){return n.DivertTarget}get targetPath(){return null===this.value?d("Value.value"):this.value}set targetPath(t){this.value=t}get isTruthy(){throw new Error("Shouldn't be checking the truthiness of a divert target")}Cast(t){if(t==this.valueType)return this;throw this.BadCastException(t)}toString(){return"DivertTargetValue("+this.targetPath+")"}}class x extends S{constructor(t,e=-1){super(t),this._contextIndex=e}get contextIndex(){return this._contextIndex}set contextIndex(t){this._contextIndex=t}get variableName(){return null===this.value?d("Value.value"):this.value}set variableName(t){this.value=t}get valueType(){return n.VariablePointer}get isTruthy(){throw new Error("Shouldn't be checking the truthiness of a variable pointer")}Cast(t){if(t==this.valueType)return this;throw this.BadCastException(t)}toString(){return"VariablePointerValue("+this.variableName+")"}Copy(){return new x(this.variableName,this.contextIndex)}}class P extends S{get isTruthy(){return null===this.value?d("this.value"):this.value.Count>0}get valueType(){return n.List}Cast(t){if(null===this.value)return d("Value.value");if(t==n.Int){let t=this.value.maxItem;return t.Key.isNull?new C(0):new C(t.Value)}if(t==n.Float){let t=this.value.maxItem;return t.Key.isNull?new b(0):new b(t.Value)}if(t==n.String){let t=this.value.maxItem;return t.Key.isNull?new w(""):new w(t.Key.toString())}if(t==this.valueType)return this;throw this.BadCastException(t)}constructor(t,e){super(null),t||e?t instanceof g?this.value=new g(t):t instanceof m&&"number"==typeof e&&(this.value=new g({Key:t,Value:e})):this.value=new g}static RetainListOriginsForAssignment(t,e){let i=s(t,P),n=s(e,P);return n&&null===n.value?d("newList.value"):i&&null===i.value?d("oldList.value"):void(i&&n&&0==n.value.Count&&n.value.SetInitialOriginNames(i.value.originNames))}}!function(t){t[t.Int=0]="Int",t[t.Float=1]="Float",t[t.List=2]="List",t[t.String=3]="String",t[t.DivertTarget=4]="DivertTarget",t[t.VariablePointer=5]="VariablePointer"}(n||(n={}));class E{constructor(){this.obj=null,this.approximate=!1}get correctObj(){return this.approximate?null:this.obj}get container(){return this.obj instanceof k?this.obj:null}copy(){let t=new E;return t.obj=this.obj,t.approximate=this.approximate,t}}class k extends p{constructor(){super(...arguments),this.name="",this._content=[],this.namedContent=new Map,this.visitsShouldBeCounted=!1,this.turnIndexShouldBeCounted=!1,this.countingAtStartOnly=!1,this._pathToFirstLeafContent=null}get hasValidName(){return null!=this.name&&this.name.length>0}get content(){return this._content}set content(t){this.AddContent(t)}get namedOnlyContent(){let t=new Map;for(let[e,i]of this.namedContent){let n=a(i,p);t.set(e,n)}for(let e of this.content){let i=o(e);null!=i&&i.hasValidName&&t.delete(i.name)}return 0==t.size&&(t=null),t}set namedOnlyContent(t){let e=this.namedOnlyContent;if(null!=e)for(let[t]of e)this.namedContent.delete(t);if(null!=t)for(let[,e]of t){let t=o(e);null!=t&&this.AddToNamedContentOnly(t)}}get countFlags(){let t=0;return this.visitsShouldBeCounted&&(t|=k.CountFlags.Visits),this.turnIndexShouldBeCounted&&(t|=k.CountFlags.Turns),this.countingAtStartOnly&&(t|=k.CountFlags.CountStartOnly),t==k.CountFlags.CountStartOnly&&(t=0),t}set countFlags(t){let e=t;(e&k.CountFlags.Visits)>0&&(this.visitsShouldBeCounted=!0),(e&k.CountFlags.Turns)>0&&(this.turnIndexShouldBeCounted=!0),(e&k.CountFlags.CountStartOnly)>0&&(this.countingAtStartOnly=!0)}get pathToFirstLeafContent(){return null==this._pathToFirstLeafContent&&(this._pathToFirstLeafContent=this.path.PathByAppendingPath(this.internalPathToFirstLeafContent)),this._pathToFirstLeafContent}get internalPathToFirstLeafContent(){let t=[],i=this;for(;i instanceof k;)i.content.length>0&&(t.push(new e.Component(0)),i=i.content[0]);return new e(t)}AddContent(t){if(t instanceof Array){let e=t;for(let t of e)this.AddContent(t)}else{let e=t;if(this._content.push(e),e.parent)throw new Error("content is already in "+e.parent);e.parent=this,this.TryAddNamedContent(e)}}TryAddNamedContent(t){let e=o(t);null!=e&&e.hasValidName&&this.AddToNamedContentOnly(e)}AddToNamedContentOnly(t){i.AssertType(t,p,"Can only add Runtime.Objects to a Runtime.Container"),a(t,p).parent=this,this.namedContent.set(t.name,t)}ContentAtPath(t,e=0,i=-1){-1==i&&(i=t.length);let n=new E;n.approximate=!1;let r=this,a=this;for(let o=e;o<i;++o){let e=t.GetComponent(o);if(null==r){n.approximate=!0;break}let i=r.ContentWithPathComponent(e);if(null==i){n.approximate=!0;break}a=i,r=s(i,k)}return n.obj=a,n}InsertContent(t,e){if(this.content[e]=t,t.parent)throw new Error("content is already in "+t.parent);t.parent=this,this.TryAddNamedContent(t)}AddContentsOfContainer(t){this.content=this.content.concat(t.content);for(let e of t.content)e.parent=this,this.TryAddNamedContent(e)}ContentWithPathComponent(t){if(t.isIndex)return t.index>=0&&t.index<this.content.length?this.content[t.index]:null;if(t.isParent)return this.parent;{if(null===t.name)return d("component.name");let e=y(this.namedContent,t.name,null);return e.exists?a(e.result,p):null}}BuildStringOfHierarchy(){let t;if(0==arguments.length)return t=new f,this.BuildStringOfHierarchy(t,0,null),t.toString();t=arguments[0];let e=arguments[1],n=arguments[2];function r(){for(let i=0;i<4*e;++i)t.Append(" ")}r(),t.Append("["),this.hasValidName&&t.AppendFormat(" ({0})",this.name),this==n&&t.Append("  <---"),t.AppendLine(),e++;for(let i=0;i<this.content.length;++i){let s=this.content[i];s instanceof k?s.BuildStringOfHierarchy(t,e,n):(r(),s instanceof w?(t.Append('"'),t.Append(s.toString().replace("\n","\\n")),t.Append('"')):t.Append(s.toString())),i!=this.content.length-1&&t.Append(","),s instanceof k||s!=n||t.Append("  <---"),t.AppendLine()}let s=new Map;for(let[t,e]of this.namedContent)this.content.indexOf(a(e,p))>=0||s.set(t,e);if(s.size>0){r(),t.AppendLine("-- named: --");for(let[,r]of s)i.AssertType(r,k,"Can only print out named Containers"),r.BuildStringOfHierarchy(t,e,n),t.AppendLine()}e--,r(),t.Append("]")}}!function(t){let e;!function(t){t[t.Visits=1]="Visits",t[t.Turns=2]="Turns",t[t.CountStartOnly=4]="CountStartOnly"}(e=t.CountFlags||(t.CountFlags={}))}(k||(k={}));class O extends p{toString(){return"Glue"}}class N extends p{constructor(t=N.CommandType.NotSet){super(),this._commandType=t}get commandType(){return this._commandType}Copy(){return new N(this.commandType)}static EvalStart(){return new N(N.CommandType.EvalStart)}static EvalOutput(){return new N(N.CommandType.EvalOutput)}static EvalEnd(){return new N(N.CommandType.EvalEnd)}static Duplicate(){return new N(N.CommandType.Duplicate)}static PopEvaluatedValue(){return new N(N.CommandType.PopEvaluatedValue)}static PopFunction(){return new N(N.CommandType.PopFunction)}static PopTunnel(){return new N(N.CommandType.PopTunnel)}static BeginString(){return new N(N.CommandType.BeginString)}static EndString(){return new N(N.CommandType.EndString)}static NoOp(){return new N(N.CommandType.NoOp)}static ChoiceCount(){return new N(N.CommandType.ChoiceCount)}static Turns(){return new N(N.CommandType.Turns)}static TurnsSince(){return new N(N.CommandType.TurnsSince)}static ReadCount(){return new N(N.CommandType.ReadCount)}static Random(){return new N(N.CommandType.Random)}static SeedRandom(){return new N(N.CommandType.SeedRandom)}static VisitIndex(){return new N(N.CommandType.VisitIndex)}static SequenceShuffleIndex(){return new N(N.CommandType.SequenceShuffleIndex)}static StartThread(){return new N(N.CommandType.StartThread)}static Done(){return new N(N.CommandType.Done)}static End(){return new N(N.CommandType.End)}static ListFromInt(){return new N(N.CommandType.ListFromInt)}static ListRange(){return new N(N.CommandType.ListRange)}static ListRandom(){return new N(N.CommandType.ListRandom)}toString(){return this.commandType.toString()}}!function(t){let e;!function(t){t[t.NotSet=-1]="NotSet",t[t.EvalStart=0]="EvalStart",t[t.EvalOutput=1]="EvalOutput",t[t.EvalEnd=2]="EvalEnd",t[t.Duplicate=3]="Duplicate",t[t.PopEvaluatedValue=4]="PopEvaluatedValue",t[t.PopFunction=5]="PopFunction",t[t.PopTunnel=6]="PopTunnel",t[t.BeginString=7]="BeginString",t[t.EndString=8]="EndString",t[t.NoOp=9]="NoOp",t[t.ChoiceCount=10]="ChoiceCount",t[t.Turns=11]="Turns",t[t.TurnsSince=12]="TurnsSince",t[t.Random=13]="Random",t[t.SeedRandom=14]="SeedRandom",t[t.VisitIndex=15]="VisitIndex",t[t.SequenceShuffleIndex=16]="SequenceShuffleIndex",t[t.StartThread=17]="StartThread",t[t.Done=18]="Done",t[t.End=19]="End",t[t.ListFromInt=20]="ListFromInt",t[t.ListRange=21]="ListRange",t[t.ListRandom=22]="ListRandom",t[t.ReadCount=23]="ReadCount",t[t.TOTAL_VALUES=24]="TOTAL_VALUES"}(e=t.CommandType||(t.CommandType={}))}(N||(N={})),function(t){t[t.Tunnel=0]="Tunnel",t[t.Function=1]="Function",t[t.FunctionEvaluationFromGame=2]="FunctionEvaluationFromGame"}(r||(r={}));class A{constructor(){this.container=null,this.index=-1,2===arguments.length&&(this.container=arguments[0],this.index=arguments[1])}Resolve(){return this.index<0?this.container:null==this.container?null:0==this.container.content.length?this.container:this.index>=this.container.content.length?null:this.container.content[this.index]}get isNull(){return null==this.container}get path(){return this.isNull?null:this.index>=0?this.container.path.PathByAppendingComponent(new e.Component(this.index)):this.container.path}toString(){return this.container?"Ink Pointer -> "+this.container.path.toString()+" -- index "+this.index:"Ink Pointer (null)"}copy(){return new A(this.container,this.index)}static StartOf(t){return new A(t,0)}static get Null(){return new A(null,-1)}}class I extends p{constructor(t){super(),this._targetPath=null,this._targetPointer=A.Null,this.variableDivertName=null,this.pushesToStack=!1,this.stackPushType=0,this.isExternal=!1,this.externalArgs=0,this.isConditional=!1,this.pushesToStack=!1,void 0!==t&&(this.pushesToStack=!0,this.stackPushType=t)}get targetPath(){if(null!=this._targetPath&&this._targetPath.isRelative){let t=this.targetPointer.Resolve();t&&(this._targetPath=t.path)}return this._targetPath}set targetPath(t){this._targetPath=t,this._targetPointer=A.Null}get targetPointer(){if(this._targetPointer.isNull){let t=this.ResolvePath(this._targetPath).obj;if(null===this._targetPath)return d("this._targetPath");if(null===this._targetPath.lastComponent)return d("this._targetPath.lastComponent");if(this._targetPath.lastComponent.isIndex){if(null===t)return d("targetObj");this._targetPointer.container=t.parent instanceof k?t.parent:null,this._targetPointer.index=this._targetPath.lastComponent.index}else this._targetPointer=A.StartOf(t instanceof k?t:null)}return this._targetPointer.copy()}get targetPathString(){return null==this.targetPath?null:this.CompactPathString(this.targetPath)}set targetPathString(t){this.targetPath=null==t?null:new e(t)}get hasVariableTarget(){return null!=this.variableDivertName}Equals(t){let e=t;return e instanceof I&&this.hasVariableTarget==e.hasVariableTarget&&(this.hasVariableTarget?this.variableDivertName==e.variableDivertName:null===this.targetPath?d("this.targetPath"):this.targetPath.Equals(e.targetPath))}toString(){if(this.hasVariableTarget)return"Divert(variable: "+this.variableDivertName+")";if(null==this.targetPath)return"Divert(null)";{let t=new f,e=this.targetPath.toString();return t.Append("Divert"),this.isConditional&&t.Append("?"),this.pushesToStack&&(this.stackPushType==r.Function?t.Append(" function"):t.Append(" tunnel")),t.Append(" -> "),t.Append(this.targetPathString),t.Append(" ("),t.Append(e),t.Append(")"),t.toString()}}}class W extends p{constructor(t=!0){super(),this._pathOnChoice=null,this.hasCondition=!1,this.hasStartContent=!1,this.hasChoiceOnlyContent=!1,this.isInvisibleDefault=!1,this.onceOnly=!0,this.onceOnly=t}get pathOnChoice(){if(null!=this._pathOnChoice&&this._pathOnChoice.isRelative){let t=this.choiceTarget;t&&(this._pathOnChoice=t.path)}return this._pathOnChoice}set pathOnChoice(t){this._pathOnChoice=t}get choiceTarget(){return null===this._pathOnChoice?d("ChoicePoint._pathOnChoice"):this.ResolvePath(this._pathOnChoice).container}get pathStringOnChoice(){return null===this.pathOnChoice?d("ChoicePoint.pathOnChoice"):this.CompactPathString(this.pathOnChoice)}set pathStringOnChoice(t){this.pathOnChoice=new e(t)}get flags(){let t=0;return this.hasCondition&&(t|=1),this.hasStartContent&&(t|=2),this.hasChoiceOnlyContent&&(t|=4),this.isInvisibleDefault&&(t|=8),this.onceOnly&&(t|=16),t}set flags(t){this.hasCondition=(1&t)>0,this.hasStartContent=(2&t)>0,this.hasChoiceOnlyContent=(4&t)>0,this.isInvisibleDefault=(8&t)>0,this.onceOnly=(16&t)>0}toString(){return null===this.pathOnChoice?d("ChoicePoint.pathOnChoice"):"Choice: -> "+this.pathOnChoice.toString()}}class F extends p{constructor(t=null){super(),this.pathForCount=null,this.name=t}get containerForCount(){return null===this.pathForCount?null:this.ResolvePath(this.pathForCount).container}get pathStringForCount(){return null===this.pathForCount?null:this.CompactPathString(this.pathForCount)}set pathStringForCount(t){this.pathForCount=null===t?null:new e(t)}toString(){return null!=this.name?"var("+this.name+")":"read_count("+this.pathStringForCount+")"}}class R extends p{constructor(t,e){super(),this.variableName=t||null,this.isNewDeclaration=!!e,this.isGlobal=!1}toString(){return"VarAssign to "+this.variableName}}class V extends p{}class M extends p{constructor(){if(super(),this._name=null,this._numberOfParameters=0,this._prototype=null,this._isPrototype=!1,this._operationFuncs=null,0===arguments.length)M.GenerateNativeFunctionsIfNecessary();else if(1===arguments.length){let t=arguments[0];M.GenerateNativeFunctionsIfNecessary(),this.name=t}else if(2===arguments.length){let t=arguments[0],e=arguments[1];this._isPrototype=!0,this.name=t,this.numberOfParameters=e}}static CallWithName(t){return new M(t)}static CallExistsWithName(t){return this.GenerateNativeFunctionsIfNecessary(),this._nativeFunctions.get(t)}get name(){return null===this._name?d("NativeFunctionCall._name"):this._name}set name(t){this._name=t,this._isPrototype||(null===M._nativeFunctions?d("NativeFunctionCall._nativeFunctions"):this._prototype=M._nativeFunctions.get(this._name)||null)}get numberOfParameters(){return this._prototype?this._prototype.numberOfParameters:this._numberOfParameters}set numberOfParameters(t){this._numberOfParameters=t}Call(t){if(this._prototype)return this._prototype.Call(t);if(this.numberOfParameters!=t.length)throw new Error("Unexpected number of parameters");let e=!1;for(let i of t){if(i instanceof V)throw new _('Attempting to perform operation on a void value. Did you forget to "return" a value from a function you called here?');i instanceof P&&(e=!0)}if(2==t.length&&e)return this.CallBinaryListOperation(t);let i=this.CoerceValuesToSingleType(t),r=i[0].valueType;return r==n.Int||r==n.Float||r==n.String||r==n.DivertTarget||r==n.List?this.CallType(i):null}CallType(t){let e=a(t[0],S),i=e.valueType,r=e,s=t.length;if(2==s||1==s){if(null===this._operationFuncs)return d("NativeFunctionCall._operationFuncs");let o=this._operationFuncs.get(i);if(!o){const t=n[i];throw new _("Cannot perform operation "+this.name+" on "+t)}if(2==s){let e=a(t[1],S),i=o;if(null===r.value||null===e.value)return d("NativeFunctionCall.Call BinaryOp values");let n=i(r.value,e.value);return S.Create(n)}{let t=o;if(null===r.value)return d("NativeFunctionCall.Call UnaryOp value");let i=t(r.value);return this.name===M.Int?S.Create(i,n.Int):this.name===M.Float?S.Create(i,n.Float):S.Create(i,e.valueType)}}throw new Error("Unexpected number of parameters to NativeFunctionCall: "+t.length)}CallBinaryListOperation(t){if(("+"==this.name||"-"==this.name)&&t[0]instanceof P&&t[1]instanceof C)return this.CallListIncrementOperation(t);let e=a(t[0],S),i=a(t[1],S);if(!("&&"!=this.name&&"||"!=this.name||e.valueType==n.List&&i.valueType==n.List)){if(null===this._operationFuncs)return d("NativeFunctionCall._operationFuncs");let t=this._operationFuncs.get(n.Int);if(null===t)return d("NativeFunctionCall.CallBinaryListOperation op");let r=t(e.isTruthy?1:0,i.isTruthy?1:0);return new C(r)}if(e.valueType==n.List&&i.valueType==n.List)return this.CallType([e,i]);throw new _("Can not call use "+this.name+" operation on "+n[e.valueType]+" and "+n[i.valueType])}CallListIncrementOperation(t){let e=a(t[0],P),i=a(t[1],C),r=new g;if(null===e.value)return d("NativeFunctionCall.CallListIncrementOperation listVal.value");for(let[t,s]of e.value){let a=m.fromSerializedKey(t);if(null===this._operationFuncs)return d("NativeFunctionCall._operationFuncs");let o=this._operationFuncs.get(n.Int);if(null===i.value)return d("NativeFunctionCall.CallListIncrementOperation intVal.value");let l=o(s,i.value),h=null;if(null===e.value.origins)return d("NativeFunctionCall.CallListIncrementOperation listVal.value.origins");for(let t of e.value.origins)if(t.name==a.originName){h=t;break}if(null!=h){let t=h.TryGetItemWithValue(l,m.Null);t.exists&&r.Add(t.result,l)}}return new P(r)}CoerceValuesToSingleType(t){let e=n.Int,i=null;for(let r of t){let t=a(r,S);t.valueType>e&&(e=t.valueType),t.valueType==n.List&&(i=s(t,P))}let r=[];if(n[e]==n[n.List])for(let e of t){let t=a(e,S);if(t.valueType==n.List)r.push(t);else{if(t.valueType!=n.Int){const e=n[t.valueType];throw new _("Cannot mix Lists and "+e+" values in this operation")}{let e=parseInt(t.valueObject);if(i=a(i,P),null===i.value)return d("NativeFunctionCall.CoerceValuesToSingleType specialCaseList.value");let n=i.value.originOfMaxItem;if(null===n)return d("NativeFunctionCall.CoerceValuesToSingleType list");let s=n.TryGetItemWithValue(e,m.Null);if(!s.exists)throw new _("Could not find List item with the value "+e+" in "+n.name);{let t=new P(s.result,e);r.push(t)}}}}else for(let i of t){let t=a(i,S).Cast(e);r.push(t)}return r}static Identity(t){return t}static GenerateNativeFunctionsIfNecessary(){if(null==this._nativeFunctions){this._nativeFunctions=new Map,this.AddIntBinaryOp(this.Add,(t,e)=>t+e),this.AddIntBinaryOp(this.Subtract,(t,e)=>t-e),this.AddIntBinaryOp(this.Multiply,(t,e)=>t*e),this.AddIntBinaryOp(this.Divide,(t,e)=>Math.floor(t/e)),this.AddIntBinaryOp(this.Mod,(t,e)=>t%e),this.AddIntUnaryOp(this.Negate,t=>-t),this.AddIntBinaryOp(this.Equal,(t,e)=>t==e?1:0),this.AddIntBinaryOp(this.Greater,(t,e)=>t>e?1:0),this.AddIntBinaryOp(this.Less,(t,e)=>t<e?1:0),this.AddIntBinaryOp(this.GreaterThanOrEquals,(t,e)=>t>=e?1:0),this.AddIntBinaryOp(this.LessThanOrEquals,(t,e)=>t<=e?1:0),this.AddIntBinaryOp(this.NotEquals,(t,e)=>t!=e?1:0),this.AddIntUnaryOp(this.Not,t=>0==t?1:0),this.AddIntBinaryOp(this.And,(t,e)=>0!=t&&0!=e?1:0),this.AddIntBinaryOp(this.Or,(t,e)=>0!=t||0!=e?1:0),this.AddIntBinaryOp(this.Max,(t,e)=>Math.max(t,e)),this.AddIntBinaryOp(this.Min,(t,e)=>Math.min(t,e)),this.AddIntBinaryOp(this.Pow,(t,e)=>Math.pow(t,e)),this.AddIntUnaryOp(this.Floor,M.Identity),this.AddIntUnaryOp(this.Ceiling,M.Identity),this.AddIntUnaryOp(this.Int,M.Identity),this.AddIntUnaryOp(this.Float,t=>t),this.AddFloatBinaryOp(this.Add,(t,e)=>t+e),this.AddFloatBinaryOp(this.Subtract,(t,e)=>t-e),this.AddFloatBinaryOp(this.Multiply,(t,e)=>t*e),this.AddFloatBinaryOp(this.Divide,(t,e)=>t/e),this.AddFloatBinaryOp(this.Mod,(t,e)=>t%e),this.AddFloatUnaryOp(this.Negate,t=>-t),this.AddFloatBinaryOp(this.Equal,(t,e)=>t==e?1:0),this.AddFloatBinaryOp(this.Greater,(t,e)=>t>e?1:0),this.AddFloatBinaryOp(this.Less,(t,e)=>t<e?1:0),this.AddFloatBinaryOp(this.GreaterThanOrEquals,(t,e)=>t>=e?1:0),this.AddFloatBinaryOp(this.LessThanOrEquals,(t,e)=>t<=e?1:0),this.AddFloatBinaryOp(this.NotEquals,(t,e)=>t!=e?1:0),this.AddFloatUnaryOp(this.Not,t=>0==t?1:0),this.AddFloatBinaryOp(this.And,(t,e)=>0!=t&&0!=e?1:0),this.AddFloatBinaryOp(this.Or,(t,e)=>0!=t||0!=e?1:0),this.AddFloatBinaryOp(this.Max,(t,e)=>Math.max(t,e)),this.AddFloatBinaryOp(this.Min,(t,e)=>Math.min(t,e)),this.AddFloatBinaryOp(this.Pow,(t,e)=>Math.pow(t,e)),this.AddFloatUnaryOp(this.Floor,t=>Math.floor(t)),this.AddFloatUnaryOp(this.Ceiling,t=>Math.ceil(t)),this.AddFloatUnaryOp(this.Int,t=>Math.floor(t)),this.AddFloatUnaryOp(this.Float,M.Identity),this.AddStringBinaryOp(this.Add,(t,e)=>t+e),this.AddStringBinaryOp(this.Equal,(t,e)=>t===e?1:0),this.AddStringBinaryOp(this.NotEquals,(t,e)=>t!==e?1:0),this.AddStringBinaryOp(this.Has,(t,e)=>t.includes(e)?1:0),this.AddStringBinaryOp(this.Hasnt,(t,e)=>t.includes(e)?0:1),this.AddListBinaryOp(this.Add,(t,e)=>t.Union(e)),this.AddListBinaryOp(this.Subtract,(t,e)=>t.Without(e)),this.AddListBinaryOp(this.Has,(t,e)=>t.Contains(e)?1:0),this.AddListBinaryOp(this.Hasnt,(t,e)=>t.Contains(e)?0:1),this.AddListBinaryOp(this.Intersect,(t,e)=>t.Intersect(e)),this.AddListBinaryOp(this.Equal,(t,e)=>t.Equals(e)?1:0),this.AddListBinaryOp(this.Greater,(t,e)=>t.GreaterThan(e)?1:0),this.AddListBinaryOp(this.Less,(t,e)=>t.LessThan(e)?1:0),this.AddListBinaryOp(this.GreaterThanOrEquals,(t,e)=>t.GreaterThanOrEquals(e)?1:0),this.AddListBinaryOp(this.LessThanOrEquals,(t,e)=>t.LessThanOrEquals(e)?1:0),this.AddListBinaryOp(this.NotEquals,(t,e)=>t.Equals(e)?0:1),this.AddListBinaryOp(this.And,(t,e)=>t.Count>0&&e.Count>0?1:0),this.AddListBinaryOp(this.Or,(t,e)=>t.Count>0||e.Count>0?1:0),this.AddListUnaryOp(this.Not,t=>0==t.Count?1:0),this.AddListUnaryOp(this.Invert,t=>t.inverse),this.AddListUnaryOp(this.All,t=>t.all),this.AddListUnaryOp(this.ListMin,t=>t.MinAsList()),this.AddListUnaryOp(this.ListMax,t=>t.MaxAsList()),this.AddListUnaryOp(this.Count,t=>t.Count),this.AddListUnaryOp(this.ValueOfList,t=>t.maxItem.Value);let t=(t,e)=>t.Equals(e)?1:0,e=(t,e)=>t.Equals(e)?0:1;this.AddOpToNativeFunc(this.Equal,2,n.DivertTarget,t),this.AddOpToNativeFunc(this.NotEquals,2,n.DivertTarget,e)}}AddOpFuncForType(t,e){null==this._operationFuncs&&(this._operationFuncs=new Map),this._operationFuncs.set(t,e)}static AddOpToNativeFunc(t,e,i,n){if(null===this._nativeFunctions)return d("NativeFunctionCall._nativeFunctions");let r=this._nativeFunctions.get(t);r||(r=new M(t,e),this._nativeFunctions.set(t,r)),r.AddOpFuncForType(i,n)}static AddIntBinaryOp(t,e){this.AddOpToNativeFunc(t,2,n.Int,e)}static AddIntUnaryOp(t,e){this.AddOpToNativeFunc(t,1,n.Int,e)}static AddFloatBinaryOp(t,e){this.AddOpToNativeFunc(t,2,n.Float,e)}static AddFloatUnaryOp(t,e){this.AddOpToNativeFunc(t,1,n.Float,e)}static AddStringBinaryOp(t,e){this.AddOpToNativeFunc(t,2,n.String,e)}static AddListBinaryOp(t,e){this.AddOpToNativeFunc(t,2,n.List,e)}static AddListUnaryOp(t,e){this.AddOpToNativeFunc(t,1,n.List,e)}toString(){return'Native "'+this.name+'"'}}M.Add="+",M.Subtract="-",M.Divide="/",M.Multiply="*",M.Mod="%",M.Negate="_",M.Equal="==",M.Greater=">",M.Less="<",M.GreaterThanOrEquals=">=",M.LessThanOrEquals="<=",M.NotEquals="!=",M.Not="!",M.And="&&",M.Or="||",M.Min="MIN",M.Max="MAX",M.Pow="POW",M.Floor="FLOOR",M.Ceiling="CEILING",M.Int="INT",M.Float="FLOAT",M.Has="?",M.Hasnt="!?",M.Intersect="^",M.ListMin="LIST_MIN",M.ListMax="LIST_MAX",M.All="LIST_ALL",M.Count="LIST_COUNT",M.ValueOfList="LIST_VALUE",M.Invert="LIST_INVERT",M._nativeFunctions=null;class L extends p{constructor(t){super(),this.text=t.toString()||""}toString(){return"# "+this.text}}class D extends p{constructor(){super(...arguments),this.text="",this.index=0,this.threadAtGeneration=null,this.sourcePath="",this.targetPath=null,this.isInvisibleDefault=!1,this.originalThreadIndex=0}get pathStringOnChoice(){return null===this.targetPath?d("Choice.targetPath"):this.targetPath.toString()}set pathStringOnChoice(t){this.targetPath=new e(t)}}class j{constructor(t,e){this._name=t||"",this._items=null,this._itemNameToValues=e||new Map}get name(){return this._name}get items(){if(null==this._items){this._items=new Map;for(let[t,e]of this._itemNameToValues){let i=new m(this.name,t);this._items.set(i.serialized(),e)}}return this._items}ValueForItem(t){if(!t.itemName)return 0;let e=this._itemNameToValues.get(t.itemName);return void 0!==e?e:0}ContainsItem(t){return!!t.itemName&&t.originName==this.name&&this._itemNameToValues.has(t.itemName)}ContainsItemWithName(t){return this._itemNameToValues.has(t)}TryGetItemWithValue(t,e){for(let[e,i]of this._itemNameToValues)if(i==t)return{result:new m(this.name,e),exists:!0};return{result:m.Null,exists:!1}}TryGetValueForItem(t,e){if(!t.itemName)return{result:0,exists:!1};let i=this._itemNameToValues.get(t.itemName);return i?{result:i,exists:!0}:{result:0,exists:!1}}}class B{constructor(t){this._lists=new Map,this._allUnambiguousListValueCache=new Map;for(let e of t){this._lists.set(e.name,e);for(let[t,i]of e.items){let e=m.fromSerializedKey(t),n=new P(e,i);if(!e.itemName)throw new Error("item.itemName is null or undefined.");this._allUnambiguousListValueCache.set(e.itemName,n),this._allUnambiguousListValueCache.set(e.fullName,n)}}}get lists(){let t=[];for(let[,e]of this._lists)t.push(e);return t}TryListGetDefinition(t,e){if(null===t)return{result:e,exists:!1};let i=this._lists.get(t);return i?{result:i,exists:!0}:{result:e,exists:!1}}FindSingleItemListWithName(t){if(null===t)return d("name");let e=this._allUnambiguousListValueCache.get(t);return void 0!==e?e:null}}class G{static JArrayToRuntimeObjList(t,e=!1){let i=t.length;e&&i--;let n=[];for(let e=0;e<i;e++){let i=t[e],r=this.JTokenToRuntimeObject(i);if(null===r)return d("runtimeObj");n.push(r)}return n}static WriteDictionaryRuntimeObjs(t,e){t.WriteObjectStart();for(let[i,n]of e)t.WritePropertyStart(i),this.WriteRuntimeObject(t,n),t.WritePropertyEnd();t.WriteObjectEnd()}static WriteListRuntimeObjs(t,e){t.WriteArrayStart();for(let i of e)this.WriteRuntimeObject(t,i);t.WriteArrayEnd()}static WriteIntDictionary(t,e){t.WriteObjectStart();for(let[i,n]of e)t.WriteIntProperty(i,n);t.WriteObjectEnd()}static WriteRuntimeObject(t,e){let i=s(e,k);if(i)return void this.WriteRuntimeContainer(t,i);let n=s(e,I);if(n){let e,i="->";return n.isExternal?i="x()":n.pushesToStack&&(n.stackPushType==r.Function?i="f()":n.stackPushType==r.Tunnel&&(i="->t->")),e=n.hasVariableTarget?n.variableDivertName:n.targetPathString,t.WriteObjectStart(),t.WriteProperty(i,e),n.hasVariableTarget&&t.WriteProperty("var",!0),n.isConditional&&t.WriteProperty("c",!0),n.externalArgs>0&&t.WriteIntProperty("exArgs",n.externalArgs),void t.WriteObjectEnd()}let a=s(e,W);if(a)return t.WriteObjectStart(),t.WriteProperty("*",a.pathStringOnChoice),t.WriteIntProperty("flg",a.flags),void t.WriteObjectEnd();let o=s(e,C);if(o)return void t.WriteInt(o.value);let l=s(e,b);if(l)return void t.WriteFloat(l.value);let h=s(e,w);if(h)return void(h.isNewline?t.Write("\n",!1):(t.WriteStringStart(),t.WriteStringInner("^"),t.WriteStringInner(h.value),t.WriteStringEnd()));let u=s(e,P);if(u)return void this.WriteInkList(t,u);let c=s(e,T);if(c)return t.WriteObjectStart(),null===c.value?d("divTargetVal.value"):(t.WriteProperty("^->",c.value.componentsString),void t.WriteObjectEnd());let p=s(e,x);if(p)return t.WriteObjectStart(),t.WriteProperty("^var",p.value),t.WriteIntProperty("ci",p.contextIndex),void t.WriteObjectEnd();if(s(e,O))return void t.Write("<>");let f=s(e,N);if(f)return void t.Write(G._controlCommandNames[f.commandType]);let m=s(e,M);if(m){let e=m.name;return"^"==e&&(e="L^"),void t.Write(e)}let g=s(e,F);if(g){t.WriteObjectStart();let e=g.pathStringForCount;return null!=e?t.WriteProperty("CNT?",e):t.WriteProperty("VAR?",g.name),void t.WriteObjectEnd()}let _=s(e,R);if(_){t.WriteObjectStart();let e=_.isGlobal?"VAR=":"temp=";return t.WriteProperty(e,_.variableName),_.isNewDeclaration||t.WriteProperty("re",!0),void t.WriteObjectEnd()}if(s(e,V))return void t.Write("void");let y=s(e,L);if(y)return t.WriteObjectStart(),t.WriteProperty("#",y.text),void t.WriteObjectEnd();let v=s(e,D);if(!v)throw new Error("Failed to convert runtime object to Json token: "+e);this.WriteChoice(t,v)}static JObjectToDictionaryRuntimeObjs(t){let e=new Map;for(let i in t)if(t.hasOwnProperty(i)){let n=this.JTokenToRuntimeObject(t[i]);if(null===n)return d("inkObject");e.set(i,n)}return e}static JObjectToIntDictionary(t){let e=new Map;for(let i in t)t.hasOwnProperty(i)&&e.set(i,parseInt(t[i]));return e}static JTokenToRuntimeObject(t){if("number"==typeof t&&!isNaN(t))return S.Create(t);if("string"==typeof t){let e=t.toString(),i=e[0];if("^"==i)return new w(e.substring(1));if("\n"==i&&1==e.length)return new w("\n");if("<>"==e)return new O;for(let t=0;t<G._controlCommandNames.length;++t)if(e==G._controlCommandNames[t])return new N(t);if("L^"==e&&(e="^"),M.CallExistsWithName(e))return M.CallWithName(e);if("->->"==e)return N.PopTunnel();if("~ret"==e)return N.PopFunction();if("void"==e)return new V}if("object"==typeof t&&!Array.isArray(t)){let i,n=t;if(n["^->"])return i=n["^->"],new T(new e(i.toString()));if(n["^var"]){i=n["^var"];let t=new x(i.toString());return"ci"in n&&(i=n.ci,t.contextIndex=parseInt(i)),t}let s=!1,a=!1,o=r.Function,l=!1;if((i=n["->"])?s=!0:(i=n["f()"])?(s=!0,a=!0,o=r.Function):(i=n["->t->"])?(s=!0,a=!0,o=r.Tunnel):(i=n["x()"])&&(s=!0,l=!0,a=!1,o=r.Function),s){let t=new I;t.pushesToStack=a,t.stackPushType=o,t.isExternal=l;let e=i.toString();return(i=n.var)?t.variableDivertName=e:t.targetPathString=e,t.isConditional=!!n.c,l&&(i=n.exArgs)&&(t.externalArgs=parseInt(i)),t}if(i=n["*"]){let t=new W;return t.pathStringOnChoice=i.toString(),(i=n.flg)&&(t.flags=parseInt(i)),t}if(i=n["VAR?"])return new F(i.toString());if(i=n["CNT?"]){let t=new F;return t.pathStringForCount=i.toString(),t}let h=!1,u=!1;if((i=n["VAR="])?(h=!0,u=!0):(i=n["temp="])&&(h=!0,u=!1),h){let t=i.toString(),e=!n.re,r=new R(t,e);return r.isGlobal=u,r}if(void 0!==n["#"])return i=n["#"],new L(i.toString());if(i=n.list){let t=i,e=new g;if(i=n.origins){let t=i;e.SetInitialOriginNames(t)}for(let i in t)if(t.hasOwnProperty(i)){let n=t[i],r=new m(i),s=parseInt(n);e.Add(r,s)}return new P(e)}if(null!=n.originalChoicePath)return this.JObjectToChoice(n)}if(Array.isArray(t))return this.JArrayToContainer(t);if(null==t)return null;throw new Error("Failed to convert token to runtime object: "+JSON.stringify(t))}static WriteRuntimeContainer(t,e,i=!1){if(t.WriteArrayStart(),null===e)return d("container");for(let i of e.content)this.WriteRuntimeObject(t,i);let n=e.namedOnlyContent,r=e.countFlags,a=null!=e.name&&!i,o=null!=n||r>0||a;if(o&&t.WriteObjectStart(),null!=n)for(let[e,i]of n){let n=e,r=s(i,k);t.WritePropertyStart(n),this.WriteRuntimeContainer(t,r,!0),t.WritePropertyEnd()}a&&t.WriteProperty("#n",e.name),o?t.WriteObjectEnd():t.WriteNull(),t.WriteArrayEnd()}static JArrayToContainer(t){let e=new k;e.content=this.JArrayToRuntimeObjList(t,!0);let i=t[t.length-1];if(null!=i){let t=new Map;for(let n in i)if("#f"==n)e.countFlags=parseInt(i[n]);else if("#n"==n)e.name=i[n].toString();else{let e=this.JTokenToRuntimeObject(i[n]),r=s(e,k);r&&(r.name=n),t.set(n,e)}e.namedOnlyContent=t}return e}static JObjectToChoice(t){let e=new D;return e.text=t.text.toString(),e.index=parseInt(t.index),e.sourcePath=t.originalChoicePath.toString(),e.originalThreadIndex=parseInt(t.originalThreadIndex),e.pathStringOnChoice=t.targetPath.toString(),e}static WriteChoice(t,e){t.WriteObjectStart(),t.WriteProperty("text",e.text),t.WriteIntProperty("index",e.index),t.WriteProperty("originalChoicePath",e.sourcePath),t.WriteIntProperty("originalThreadIndex",e.originalThreadIndex),t.WriteProperty("targetPath",e.pathStringOnChoice),t.WriteObjectEnd()}static WriteInkList(t,e){let i=e.value;if(null===i)return d("rawList");t.WriteObjectStart(),t.WritePropertyStart("list"),t.WriteObjectStart();for(let[e,n]of i){let i=m.fromSerializedKey(e),r=n;if(null===i.itemName)return d("item.itemName");t.WritePropertyNameStart(),t.WritePropertyNameInner(i.originName?i.originName:"?"),t.WritePropertyNameInner("."),t.WritePropertyNameInner(i.itemName),t.WritePropertyNameEnd(),t.Write(r),t.WritePropertyEnd()}if(t.WriteObjectEnd(),t.WritePropertyEnd(),0==i.Count&&null!=i.originNames&&i.originNames.length>0){t.WritePropertyStart("origins"),t.WriteArrayStart();for(let e of i.originNames)t.Write(e);t.WriteArrayEnd(),t.WritePropertyEnd()}t.WriteObjectEnd()}static ListDefinitionsToJToken(t){let e={};for(let i of t.lists){let t={};for(let[e,n]of i.items){let i=m.fromSerializedKey(e);if(null===i.itemName)return d("item.itemName");t[i.itemName]=n}e[i.name]=t}return e}static JTokenToListDefinitions(t){let e=t,i=[];for(let t in e)if(e.hasOwnProperty(t)){let n=t.toString(),r=e[t],s=new Map;for(let i in r)if(e.hasOwnProperty(t)){let t=r[i];s.set(i,parseInt(t))}let a=new j(n,s);i.push(a)}return new B(i)}}G._controlCommandNames=(()=>{let t=[];t[N.CommandType.EvalStart]="ev",t[N.CommandType.EvalOutput]="out",t[N.CommandType.EvalEnd]="/ev",t[N.CommandType.Duplicate]="du",t[N.CommandType.PopEvaluatedValue]="pop",t[N.CommandType.PopFunction]="~ret",t[N.CommandType.PopTunnel]="->->",t[N.CommandType.BeginString]="str",t[N.CommandType.EndString]="/str",t[N.CommandType.NoOp]="nop",t[N.CommandType.ChoiceCount]="choiceCnt",t[N.CommandType.Turns]="turn",t[N.CommandType.TurnsSince]="turns",t[N.CommandType.ReadCount]="readc",t[N.CommandType.Random]="rnd",t[N.CommandType.SeedRandom]="srnd",t[N.CommandType.VisitIndex]="visit",t[N.CommandType.SequenceShuffleIndex]="seq",t[N.CommandType.StartThread]="thread",t[N.CommandType.Done]="done",t[N.CommandType.End]="end",t[N.CommandType.ListFromInt]="listInt",t[N.CommandType.ListRange]="range",t[N.CommandType.ListRandom]="lrnd";for(let e=0;e<N.CommandType.TOTAL_VALUES;++e)if(null==t[e])throw new Error("Control command not accounted for in serialisation");return t})();class U{constructor(){if(this._threadCounter=0,this._startOfRoot=A.Null,arguments[0]instanceof Y){let t=arguments[0];this._startOfRoot=A.StartOf(t.rootContentContainer),this.Reset()}else{let t=arguments[0];this._threads=[];for(let e of t._threads)this._threads.push(e.Copy());this._threadCounter=t._threadCounter,this._startOfRoot=t._startOfRoot}}get elements(){return this.callStack}get depth(){return this.elements.length}get currentElement(){let t=this._threads[this._threads.length-1].callstack;return t[t.length-1]}get currentElementIndex(){return this.callStack.length-1}get currentThread(){return this._threads[this._threads.length-1]}set currentThread(t){i.Assert(1==this._threads.length,"Shouldn't be directly setting the current thread when we have a stack of them"),this._threads.length=0,this._threads.push(t)}get canPop(){return this.callStack.length>1}Reset(){this._threads=[],this._threads.push(new U.Thread),this._threads[0].callstack.push(new U.Element(r.Tunnel,this._startOfRoot))}SetJsonToken(t,e){this._threads.length=0;let i=t.threads;for(let t of i){let i=t,n=new U.Thread(i,e);this._threads.push(n)}this._threadCounter=parseInt(t.threadCounter),this._startOfRoot=A.StartOf(e.rootContentContainer)}WriteJson(t){t.WriteObject(t=>{t.WritePropertyStart("threads"),t.WriteArrayStart();for(let e of this._threads)e.WriteJson(t);t.WriteArrayEnd(),t.WritePropertyEnd(),t.WritePropertyStart("threadCounter"),t.WriteInt(this._threadCounter),t.WritePropertyEnd()})}PushThread(){let t=this.currentThread.Copy();this._threadCounter++,t.threadIndex=this._threadCounter,this._threads.push(t)}ForkThread(){let t=this.currentThread.Copy();return this._threadCounter++,t.threadIndex=this._threadCounter,t}PopThread(){if(!this.canPopThread)throw new Error("Can't pop thread");this._threads.splice(this._threads.indexOf(this.currentThread),1)}get canPopThread(){return this._threads.length>1&&!this.elementIsEvaluateFromGame}get elementIsEvaluateFromGame(){return this.currentElement.type==r.FunctionEvaluationFromGame}Push(t,e=0,i=0){let n=new U.Element(t,this.currentElement.currentPointer,!1);n.evaluationStackHeightWhenPushed=e,n.functionStartInOutputStream=i,this.callStack.push(n)}CanPop(t=null){return!!this.canPop&&(null==t||this.currentElement.type==t)}Pop(t=null){if(!this.CanPop(t))throw new Error("Mismatched push/pop in Callstack");this.callStack.pop()}GetTemporaryVariableWithName(t,e=-1){-1==e&&(e=this.currentElementIndex+1);let i=y(this.callStack[e-1].temporaryVariables,t,null);return i.exists?i.result:null}SetTemporaryVariable(t,e,i,n=-1){-1==n&&(n=this.currentElementIndex+1);let r=this.callStack[n-1];if(!i&&!r.temporaryVariables.get(t))throw new _("Could not find temporary variable to set: "+t);let s=y(r.temporaryVariables,t,null);s.exists&&P.RetainListOriginsForAssignment(s.result,e),r.temporaryVariables.set(t,e)}ContextForVariableNamed(t){return this.currentElement.temporaryVariables.get(t)?this.currentElementIndex+1:0}ThreadWithIndex(t){let e=this._threads.filter(e=>{if(e.threadIndex==t)return e});return e.length>0?e[0]:null}get callStack(){return this.currentThread.callstack}get callStackTrace(){let t=new f;for(let e=0;e<this._threads.length;e++){let i=this._threads[e],n=e==this._threads.length-1;t.AppendFormat("=== THREAD {0}/{1} {2}===\n",e+1,this._threads.length,n?"(current) ":"");for(let e=0;e<i.callstack.length;e++){i.callstack[e].type==r.Function?t.Append("  [FUNCTION] "):t.Append("  [TUNNEL] ");let n=i.callstack[e].currentPointer;if(!n.isNull){if(t.Append("<SOMEWHERE IN "),null===n.container)return d("pointer.container");t.Append(n.container.path.toString()),t.AppendLine(">")}}}return t.toString()}}!function(t){class i{constructor(t,e,i=!1){this.evaluationStackHeightWhenPushed=0,this.functionStartInOutputStream=0,this.currentPointer=e.copy(),this.inExpressionEvaluation=i,this.temporaryVariables=new Map,this.type=t}Copy(){let t=new i(this.type,this.currentPointer,this.inExpressionEvaluation);return t.temporaryVariables=new Map(this.temporaryVariables),t.evaluationStackHeightWhenPushed=this.evaluationStackHeightWhenPushed,t.functionStartInOutputStream=this.functionStartInOutputStream,t}}t.Element=i;class n{constructor(){if(this.threadIndex=0,this.previousPointer=A.Null,this.callstack=[],arguments[0]&&arguments[1]){let t=arguments[0],n=arguments[1];this.threadIndex=parseInt(t.threadIndex);let r=t.callstack;for(let t of r){let r,s=t,a=parseInt(s.type),o=A.Null,l=s.cPath;if(void 0!==l){r=l.toString();let t=n.ContentAtPath(new e(r));if(o.container=t.container,o.index=parseInt(s.idx),null==t.obj)throw new Error("When loading state, internal story location couldn't be found: "+r+". Has the story changed since this save data was created?");if(t.approximate){if(null===o.container)return d("pointer.container");n.Warning("When loading state, exact internal story location couldn't be found: '"+r+"', so it was approximated to '"+o.container.path.toString()+"' to recover. Has the story changed since this save data was created?")}}let h=!!s.exp,u=new i(a,o,h),c=s.temp;void 0!==c?u.temporaryVariables=G.JObjectToDictionaryRuntimeObjs(c):u.temporaryVariables.clear(),this.callstack.push(u)}let s=t.previousContentObject;if(void 0!==s){let t=new e(s.toString());this.previousPointer=n.PointerAtPath(t)}}}Copy(){let t=new n;t.threadIndex=this.threadIndex;for(let e of this.callstack)t.callstack.push(e.Copy());return t.previousPointer=this.previousPointer.copy(),t}WriteJson(t){t.WriteObjectStart(),t.WritePropertyStart("callstack"),t.WriteArrayStart();for(let e of this.callstack){if(t.WriteObjectStart(),!e.currentPointer.isNull){if(null===e.currentPointer.container)return d("el.currentPointer.container");t.WriteProperty("cPath",e.currentPointer.container.path.componentsString),t.WriteIntProperty("idx",e.currentPointer.index)}t.WriteProperty("exp",e.inExpressionEvaluation),t.WriteIntProperty("type",e.type),e.temporaryVariables.size>0&&(t.WritePropertyStart("temp"),G.WriteDictionaryRuntimeObjs(t,e.temporaryVariables),t.WritePropertyEnd()),t.WriteObjectEnd()}if(t.WriteArrayEnd(),t.WritePropertyEnd(),t.WriteIntProperty("threadIndex",this.threadIndex),!this.previousPointer.isNull){let e=this.previousPointer.Resolve();if(null===e)return d("this.previousPointer.Resolve()");t.WriteProperty("previousContentObject",e.path.toString())}t.WriteObjectEnd()}}t.Thread=n}(U||(U={}));class z{constructor(t,e){this.variableChangedEventCallbacks=[],this.patch=null,this._batchObservingVariableChanges=!1,this._defaultGlobalVariables=new Map,this._changedVariablesForBatchObs=new Set,this._globalVariables=new Map,this._callStack=t,this._listDefsOrigin=e;try{return new Proxy(this,{get:(t,e)=>e in t?t[e]:t.$(e),set:(t,e,i)=>(e in t?t[e]=i:t.$(e,i),!0)})}catch(t){}}variableChangedEvent(t,e){for(let i of this.variableChangedEventCallbacks)i(t,e)}get batchObservingVariableChanges(){return this._batchObservingVariableChanges}set batchObservingVariableChanges(t){if(this._batchObservingVariableChanges=t,t)this._changedVariablesForBatchObs=new Set;else if(null!=this._changedVariablesForBatchObs){for(let t of this._changedVariablesForBatchObs){let e=this._globalVariables.get(t);e?this.variableChangedEvent(t,e):d("currentValue")}this._changedVariablesForBatchObs=null}}get callStack(){return this._callStack}set callStack(t){this._callStack=t}$(t,e){if(void 0===e){let e=null;return null!==this.patch&&(e=this.patch.TryGetGlobal(t,null),e.exists)?e.result.valueObject:(e=this._globalVariables.get(t),void 0===e&&(e=this._defaultGlobalVariables.get(t)),void 0!==e?e.valueObject:null)}{if(void 0===this._defaultGlobalVariables.get(t))throw new _("Cannot assign to a variable ("+t+") that hasn't been declared in the story");let i=S.Create(e);if(null==i)throw new _(null==e?"Cannot pass null to VariableState":"Invalid value passed to VariableState: "+e.toString());this.SetGlobal(t,i)}}ApplyPatch(){if(null===this.patch)return d("this.patch");for(let[t,e]of this.patch.globals)this._globalVariables.set(t,e);if(null!==this._changedVariablesForBatchObs)for(let t of this.patch.changedVariables)this._changedVariablesForBatchObs.add(t);this.patch=null}SetJsonToken(t){this._globalVariables.clear();for(let[e,i]of this._defaultGlobalVariables){let n=t[e];if(void 0!==n){let t=G.JTokenToRuntimeObject(n);if(null===t)return d("tokenInkObject");this._globalVariables.set(e,t)}else this._globalVariables.set(e,i)}}WriteJson(t){t.WriteObjectStart();for(let[e,i]of this._globalVariables){let n=e,r=i;if(z.dontSaveDefaultValues&&this._defaultGlobalVariables.has(n)){let t=this._defaultGlobalVariables.get(n);if(this.RuntimeObjectsEqual(r,t))continue}t.WritePropertyStart(n),G.WriteRuntimeObject(t,r),t.WritePropertyEnd()}t.WriteObjectEnd()}RuntimeObjectsEqual(t,e){if(null===t)return d("obj1");if(null===e)return d("obj2");if(t.constructor!==e.constructor)return!1;let i=s(t,C);if(null!==i)return i.value===a(e,C).value;let n=s(t,b);if(null!==n)return n.value===a(e,b).value;let r=s(t,S),o=s(e,S);if(null!==r&&null!==o)return h(r.valueObject)&&h(o.valueObject)?r.valueObject.Equals(o.valueObject):r.valueObject===o.valueObject;throw new Error("FastRoughDefinitelyEquals: Unsupported runtime object type: "+t.constructor.name)}GetVariableWithName(t,e=-1){let i=this.GetRawVariableWithName(t,e),n=s(i,x);return null!==n&&(i=this.ValueAtVariablePointer(n)),i}TryGetDefaultVariableValue(t){let e=y(this._defaultGlobalVariables,t,null);return e.exists?e.result:null}GlobalVariableExistsWithName(t){return this._globalVariables.has(t)||null!==this._defaultGlobalVariables&&this._defaultGlobalVariables.has(t)}GetRawVariableWithName(t,e){let i=null;if(0==e||-1==e){let e=null;if(null!==this.patch&&(e=this.patch.TryGetGlobal(t,null),e.exists))return e.result;if(e=y(this._globalVariables,t,null),e.exists)return e.result;if(null!==this._defaultGlobalVariables&&(e=y(this._defaultGlobalVariables,t,null),e.exists))return e.result;if(null===this._listDefsOrigin)return d("VariablesState._listDefsOrigin");let i=this._listDefsOrigin.FindSingleItemListWithName(t);if(i)return i}return i=this._callStack.GetTemporaryVariableWithName(t,e),i}ValueAtVariablePointer(t){return this.GetVariableWithName(t.variableName,t.contextIndex)}Assign(t,e){let i=t.variableName;if(null===i)return d("name");let n=-1,r=!1;if(r=t.isNewDeclaration?t.isGlobal:this.GlobalVariableExistsWithName(i),t.isNewDeclaration){let t=s(e,x);null!==t&&(e=this.ResolveVariablePointer(t))}else{let t=null;do{t=s(this.GetRawVariableWithName(i,n),x),null!=t&&(i=t.variableName,n=t.contextIndex,r=0==n)}while(null!=t)}r?this.SetGlobal(i,e):this._callStack.SetTemporaryVariable(i,e,t.isNewDeclaration,n)}SnapshotDefaultGlobals(){this._defaultGlobalVariables=new Map(this._globalVariables)}RetainListOriginsForAssignment(t,e){let i=a(t,P),n=a(e,P);i.value&&n.value&&0==n.value.Count&&n.value.SetInitialOriginNames(i.value.originNames)}SetGlobal(t,e){let i=null;if(null===this.patch&&(i=y(this._globalVariables,t,null)),null!==this.patch&&(i=this.patch.TryGetGlobal(t,null),i.exists||(i=y(this._globalVariables,t,null))),P.RetainListOriginsForAssignment(i.result,e),null===t)return d("variableName");if(null!==this.patch?this.patch.SetGlobal(t,e):this._globalVariables.set(t,e),null!==this.variableChangedEvent&&null!==i&&e!==i.result)if(this.batchObservingVariableChanges){if(null===this._changedVariablesForBatchObs)return d("this._changedVariablesForBatchObs");null!==this.patch?this.patch.AddChangedVariable(t):null!==this._changedVariablesForBatchObs&&this._changedVariablesForBatchObs.add(t)}else this.variableChangedEvent(t,e)}ResolveVariablePointer(t){let e=t.contextIndex;-1==e&&(e=this.GetContextIndexOfVariableNamed(t.variableName));let i=s(this.GetRawVariableWithName(t.variableName,e),x);return null!=i?i:new x(t.variableName,e)}GetContextIndexOfVariableNamed(t){return this.GlobalVariableExistsWithName(t)?0:this._callStack.currentElementIndex}ObserveVariableChange(t){this.variableChangedEventCallbacks.push(t)}}z.dontSaveDefaultValues=!0;class q{constructor(t){this.seed=t%2147483647,this.seed<=0&&(this.seed+=2147483646)}next(){return this.seed=16807*this.seed%2147483647}nextFloat(){return(this.next()-1)/2147483646}}class H{constructor(){if(this._changedVariables=new Set,this._visitCounts=new Map,this._turnIndices=new Map,1===arguments.length&&null!==arguments[0]){let t=arguments[0];this._globals=new Map(t._globals),this._changedVariables=new Set(t._changedVariables),this._visitCounts=new Map(t._visitCounts),this._turnIndices=new Map(t._turnIndices)}else this._globals=new Map,this._changedVariables=new Set,this._visitCounts=new Map,this._turnIndices=new Map}get globals(){return this._globals}get changedVariables(){return this._changedVariables}get visitCounts(){return this._visitCounts}get turnIndices(){return this._turnIndices}TryGetGlobal(t,e){return null!==t&&this._globals.has(t)?{result:this._globals.get(t),exists:!0}:{result:e,exists:!1}}SetGlobal(t,e){this._globals.set(t,e)}AddChangedVariable(t){return this._changedVariables.add(t)}TryGetVisitCount(t,e){return this._visitCounts.has(t)?{result:this._visitCounts.get(t),exists:!0}:{result:e,exists:!1}}SetVisitCount(t,e){this._visitCounts.set(t,e)}SetTurnIndex(t,e){this._turnIndices.set(t,e)}TryGetTurnIndex(t,e){return this._turnIndices.has(t)?{result:this._turnIndices.get(t),exists:!0}:{result:e,exists:!1}}}class X{static TextToDictionary(t){return new X.Reader(t).ToDictionary()}static TextToArray(t){return new X.Reader(t).ToArray()}}!function(t){t.Reader=class{constructor(t){this._rootObject=JSON.parse(t)}ToDictionary(){return this._rootObject}ToArray(){return this._rootObject}};class e{constructor(){this._currentPropertyName=null,this._currentString=null,this._stateStack=[],this._collectionStack=[],this._propertyNameStack=[],this._jsonObject=null}WriteObject(t){this.WriteObjectStart(),t(this),this.WriteObjectEnd()}WriteObjectStart(){this.StartNewObject(!0);let e={};if(this.state===t.Writer.State.Property){this.Assert(null!==this.currentCollection),this.Assert(null!==this.currentPropertyName);let t=this._propertyNameStack.pop();this.currentCollection[t]=e,this._collectionStack.push(e)}else this.state===t.Writer.State.Array?(this.Assert(null!==this.currentCollection),this.currentCollection.push(e),this._collectionStack.push(e)):(this.Assert(this.state===t.Writer.State.None),this._jsonObject=e,this._collectionStack.push(e));this._stateStack.push(new t.Writer.StateElement(t.Writer.State.Object))}WriteObjectEnd(){this.Assert(this.state===t.Writer.State.Object),this._collectionStack.pop(),this._stateStack.pop()}WriteProperty(t,e){if(this.WritePropertyStart(t),arguments[1]instanceof Function)(0,arguments[1])(this);else{let t=arguments[1];this.Write(t)}this.WritePropertyEnd()}WriteIntProperty(t,e){this.WritePropertyStart(t),this.WriteInt(e),this.WritePropertyEnd()}WriteFloatProperty(t,e){this.WritePropertyStart(t),this.WriteFloat(e),this.WritePropertyEnd()}WritePropertyStart(e){this.Assert(this.state===t.Writer.State.Object),this._propertyNameStack.push(e),this.IncrementChildCount(),this._stateStack.push(new t.Writer.StateElement(t.Writer.State.Property))}WritePropertyEnd(){this.Assert(this.state===t.Writer.State.Property),this.Assert(1===this.childCount),this._stateStack.pop()}WritePropertyNameStart(){this.Assert(this.state===t.Writer.State.Object),this.IncrementChildCount(),this._currentPropertyName="",this._stateStack.push(new t.Writer.StateElement(t.Writer.State.Property)),this._stateStack.push(new t.Writer.StateElement(t.Writer.State.PropertyName))}WritePropertyNameEnd(){this.Assert(this.state===t.Writer.State.PropertyName),this.Assert(null!==this._currentPropertyName),this._propertyNameStack.push(this._currentPropertyName),this._currentPropertyName=null,this._stateStack.pop()}WritePropertyNameInner(e){this.Assert(this.state===t.Writer.State.PropertyName),this.Assert(null!==this._currentPropertyName),this._currentPropertyName+=e}WriteArrayStart(){this.StartNewObject(!0);let e=[];if(this.state===t.Writer.State.Property){this.Assert(null!==this.currentCollection),this.Assert(null!==this.currentPropertyName);let t=this._propertyNameStack.pop();this.currentCollection[t]=e,this._collectionStack.push(e)}else this.state===t.Writer.State.Array?(this.Assert(null!==this.currentCollection),this.currentCollection.push(e),this._collectionStack.push(e)):(this.Assert(this.state===t.Writer.State.None),this._jsonObject=e,this._collectionStack.push(e));this._stateStack.push(new t.Writer.StateElement(t.Writer.State.Array))}WriteArrayEnd(){this.Assert(this.state===t.Writer.State.Array),this._collectionStack.pop(),this._stateStack.pop()}Write(t,e=!0){null!==t?(this.StartNewObject(!1),this._addToCurrentObject(t)):console.error("Warning: trying to write a null string")}WriteInt(t){null!==t&&(this.StartNewObject(!1),this._addToCurrentObject(Math.floor(t)))}WriteFloat(t){null!==t&&(this.StartNewObject(!1),t==Number.POSITIVE_INFINITY?this._addToCurrentObject(34e37):t==Number.NEGATIVE_INFINITY?this._addToCurrentObject(-34e37):isNaN(t)?this._addToCurrentObject(0):this._addToCurrentObject(t))}WriteNull(){this.StartNewObject(!1),this._addToCurrentObject(null)}WriteStringStart(){this.StartNewObject(!1),this._currentString="",this._stateStack.push(new t.Writer.StateElement(t.Writer.State.String))}WriteStringEnd(){this.Assert(this.state==t.Writer.State.String),this._stateStack.pop(),this._addToCurrentObject(this._currentString),this._currentString=null}WriteStringInner(e,i=!0){this.Assert(this.state===t.Writer.State.String),null!==e?this._currentString+=e:console.error("Warning: trying to write a null string")}ToString(){return null===this._jsonObject?"":JSON.stringify(this._jsonObject)}StartNewObject(e){e?this.Assert(this.state===t.Writer.State.None||this.state===t.Writer.State.Property||this.state===t.Writer.State.Array):this.Assert(this.state===t.Writer.State.Property||this.state===t.Writer.State.Array),this.state===t.Writer.State.Property&&this.Assert(0===this.childCount),this.state!==t.Writer.State.Array&&this.state!==t.Writer.State.Property||this.IncrementChildCount()}get state(){return this._stateStack.length>0?this._stateStack[this._stateStack.length-1].type:t.Writer.State.None}get childCount(){return this._stateStack.length>0?this._stateStack[this._stateStack.length-1].childCount:0}get currentCollection(){return this._collectionStack.length>0?this._collectionStack[this._collectionStack.length-1]:null}get currentPropertyName(){return this._propertyNameStack.length>0?this._propertyNameStack[this._propertyNameStack.length-1]:null}IncrementChildCount(){this.Assert(this._stateStack.length>0);let t=this._stateStack.pop();t.childCount++,this._stateStack.push(t)}Assert(t){if(!t)throw Error("Assert failed while writing JSON")}_addToCurrentObject(e){this.Assert(null!==this.currentCollection),this.state===t.Writer.State.Array?(this.Assert(Array.isArray(this.currentCollection)),this.currentCollection.push(e)):this.state===t.Writer.State.Property&&(this.Assert(!Array.isArray(this.currentCollection)),this.Assert(null!==this.currentPropertyName),this.currentCollection[this.currentPropertyName]=e,this._propertyNameStack.pop())}}t.Writer=e,function(e){let i;!function(t){t[t.None=0]="None",t[t.Object=1]="Object",t[t.Array=2]="Array",t[t.Property=3]="Property",t[t.PropertyName=4]="PropertyName",t[t.String=5]="String"}(i=e.State||(e.State={})),e.StateElement=class{constructor(e){this.type=t.Writer.State.None,this.childCount=0,this.type=e}}}(e=t.Writer||(t.Writer={}))}(X||(X={}));class K{constructor(t){this.kInkSaveStateVersion=8,this.kMinCompatibleLoadVersion=8,this._currentErrors=null,this._currentWarnings=null,this.divertedPointer=A.Null,this._currentTurnIndex=0,this.storySeed=0,this.previousRandom=0,this.didSafeExit=!1,this._currentText=null,this._currentTags=null,this._outputStreamTextDirty=!0,this._outputStreamTagsDirty=!0,this._patch=null,this.story=t,this._outputStream=[],this.OutputStreamDirty(),this._evaluationStack=[],this.callStack=new U(t),this._variablesState=new z(this.callStack,t.listDefinitions),this._visitCounts=new Map,this._turnIndices=new Map,this.currentTurnIndex=-1;let e=(new Date).getTime();this.storySeed=new q(e).next()%100,this.previousRandom=0,this._currentChoices=[],this.GoToStart()}ToJson(t=!1){let e=new X.Writer;return this.WriteJson(e),e.ToString()}toJson(t=!1){return this.ToJson(t)}LoadJson(t){let e=X.TextToDictionary(t);this.LoadJsonObj(e)}VisitCountAtPathString(t){let i;if(null!==this._patch){let n=this.story.ContentAtPath(new e(t)).container;if(null===n)throw new Error("Content at path not found: "+t);if(i=this._patch.TryGetVisitCount(n,0),i.exists)return i.result}return i=y(this._visitCounts,t,null),i.exists?i.result:0}VisitCountForContainer(t){if(null===t)return d("container");if(!t.visitsShouldBeCounted)return this.story.Error("Read count for target ("+t.name+" - on "+t.debugMetadata+") unknown. The story may need to be compiled with countAllVisits flag (-c)."),0;if(null!==this._patch){let e=this._patch.TryGetVisitCount(t,0);if(e.exists)return e.result}let e=t.path.toString(),i=y(this._visitCounts,e,null);return i.exists?i.result:0}IncrementVisitCountForContainer(t){if(null!==this._patch){let e=this.VisitCountForContainer(t);return e++,void this._patch.SetVisitCount(t,e)}let e=t.path.toString(),i=y(this._visitCounts,e,null);i.exists?this._visitCounts.set(e,i.result+1):this._visitCounts.set(e,1)}RecordTurnIndexVisitToContainer(t){if(null!==this._patch)return void this._patch.SetTurnIndex(t,this.currentTurnIndex);let e=t.path.toString();this._turnIndices.set(e,this.currentTurnIndex)}TurnsSinceForContainer(t){if(t.turnIndexShouldBeCounted||this.story.Error("TURNS_SINCE() for target ("+t.name+" - on "+t.debugMetadata+") unknown. The story may need to be compiled with countAllVisits flag (-c)."),null!==this._patch){let e=this._patch.TryGetTurnIndex(t,0);if(e.exists)return this.currentTurnIndex-e.result}let e=t.path.toString(),i=y(this._turnIndices,e,0);return i.exists?this.currentTurnIndex-i.result:-1}get callstackDepth(){return this.callStack.depth}get outputStream(){return this._outputStream}get currentChoices(){return this.canContinue?[]:this._currentChoices}get generatedChoices(){return this._currentChoices}get currentErrors(){return this._currentErrors}get currentWarnings(){return this._currentWarnings}get variablesState(){return this._variablesState}set variablesState(t){this._variablesState=t}get evaluationStack(){return this._evaluationStack}get visitCounts(){return this._visitCounts}get turnIndices(){return this._turnIndices}get currentTurnIndex(){return this._currentTurnIndex}set currentTurnIndex(t){this._currentTurnIndex=t}get currentPathString(){let t=this.currentPointer;return t.isNull?null:null===t.path?d("pointer.path"):t.path.toString()}get currentPointer(){return this.callStack.currentElement.currentPointer.copy()}set currentPointer(t){this.callStack.currentElement.currentPointer=t.copy()}get previousPointer(){return this.callStack.currentThread.previousPointer.copy()}set previousPointer(t){this.callStack.currentThread.previousPointer=t.copy()}get canContinue(){return!this.currentPointer.isNull&&!this.hasError}get hasError(){return null!=this.currentErrors&&this.currentErrors.length>0}get hasWarning(){return null!=this.currentWarnings&&this.currentWarnings.length>0}get currentText(){if(this._outputStreamTextDirty){let t=new f;for(let e of this._outputStream){let i=s(e,w);null!==i&&t.Append(i.value)}this._currentText=this.CleanOutputWhitespace(t.toString()),this._outputStreamTextDirty=!1}return this._currentText}CleanOutputWhitespace(t){let e=new f,i=-1,n=0;for(let r=0;r<t.length;r++){let s=t.charAt(r),a=" "==s||"\t"==s;a&&-1==i&&(i=r),a||("\n"!=s&&i>0&&i!=n&&e.Append(" "),i=-1),"\n"==s&&(n=r+1),a||e.Append(s)}return e.toString()}get currentTags(){if(this._outputStreamTagsDirty){this._currentTags=[];for(let t of this._outputStream){let e=s(t,L);null!==e&&this._currentTags.push(e.text)}this._outputStreamTagsDirty=!1}return this._currentTags}get inExpressionEvaluation(){return this.callStack.currentElement.inExpressionEvaluation}set inExpressionEvaluation(t){this.callStack.currentElement.inExpressionEvaluation=t}GoToStart(){this.callStack.currentElement.currentPointer=A.StartOf(this.story.mainContentContainer)}CopyAndStartPatching(){let t=new K(this.story);return t._patch=new H(this._patch),t.outputStream.push.apply(t.outputStream,this._outputStream),t.OutputStreamDirty(),t._currentChoices.push.apply(t._currentChoices,this._currentChoices),this.hasError&&(t._currentErrors=[],t._currentErrors.push.apply(t._currentErrors,this.currentErrors||[])),this.hasWarning&&(t._currentWarnings=[],t._currentWarnings.push.apply(t._currentWarnings,this.currentWarnings||[])),t.callStack=new U(this.callStack),t.variablesState=this.variablesState,t.variablesState.callStack=t.callStack,t.variablesState.patch=t._patch,t.evaluationStack.push.apply(t.evaluationStack,this.evaluationStack),this.divertedPointer.isNull||(t.divertedPointer=this.divertedPointer.copy()),t.previousPointer=this.previousPointer.copy(),t._visitCounts=this._visitCounts,t._turnIndices=this._turnIndices,t.currentTurnIndex=this.currentTurnIndex,t.storySeed=this.storySeed,t.previousRandom=this.previousRandom,t.didSafeExit=this.didSafeExit,t}RestoreAfterPatch(){this.variablesState.callStack=this.callStack,this.variablesState.patch=this._patch}ApplyAnyPatch(){if(null!==this._patch){this.variablesState.ApplyPatch();for(let[t,e]of this._patch.visitCounts)this.ApplyCountChanges(t,e,!0);for(let[t,e]of this._patch.turnIndices)this.ApplyCountChanges(t,e,!1);this._patch=null}}ApplyCountChanges(t,e,i){(i?this._visitCounts:this._turnIndices).set(t.path.toString(),e)}WriteJson(t){t.WriteObjectStart();let e=!1;for(let i of this._currentChoices){if(null===i.threadAtGeneration)return d("c.threadAtGeneration");i.originalThreadIndex=i.threadAtGeneration.threadIndex,null===this.callStack.ThreadWithIndex(i.originalThreadIndex)&&(e||(e=!0,t.WritePropertyStart("choiceThreads"),t.WriteObjectStart()),t.WritePropertyStart(i.originalThreadIndex),i.threadAtGeneration.WriteJson(t),t.WritePropertyEnd())}if(e&&(t.WriteObjectEnd(),t.WritePropertyEnd()),t.WriteProperty("callstackThreads",t=>this.callStack.WriteJson(t)),t.WriteProperty("variablesState",t=>this.variablesState.WriteJson(t)),t.WriteProperty("evalStack",t=>G.WriteListRuntimeObjs(t,this.evaluationStack)),t.WriteProperty("outputStream",t=>G.WriteListRuntimeObjs(t,this._outputStream)),t.WriteProperty("currentChoices",t=>{t.WriteArrayStart();for(let e of this._currentChoices)G.WriteChoice(t,e);t.WriteArrayEnd()}),!this.divertedPointer.isNull){if(null===this.divertedPointer.path)return d("divertedPointer");t.WriteProperty("currentDivertTarget",this.divertedPointer.path.componentsString)}t.WriteProperty("visitCounts",t=>G.WriteIntDictionary(t,this._visitCounts)),t.WriteProperty("turnIndices",t=>G.WriteIntDictionary(t,this._turnIndices)),t.WriteIntProperty("turnIdx",this.currentTurnIndex),t.WriteIntProperty("storySeed",this.storySeed),t.WriteIntProperty("previousRandom",this.previousRandom),t.WriteIntProperty("inkSaveVersion",this.kInkSaveStateVersion),t.WriteIntProperty("inkFormatVersion",Y.inkVersionCurrent),t.WriteObjectEnd()}LoadJsonObj(t){let i=t,n=i.inkSaveVersion;if(null==n)throw new _("ink save format incorrect, can't load.");if(parseInt(n)<this.kMinCompatibleLoadVersion)throw new _("Ink save format isn't compatible with the current version (saw '"+n+"', but minimum is "+this.kMinCompatibleLoadVersion+"), so can't load.");this.callStack.SetJsonToken(i.callstackThreads,this.story),this.variablesState.SetJsonToken(i.variablesState),this._evaluationStack=G.JArrayToRuntimeObjList(i.evalStack),this._outputStream=G.JArrayToRuntimeObjList(i.outputStream),this.OutputStreamDirty(),this._currentChoices=G.JArrayToRuntimeObjList(i.currentChoices);let r=i.currentDivertTarget;if(null!=r){let t=new e(r.toString());this.divertedPointer=this.story.PointerAtPath(t)}this._visitCounts=G.JObjectToIntDictionary(i.visitCounts),this._turnIndices=G.JObjectToIntDictionary(i.turnIndices),this.currentTurnIndex=parseInt(i.turnIdx),this.storySeed=parseInt(i.storySeed),this.previousRandom=parseInt(i.previousRandom);let s=i.choiceThreads;for(let t of this._currentChoices){let e=this.callStack.ThreadWithIndex(t.originalThreadIndex);if(null!=e)t.threadAtGeneration=e.Copy();else{let e=s[t.originalThreadIndex.toString()];t.threadAtGeneration=new U.Thread(e,this.story)}}}ResetErrors(){this._currentErrors=null,this._currentWarnings=null}ResetOutput(t=null){this._outputStream.length=0,null!==t&&this._outputStream.push.apply(this._outputStream,t),this.OutputStreamDirty()}PushToOutputStream(t){let e=s(t,w);if(null!==e){let t=this.TrySplittingHeadTailWhitespace(e);if(null!==t){for(let e of t)this.PushToOutputStreamIndividual(e);return void this.OutputStreamDirty()}}this.PushToOutputStreamIndividual(t),this.OutputStreamDirty()}PopFromOutputStream(t){this.outputStream.splice(this.outputStream.length-t,t),this.OutputStreamDirty()}TrySplittingHeadTailWhitespace(t){let e=t.value;if(null===e)return d("single.value");let i=-1,n=-1;for(let t=0;t<e.length;++t){let r=e[t];if("\n"!=r){if(" "==r||"\t"==r)continue;break}-1==i&&(i=t),n=t}let r=-1,s=-1;for(let t=0;t<e.length;++t){let i=e[t];if("\n"!=i){if(" "==i||"\t"==i)continue;break}-1==r&&(r=t),s=t}if(-1==i&&-1==r)return null;let a=[],o=0,l=e.length;if(-1!=i){if(i>0){let t=new w(e.substring(0,i));a.push(t)}a.push(new w("\n")),o=n+1}if(-1!=r&&(l=s),l>o){let t=e.substring(o,l-o);a.push(new w(t))}if(-1!=r&&s>n&&(a.push(new w("\n")),r<e.length-1)){let t=e.length-r-1,i=new w(e.substring(r+1,t));a.push(i)}return a}PushToOutputStreamIndividual(t){let e=s(t,O),i=s(t,w),n=!0;if(e)this.TrimNewlinesFromOutputStream(),n=!0;else if(i){let t=-1,e=this.callStack.currentElement;e.type==r.Function&&(t=e.functionStartInOutputStream);let s=-1;for(let e=this._outputStream.length-1;e>=0;e--){let i=this._outputStream[e],n=i instanceof N?i:null;if(null!=(i instanceof O?i:null)){s=e;break}if(null!=n&&n.commandType==N.CommandType.BeginString){e>=t&&(t=-1);break}}let a=-1;if(a=-1!=s&&-1!=t?Math.min(t,s):-1!=s?s:t,-1!=a){if(i.isNewline)n=!1;else if(i.isNonWhitespace&&(s>-1&&this.RemoveExistingGlue(),t>-1)){let t=this.callStack.elements;for(let e=t.length-1;e>=0;e--){let i=t[e];if(i.type!=r.Function)break;i.functionStartInOutputStream=-1}}}else i.isNewline&&(!this.outputStreamEndsInNewline&&this.outputStreamContainsContent||(n=!1))}if(n){if(null===t)return d("obj");this._outputStream.push(t),this.OutputStreamDirty()}}TrimNewlinesFromOutputStream(){let t=-1,e=this._outputStream.length-1;for(;e>=0;){let i=this._outputStream[e],n=s(i,N),r=s(i,w);if(null!=n||null!=r&&r.isNonWhitespace)break;null!=r&&r.isNewline&&(t=e),e--}if(t>=0)for(e=t;e<this._outputStream.length;)s(this._outputStream[e],w)?this._outputStream.splice(e,1):e++;this.OutputStreamDirty()}RemoveExistingGlue(){for(let t=this._outputStream.length-1;t>=0;t--){let e=this._outputStream[t];if(e instanceof O)this._outputStream.splice(t,1);else if(e instanceof N)break}this.OutputStreamDirty()}get outputStreamEndsInNewline(){if(this._outputStream.length>0)for(let t=this._outputStream.length-1;t>=0&&!(this._outputStream[t]instanceof N);t--){let e=this._outputStream[t];if(e instanceof w){if(e.isNewline)return!0;if(e.isNonWhitespace)break}}return!1}get outputStreamContainsContent(){for(let t=0;t<this._outputStream.length;t++)if(this._outputStream[t]instanceof w)return!0;return!1}get inStringEvaluation(){for(let t=this._outputStream.length-1;t>=0;t--){let e=s(this._outputStream[t],N);if(e instanceof N&&e.commandType==N.CommandType.BeginString)return!0}return!1}PushEvaluationStack(t){let e=s(t,P);if(e){let t=e.value;if(null===t)return d("rawList");if(null!=t.originNames){t.origins||(t.origins=[]),t.origins.length=0;for(let e of t.originNames){if(null===this.story.listDefinitions)return d("StoryState.story.listDefinitions");let i=this.story.listDefinitions.TryListGetDefinition(e,null);if(null===i.result)return d("StoryState def.result");t.origins.indexOf(i.result)<0&&t.origins.push(i.result)}}}if(null===t)return d("obj");this.evaluationStack.push(t)}PopEvaluationStack(t){if(void 0===t)return l(this.evaluationStack.pop());if(t>this.evaluationStack.length)throw new Error("trying to pop too many objects");return l(this.evaluationStack.splice(this.evaluationStack.length-t,t))}PeekEvaluationStack(){return this.evaluationStack[this.evaluationStack.length-1]}ForceEnd(){this.callStack.Reset(),this._currentChoices.length=0,this.currentPointer=A.Null,this.previousPointer=A.Null,this.didSafeExit=!0}TrimWhitespaceFromFunctionEnd(){i.Assert(this.callStack.currentElement.type==r.Function);let t=this.callStack.currentElement.functionStartInOutputStream;-1==t&&(t=0);for(let e=this._outputStream.length-1;e>=t;e--){let t=this._outputStream[e],i=s(t,w),n=s(t,N);if(null!=i){if(n)break;if(!i.isNewline&&!i.isInlineWhitespace)break;this._outputStream.splice(e,1),this.OutputStreamDirty()}}}PopCallStack(t=null){this.callStack.currentElement.type==r.Function&&this.TrimWhitespaceFromFunctionEnd(),this.callStack.Pop(t)}SetChosenPath(t,e){this._currentChoices.length=0;let i=this.story.PointerAtPath(t);i.isNull||-1!=i.index||(i.index=0),this.currentPointer=i,e&&this.currentTurnIndex++}StartFunctionEvaluationFromGame(t,e){this.callStack.Push(r.FunctionEvaluationFromGame,this.evaluationStack.length),this.callStack.currentElement.currentPointer=A.StartOf(t),this.PassArgumentsToEvaluationStack(e)}PassArgumentsToEvaluationStack(t){if(null!=t)for(let e=0;e<t.length;e++){if("number"!=typeof t[e]&&"string"!=typeof t[e])throw new Error("ink arguments when calling EvaluateFunction / ChoosePathStringWithParameters  must be int, float or string");this.PushEvaluationStack(S.Create(t[e]))}}TryExitFunctionEvaluationFromGame(){return this.callStack.currentElement.type==r.FunctionEvaluationFromGame&&(this.currentPointer=A.Null,this.didSafeExit=!0,!0)}CompleteFunctionEvaluationFromGame(){if(this.callStack.currentElement.type!=r.FunctionEvaluationFromGame)throw new _("Expected external function evaluation to be complete. Stack trace: "+this.callStack.callStackTrace);let t=this.callStack.currentElement.evaluationStackHeightWhenPushed,e=null;for(;this.evaluationStack.length>t;){let t=this.PopEvaluationStack();null===e&&(e=t)}if(this.PopCallStack(r.FunctionEvaluationFromGame),e){if(e instanceof V)return null;let t=a(e,S);return t.valueType==n.DivertTarget?t.valueObject.toString():t.valueObject}return null}AddError(t,e){e?(null==this._currentWarnings&&(this._currentWarnings=[]),this._currentWarnings.push(t)):(null==this._currentErrors&&(this._currentErrors=[]),this._currentErrors.push(t))}OutputStreamDirty(){this._outputStreamTextDirty=!0,this._outputStreamTagsDirty=!0}}class J{constructor(){this.startTime=void 0}get ElapsedMilliseconds(){return void 0===this.startTime?0:(new Date).getTime()-this.startTime}Start(){this.startTime=(new Date).getTime()}Stop(){this.startTime=void 0}}Number.isInteger||(Number.isInteger=function(t){return"number"==typeof t&&isFinite(t)&&t>-9007199254740992&&t<9007199254740992&&Math.floor(t)===t});class Y extends p{constructor(){let t;super(),this.inkVersionMinimumCompatible=18,this._prevContainers=[],this.allowExternalFunctionFallbacks=!1,this._listDefinitions=null,this._variableObservers=null,this._hasValidatedExternals=!1,this._temporaryEvaluationContainer=null,this._asyncContinueActive=!1,this._stateSnapshotAtLastNewline=null,this._recursiveContinueCount=0,this._asyncSaving=!1,this._profiler=null;let e=null,i=null;if(arguments[0]instanceof k)t=arguments[0],void 0!==arguments[1]&&(e=arguments[1]),this._mainContentContainer=t;else if("string"==typeof arguments[0]){let t=arguments[0];i=X.TextToDictionary(t)}else i=arguments[0];if(null!=e&&(this._listDefinitions=new B(e)),this._externals=new Map,null!==i){let t=i,e=t.inkVersion;if(null==e)throw new Error("ink version number not found. Are you sure it's a valid .ink.json file?");let n=parseInt(e);if(n>Y.inkVersionCurrent)throw new Error("Version of ink used to build story was newer than the current version of the engine");if(n<this.inkVersionMinimumCompatible)throw new Error("Version of ink used to build story is too old to be loaded by this version of the engine");n!=Y.inkVersionCurrent&&console.warn("WARNING: Version of ink used to build story doesn't match current version of engine. Non-critical, but recommend synchronising.");let r,s=t.root;if(null==s)throw new Error("Root node for ink not found. Are you sure it's a valid .ink.json file?");(r=t.listDefs)&&(this._listDefinitions=G.JTokenToListDefinitions(r)),this._mainContentContainer=a(G.JTokenToRuntimeObject(s),k),this.ResetState()}}get currentChoices(){let t=[];if(null===this._state)return d("this._state");for(let e of this._state.currentChoices)e.isInvisibleDefault||(e.index=t.length,t.push(e));return t}get currentText(){return this.IfAsyncWeCant("call currentText since it's a work in progress"),this.state.currentText}get currentTags(){return this.IfAsyncWeCant("call currentTags since it's a work in progress"),this.state.currentTags}get currentErrors(){return this.state.currentErrors}get currentWarnings(){return this.state.currentWarnings}get hasError(){return this.state.hasError}get hasWarning(){return this.state.hasWarning}get variablesState(){return this.state.variablesState}get listDefinitions(){return this._listDefinitions}get state(){return this._state}StartProfiling(){}EndProfiling(){}ToJson(t){let e=!1;if(t||(e=!0,t=new X.Writer),t.WriteObjectStart(),t.WriteIntProperty("inkVersion",Y.inkVersionCurrent),t.WriteProperty("root",t=>G.WriteRuntimeContainer(t,this._mainContentContainer)),null!=this._listDefinitions){t.WritePropertyStart("listDefs"),t.WriteObjectStart();for(let e of this._listDefinitions.lists){t.WritePropertyStart(e.name),t.WriteObjectStart();for(let[i,n]of e.items){let e=m.fromSerializedKey(i),r=n;t.WriteIntProperty(e.itemName,r)}t.WriteObjectEnd(),t.WritePropertyEnd()}t.WriteObjectEnd(),t.WritePropertyEnd()}if(t.WriteObjectEnd(),e)return t.ToString()}ResetState(){this.IfAsyncWeCant("ResetState"),this._state=new K(this),this._state.variablesState.ObserveVariableChange(this.VariableStateDidChangeEvent.bind(this)),this.ResetGlobals()}ResetErrors(){if(null===this._state)return d("this._state");this._state.ResetErrors()}ResetCallstack(){if(this.IfAsyncWeCant("ResetCallstack"),null===this._state)return d("this._state");this._state.ForceEnd()}ResetGlobals(){if(this._mainContentContainer.namedContent.get("global decl")){let t=this.state.currentPointer.copy();this.ChoosePath(new e("global decl"),!1),this.ContinueInternal(),this.state.currentPointer=t}this.state.variablesState.SnapshotDefaultGlobals()}Continue(){return this.ContinueAsync(0),this.currentText}get canContinue(){return this.state.canContinue}get asyncContinueComplete(){return!this._asyncContinueActive}ContinueAsync(t){this._hasValidatedExternals||this.ValidateExternalBindings(),this.ContinueInternal(t)}ContinueInternal(t=0){null!=this._profiler&&this._profiler.PreContinue();let e=t>0;if(this._recursiveContinueCount++,!this._asyncContinueActive){if(this._asyncContinueActive=e,!this.canContinue)throw new _("Can't continue - should check canContinue before calling Continue");this._state.didSafeExit=!1,this._state.ResetOutput(),1==this._recursiveContinueCount&&(this._state.variablesState.batchObservingVariableChanges=!0)}let i=new J;i.Start();let n=!1;do{try{n=this.ContinueSingleStep()}catch(t){if(!(t instanceof _))throw t;this.AddError(t.message,void 0,t.useEndLineNumber);break}if(n)break;if(this._asyncContinueActive&&i.ElapsedMilliseconds>t)break}while(this.canContinue);i.Stop(),!n&&this.canContinue||(null!==this._stateSnapshotAtLastNewline&&this.RestoreStateSnapshot(),this.canContinue||(this.state.callStack.canPopThread&&this.AddError("Thread available to pop, threads should always be flat by the end of evaluation?"),0!=this.state.generatedChoices.length||this.state.didSafeExit||null!=this._temporaryEvaluationContainer||(this.state.callStack.CanPop(r.Tunnel)?this.AddError("unexpectedly reached end of content. Do you need a '->->' to return from a tunnel?"):this.state.callStack.CanPop(r.Function)?this.AddError("unexpectedly reached end of content. Do you need a '~ return'?"):this.state.callStack.canPop?this.AddError("unexpectedly reached end of content for unknown reason. Please debug compiler!"):this.AddError("ran out of content. Do you need a '-> DONE' or '-> END'?"))),this.state.didSafeExit=!1,1==this._recursiveContinueCount&&(this._state.variablesState.batchObservingVariableChanges=!1),this._asyncContinueActive=!1),this._recursiveContinueCount--,null!=this._profiler&&this._profiler.PostContinue()}ContinueSingleStep(){if(null!=this._profiler&&this._profiler.PreStep(),this.Step(),null!=this._profiler&&this._profiler.PostStep(),this.canContinue||this.state.callStack.elementIsEvaluateFromGame||this.TryFollowDefaultInvisibleChoice(),null!=this._profiler&&this._profiler.PreSnapshot(),!this.state.inStringEvaluation){if(null!==this._stateSnapshotAtLastNewline){if(null===this._stateSnapshotAtLastNewline.currentTags)return d("this._stateAtLastNewline.currentTags");if(null===this.state.currentTags)return d("this.state.currentTags");let t=this.CalculateNewlineOutputStateChange(this._stateSnapshotAtLastNewline.currentText,this.state.currentText,this._stateSnapshotAtLastNewline.currentTags.length,this.state.currentTags.length);if(t==Y.OutputStateChange.ExtendedBeyondNewline)return this.RestoreStateSnapshot(),!0;t==Y.OutputStateChange.NewlineRemoved&&this.DiscardSnapshot()}this.state.outputStreamEndsInNewline&&(this.canContinue?null==this._stateSnapshotAtLastNewline&&this.StateSnapshot():this.DiscardSnapshot())}return null!=this._profiler&&this._profiler.PostSnapshot(),!1}CalculateNewlineOutputStateChange(t,e,i,n){if(null===t)return d("prevText");if(null===e)return d("currText");let r=e.length>=t.length&&"\n"==e.charAt(t.length-1);if(i==n&&t.length==e.length&&r)return Y.OutputStateChange.NoChange;if(!r)return Y.OutputStateChange.NewlineRemoved;if(n>i)return Y.OutputStateChange.ExtendedBeyondNewline;for(let i=t.length;i<e.length;i++){let t=e.charAt(i);if(" "!=t&&"\t"!=t)return Y.OutputStateChange.ExtendedBeyondNewline}return Y.OutputStateChange.NoChange}ContinueMaximally(){this.IfAsyncWeCant("ContinueMaximally");let t=new f;for(;this.canContinue;)t.Append(this.Continue());return t.toString()}ContentAtPath(t){return this.mainContentContainer.ContentAtPath(t)}KnotContainerWithName(t){let e=this.mainContentContainer.namedContent.get(t);return e instanceof k?e:null}PointerAtPath(t){if(0==t.length)return A.Null;let e=new A,i=t.length,n=null;return null===t.lastComponent?d("path.lastComponent"):(t.lastComponent.isIndex?(i=t.length-1,n=this.mainContentContainer.ContentAtPath(t,void 0,i),e.container=n.container,e.index=t.lastComponent.index):(n=this.mainContentContainer.ContentAtPath(t),e.container=n.container,e.index=-1),null==n.obj||n.obj==this.mainContentContainer&&i>0?this.Error("Failed to find content at path '"+t+"', and no approximation of it was possible."):n.approximate&&this.Warning("Failed to find content at path '"+t+"', so it was approximated to: '"+n.obj.path+"'."),e)}StateSnapshot(){this._stateSnapshotAtLastNewline=this._state,this._state=this._state.CopyAndStartPatching()}RestoreStateSnapshot(){null===this._stateSnapshotAtLastNewline&&d("_stateSnapshotAtLastNewline"),this._stateSnapshotAtLastNewline.RestoreAfterPatch(),this._state=this._stateSnapshotAtLastNewline,this._stateSnapshotAtLastNewline=null,this._asyncSaving||this._state.ApplyAnyPatch()}DiscardSnapshot(){this._asyncSaving||this._state.ApplyAnyPatch(),this._stateSnapshotAtLastNewline=null}CopyStateForBackgroundThreadSave(){if(this.IfAsyncWeCant("start saving on a background thread"),this._asyncSaving)throw new Error("Story is already in background saving mode, can't call CopyStateForBackgroundThreadSave again!");let t=this._state;return this._state=this._state.CopyAndStartPatching(),this._asyncSaving=!0,t}BackgroundSaveComplete(){null===this._stateSnapshotAtLastNewline&&this._state.ApplyAnyPatch(),this._asyncSaving=!1}Step(){let t=!0,e=this.state.currentPointer.copy();if(e.isNull)return;let i=s(e.Resolve(),k);for(;i&&(this.VisitContainer(i,!0),0!=i.content.length);)e=A.StartOf(i),i=s(e.Resolve(),k);this.state.currentPointer=e.copy(),null!=this._profiler&&this._profiler.Step(this.state.callStack);let n=e.Resolve(),r=this.PerformLogicAndFlowControl(n);if(this.state.currentPointer.isNull)return;r&&(t=!1);let a=s(n,W);if(a){let e=this.ProcessChoice(a);e&&this.state.generatedChoices.push(e),n=null,t=!1}if(n instanceof k&&(t=!1),t){let t=s(n,x);if(t&&-1==t.contextIndex){let e=this.state.callStack.ContextForVariableNamed(t.variableName);n=new x(t.variableName,e)}this.state.inExpressionEvaluation?this.state.PushEvaluationStack(n):this.state.PushToOutputStream(n)}this.NextContent();let o=s(n,N);o&&o.commandType==N.CommandType.StartThread&&this.state.callStack.PushThread()}VisitContainer(t,e){t.countingAtStartOnly&&!e||(t.visitsShouldBeCounted&&this.state.IncrementVisitCountForContainer(t),t.turnIndexShouldBeCounted&&this.state.RecordTurnIndexVisitToContainer(t))}VisitChangedContainersDueToDivert(){let t=this.state.previousPointer.copy(),e=this.state.currentPointer.copy();if(e.isNull||-1==e.index)return;if(this._prevContainers.length=0,!t.isNull){let e=s(t.Resolve(),k)||s(t.container,k);for(;e;)this._prevContainers.push(e),e=s(e.parent,k)}let i=e.Resolve();if(null==i)return;let n=s(i.parent,k);for(;n&&(this._prevContainers.indexOf(n)<0||n.countingAtStartOnly);){let t=n.content.length>0&&i==n.content[0];this.VisitContainer(n,t),i=n,n=s(n.parent,k)}}ProcessChoice(t){let e=!0;if(t.hasCondition){let t=this.state.PopEvaluationStack();this.IsTruthy(t)||(e=!1)}let i="",n="";if(t.hasChoiceOnlyContent&&(n=a(this.state.PopEvaluationStack(),w).value||""),t.hasStartContent&&(i=a(this.state.PopEvaluationStack(),w).value||""),t.onceOnly&&this.state.VisitCountForContainer(t.choiceTarget)>0&&(e=!1),!e)return null;let r=new D;return r.targetPath=t.pathOnChoice,r.sourcePath=t.path.toString(),r.isInvisibleDefault=t.isInvisibleDefault,r.threadAtGeneration=this.state.callStack.ForkThread(),r.text=(i+n).replace(/^[ \t]+|[ \t]+$/g,""),r}IsTruthy(t){if(t instanceof S){let e=t;if(e instanceof T){let t=e;return this.Error("Shouldn't use a divert target (to "+t.targetPath+") as a conditional value. Did you intend a function call 'likeThis()' or a read count check 'likeThis'? (no arrows)"),!1}return e.isTruthy}return!1}PerformLogicAndFlowControl(t){if(null==t)return!1;if(t instanceof I){let e=t;if(e.isConditional){let t=this.state.PopEvaluationStack();if(!this.IsTruthy(t))return!0}if(e.hasVariableTarget){let t=e.variableDivertName,i=this.state.variablesState.GetVariableWithName(t);if(null==i)this.Error("Tried to divert using a target from a variable that could not be found ("+t+")");else if(!(i instanceof T)){let e=s(i,C),n="Tried to divert to a target from a variable, but the variable ("+t+") didn't contain a divert target, it ";e instanceof C&&0==e.value?n+="was empty/null (the value 0).":n+="contained '"+i+"'.",this.Error(n)}let n=a(i,T);this.state.divertedPointer=this.PointerAtPath(n.targetPath)}else{if(e.isExternal)return this.CallExternalFunction(e.targetPathString,e.externalArgs),!0;this.state.divertedPointer=e.targetPointer.copy()}return e.pushesToStack&&this.state.callStack.Push(e.stackPushType,void 0,this.state.outputStream.length),this.state.divertedPointer.isNull&&!e.isExternal&&(e&&e.debugMetadata&&null!=e.debugMetadata.sourceName?this.Error("Divert target doesn't exist: "+e.debugMetadata.sourceName):this.Error("Divert resolution failed: "+e)),!0}if(t instanceof N){let e=t;switch(e.commandType){case N.CommandType.EvalStart:this.Assert(!1===this.state.inExpressionEvaluation,"Already in expression evaluation?"),this.state.inExpressionEvaluation=!0;break;case N.CommandType.EvalEnd:this.Assert(!0===this.state.inExpressionEvaluation,"Not in expression evaluation mode"),this.state.inExpressionEvaluation=!1;break;case N.CommandType.EvalOutput:if(this.state.evaluationStack.length>0){let t=this.state.PopEvaluationStack();if(!(t instanceof V)){let e=new w(t.toString());this.state.PushToOutputStream(e)}}break;case N.CommandType.NoOp:break;case N.CommandType.Duplicate:this.state.PushEvaluationStack(this.state.PeekEvaluationStack());break;case N.CommandType.PopEvaluatedValue:this.state.PopEvaluationStack();break;case N.CommandType.PopFunction:case N.CommandType.PopTunnel:let t=e.commandType==N.CommandType.PopFunction?r.Function:r.Tunnel,i=null;if(t==r.Tunnel){let t=this.state.PopEvaluationStack();i=s(t,T),null===i&&this.Assert(t instanceof V,"Expected void if ->-> doesn't override target")}if(this.state.TryExitFunctionEvaluationFromGame())break;if(this.state.callStack.currentElement.type==t&&this.state.callStack.canPop)this.state.PopCallStack(),i&&(this.state.divertedPointer=this.PointerAtPath(i.targetPath));else{let e=new Map;e.set(r.Function,"function return statement (~ return)"),e.set(r.Tunnel,"tunnel onwards statement (->->)");let i=e.get(this.state.callStack.currentElement.type);this.state.callStack.canPop||(i="end of flow (-> END or choice)");let n="Found "+e.get(t)+", when expected "+i;this.Error(n)}break;case N.CommandType.BeginString:this.state.PushToOutputStream(e),this.Assert(!0===this.state.inExpressionEvaluation,"Expected to be in an expression when evaluating a string"),this.state.inExpressionEvaluation=!1;break;case N.CommandType.EndString:let n=[],o=0;for(let t=this.state.outputStream.length-1;t>=0;--t){let e=this.state.outputStream[t];o++;let i=s(e,N);if(i&&i.commandType==N.CommandType.BeginString)break;e instanceof w&&n.push(e)}this.state.PopFromOutputStream(o),n=n.reverse();let l=new f;for(let t of n)l.Append(t.toString());this.state.inExpressionEvaluation=!0,this.state.PushEvaluationStack(new w(l.toString()));break;case N.CommandType.ChoiceCount:let h=this.state.generatedChoices.length;this.state.PushEvaluationStack(new C(h));break;case N.CommandType.Turns:this.state.PushEvaluationStack(new C(this.state.currentTurnIndex+1));break;case N.CommandType.TurnsSince:case N.CommandType.ReadCount:let u=this.state.PopEvaluationStack();if(!(u instanceof T)){let t="";u instanceof C&&(t=". Did you accidentally pass a read count ('knot_name') instead of a target ('-> knot_name')?"),this.Error("TURNS_SINCE / READ_COUNT expected a divert target (knot, stitch, label name), but saw "+u+t);break}let c,p=a(u,T),y=s(this.ContentAtPath(p.targetPath).correctObj,k);null!=y?c=e.commandType==N.CommandType.TurnsSince?this.state.TurnsSinceForContainer(y):this.state.VisitCountForContainer(y):(c=e.commandType==N.CommandType.TurnsSince?-1:0,this.Warning("Failed to find container for "+e.toString()+" lookup at "+p.targetPath.toString())),this.state.PushEvaluationStack(new C(c));break;case N.CommandType.Random:{let t=s(this.state.PopEvaluationStack(),C),e=s(this.state.PopEvaluationStack(),C);if(null==e||e instanceof C==0)return this.Error("Invalid value for minimum parameter of RANDOM(min, max)");if(null==t||e instanceof C==0)return this.Error("Invalid value for maximum parameter of RANDOM(min, max)");if(null===t.value)return d("maxInt.value");if(null===e.value)return d("minInt.value");let i=t.value-e.value+1;i<=0&&this.Error("RANDOM was called with minimum as "+e.value+" and maximum as "+t.value+". The maximum must be larger");let n=this.state.storySeed+this.state.previousRandom,r=new q(n).next(),a=r%i+e.value;this.state.PushEvaluationStack(new C(a)),this.state.previousRandom=r;break}case N.CommandType.SeedRandom:let v=s(this.state.PopEvaluationStack(),C);if(null==v||v instanceof C==0)return this.Error("Invalid value passed to SEED_RANDOM");if(null===v.value)return d("minInt.value");this.state.storySeed=v.value,this.state.previousRandom=0,this.state.PushEvaluationStack(new V);break;case N.CommandType.VisitIndex:let b=this.state.VisitCountForContainer(this.state.currentPointer.container)-1;this.state.PushEvaluationStack(new C(b));break;case N.CommandType.SequenceShuffleIndex:let x=this.NextSequenceShuffleIndex();this.state.PushEvaluationStack(new C(x));break;case N.CommandType.StartThread:break;case N.CommandType.Done:this.state.callStack.canPopThread?this.state.callStack.PopThread():(this.state.didSafeExit=!0,this.state.currentPointer=A.Null);break;case N.CommandType.End:this.state.ForceEnd();break;case N.CommandType.ListFromInt:let E=s(this.state.PopEvaluationStack(),C),O=a(this.state.PopEvaluationStack(),w);if(null===E)throw new _("Passed non-integer when creating a list element from a numerical value.");let I=null;if(null===this.listDefinitions)return d("this.listDefinitions");let W=this.listDefinitions.TryListGetDefinition(O.value,null);if(!W.exists)throw new _("Failed to find LIST called "+O.value);{if(null===E.value)return d("minInt.value");let t=W.result.TryGetItemWithValue(E.value,m.Null);t.exists&&(I=new P(t.result,E.value))}null==I&&(I=new P),this.state.PushEvaluationStack(I);break;case N.CommandType.ListRange:let F=s(this.state.PopEvaluationStack(),S),R=s(this.state.PopEvaluationStack(),S),M=s(this.state.PopEvaluationStack(),P);if(null===M||null===R||null===F)throw new _("Expected list, minimum and maximum for LIST_RANGE");if(null===M.value)return d("targetList.value");let L=M.value.ListWithSubRange(R.valueObject,F.valueObject);this.state.PushEvaluationStack(new P(L));break;case N.CommandType.ListRandom:{let t=this.state.PopEvaluationStack();if(null===t)throw new _("Expected list for LIST_RANDOM");let e=t.value,i=null;if(null===e)throw d("list");if(0==e.Count)i=new g;else{let t=this.state.storySeed+this.state.previousRandom,n=new q(t).next(),r=n%e.Count,s=e.entries();for(let t=0;t<=r-1;t++)s.next();let a=s.next().value,o={Key:m.fromSerializedKey(a[0]),Value:a[1]};if(null===o.Key.originName)return d("randomItem.Key.originName");i=new g(o.Key.originName,this),i.Add(o.Key,o.Value),this.state.previousRandom=n}this.state.PushEvaluationStack(new P(i));break}default:this.Error("unhandled ControlCommand: "+e)}return!0}if(t instanceof R){let e=t,i=this.state.PopEvaluationStack();return this.state.variablesState.Assign(e,i),!0}if(t instanceof F){let e=t,i=null;if(null!=e.pathForCount){let t=e.containerForCount,n=this.state.VisitCountForContainer(t);i=new C(n)}else i=this.state.variablesState.GetVariableWithName(e.name),null==i&&(this.Warning("Variable not found: '"+e.name+"'. Using default value of 0 (false). This can happen with temporary variables if the declaration hasn't yet been hit. Globals are always given a default value on load if a value doesn't exist in the save state."),i=new C(0));return this.state.PushEvaluationStack(i),!0}if(t instanceof M){let e=t,i=this.state.PopEvaluationStack(e.numberOfParameters),n=e.Call(i);return this.state.PushEvaluationStack(n),!0}return!1}ChoosePathString(t,i=!0,n=[]){if(this.IfAsyncWeCant("call ChoosePathString right now"),i)this.ResetCallstack();else if(this.state.callStack.currentElement.type==r.Function){let e="",i=this.state.callStack.currentElement.currentPointer.container;throw null!=i&&(e="("+i.path.toString()+") "),new Error("Story was running a function "+e+"when you called ChoosePathString("+t+") - this is almost certainly not not what you want! Full stack trace: \n"+this.state.callStack.callStackTrace)}this.state.PassArgumentsToEvaluationStack(n),this.ChoosePath(new e(t))}IfAsyncWeCant(t){if(this._asyncContinueActive)throw new Error("Can't "+t+". Story is in the middle of a ContinueAsync(). Make more ContinueAsync() calls or a single Continue() call beforehand.")}ChoosePath(t,e=!0){this.state.SetChosenPath(t,e),this.VisitChangedContainersDueToDivert()}ChooseChoiceIndex(t){t=t;let e=this.currentChoices;this.Assert(t>=0&&t<e.length,"choice out of range");let i=e[t];return null===i.threadAtGeneration?d("choiceToChoose.threadAtGeneration"):null===i.targetPath?d("choiceToChoose.targetPath"):(this.state.callStack.currentThread=i.threadAtGeneration,void this.ChoosePath(i.targetPath))}HasFunction(t){try{return null!=this.KnotContainerWithName(t)}catch(t){return!1}}EvaluateFunction(t,e=[],i=!1){if(this.IfAsyncWeCant("evaluate a function"),null==t)throw new Error("Function is null");if(""==t||""==t.trim())throw new Error("Function is empty or white space.");let n=this.KnotContainerWithName(t);if(null==n)throw new Error("Function doesn't exist: '"+t+"'");let r=[];r.push.apply(r,this.state.outputStream),this._state.ResetOutput(),this.state.StartFunctionEvaluationFromGame(n,e);let s=new f;for(;this.canContinue;)s.Append(this.Continue());let a=s.toString();this._state.ResetOutput(r);let o=this.state.CompleteFunctionEvaluationFromGame();return i?{returned:o,output:a}:o}EvaluateExpression(t){let e=this.state.callStack.elements.length;this.state.callStack.Push(r.Tunnel),this._temporaryEvaluationContainer=t,this.state.GoToStart();let i=this.state.evaluationStack.length;return this.Continue(),this._temporaryEvaluationContainer=null,this.state.callStack.elements.length>e&&this.state.PopCallStack(),this.state.evaluationStack.length>i?this.state.PopEvaluationStack():null}CallExternalFunction(t,e){if(null===t)return d("funcName");let i=this._externals.get(t),n=null;if(void 0===i){if(this.allowExternalFunctionFallbacks)return n=this.KnotContainerWithName(t),this.Assert(null!==n,"Trying to call EXTERNAL function '"+t+"' which has not been bound, and fallback ink function could not be found."),this.state.callStack.Push(r.Function,void 0,this.state.outputStream.length),void(this.state.divertedPointer=A.StartOf(n));this.Assert(!1,"Trying to call EXTERNAL function '"+t+"' which has not been bound (and ink fallbacks disabled).")}let s=[];for(let t=0;t<e;++t){let t=a(this.state.PopEvaluationStack(),S).valueObject;s.push(t)}s.reverse();let o=i(s),l=null;null!=o?(l=S.Create(o),this.Assert(null!==l,"Could not create ink value from returned object of type "+typeof o)):l=new V,this.state.PushEvaluationStack(l)}BindExternalFunctionGeneral(t,e){this.IfAsyncWeCant("bind an external function"),this.Assert(!this._externals.has(t),"Function '"+t+"' has already been bound."),this._externals.set(t,e)}TryCoerce(t){return t}BindExternalFunction(t,e){this.Assert(null!=e,"Can't bind a null function"),this.BindExternalFunctionGeneral(t,t=>{this.Assert(t.length>=e.length,"External function expected "+e.length+" arguments");let i=[];for(let e=0,n=t.length;e<n;e++)i[e]=this.TryCoerce(t[e]);return e.apply(null,i)})}UnbindExternalFunction(t){this.IfAsyncWeCant("unbind an external a function"),this.Assert(this._externals.has(t),"Function '"+t+"' has not been bound."),this._externals.delete(t)}ValidateExternalBindings(){let t=null,e=null,i=arguments[1]||new Set;if(arguments[0]instanceof k&&(t=arguments[0]),arguments[0]instanceof p&&(e=arguments[0]),null===t&&null===e)if(this.ValidateExternalBindings(this._mainContentContainer,i),this._hasValidatedExternals=!0,0==i.size)this._hasValidatedExternals=!0;else{let t="Error: Missing function binding for external";t+=i.size>1?"s":"",t+=": '",t+=Array.from(i).join("', '"),t+="' ",t+=this.allowExternalFunctionFallbacks?", and no fallback ink function found.":" (ink fallbacks disabled)",this.Error(t)}else if(null!=t){for(let e of t.content){let t=e;null!=t&&t.hasValidName||this.ValidateExternalBindings(e,i)}for(let[,e]of t.namedContent)this.ValidateExternalBindings(s(e,p),i)}else if(null!=e){let t=s(e,I);if(t&&t.isExternal){let e=t.targetPathString;if(null===e)return d("name");this._externals.has(e)||this.allowExternalFunctionFallbacks&&this.mainContentContainer.namedContent.has(e)||i.add(e)}}}ObserveVariable(t,e){if(this.IfAsyncWeCant("observe a new variable"),null===this._variableObservers&&(this._variableObservers=new Map),!this.state.variablesState.GlobalVariableExistsWithName(t))throw new _("Cannot observe variable '"+t+"' because it wasn't declared in the ink story.");this._variableObservers.has(t)?this._variableObservers.get(t).push(e):this._variableObservers.set(t,[e])}ObserveVariables(t,e){for(let i=0,n=t.length;i<n;i++)this.ObserveVariable(t[i],e[i])}RemoveVariableObserver(t,e){if(this.IfAsyncWeCant("remove a variable observer"),null!==this._variableObservers)if(void 0!==e){if(this._variableObservers.has(e)){let i=this._variableObservers.get(e);null!==t?i.splice(i.indexOf(t),1):this._variableObservers.delete(e)}}else if(null!==t){let e=this._variableObservers.keys();for(let i of e){let e=this._variableObservers.get(i);e.splice(e.indexOf(t),1)}}}VariableStateDidChangeEvent(t,e){if(null===this._variableObservers)return;let i=this._variableObservers.get(t);if(void 0!==i){if(!(e instanceof S))throw new Error("Tried to get the value of a variable that isn't a standard type");let n=a(e,S);for(let e of i)e(t,n.valueObject)}}get globalTags(){return this.TagsAtStartOfFlowContainerWithPathString("")}TagsForContentAtPath(t){return this.TagsAtStartOfFlowContainerWithPathString(t)}TagsAtStartOfFlowContainerWithPathString(t){let i=new e(t),n=this.ContentAtPath(i).container;if(null===n)return d("flowContainer");for(;;){let t=n.content[0];if(!(t instanceof k))break;n=t}let r=null;for(let t of n.content){let e=s(t,L);if(!e)break;null==r&&(r=[]),r.push(e.text)}return r}BuildStringOfHierarchy(){let t=new f;return this.mainContentContainer.BuildStringOfHierarchy(t,0,this.state.currentPointer.Resolve()),t.toString()}BuildStringOfContainer(t){let e=new f;return t.BuildStringOfHierarchy(e,0,this.state.currentPointer.Resolve()),e.toString()}NextContent(){if(this.state.previousPointer=this.state.currentPointer.copy(),(this.state.divertedPointer.isNull||(this.state.currentPointer=this.state.divertedPointer.copy(),this.state.divertedPointer=A.Null,this.VisitChangedContainersDueToDivert(),this.state.currentPointer.isNull))&&!this.IncrementContentPointer()){let t=!1;this.state.callStack.CanPop(r.Function)?(this.state.PopCallStack(r.Function),this.state.inExpressionEvaluation&&this.state.PushEvaluationStack(new V),t=!0):this.state.callStack.canPopThread?(this.state.callStack.PopThread(),t=!0):this.state.TryExitFunctionEvaluationFromGame(),t&&!this.state.currentPointer.isNull&&this.NextContent()}}IncrementContentPointer(){let t=!0,e=this.state.callStack.currentElement.currentPointer.copy();if(e.index++,null===e.container)return d("pointer.container");for(;e.index>=e.container.content.length;){t=!1;let i=s(e.container.parent,k);if(i instanceof k==0)break;let n=i.content.indexOf(e.container);if(-1==n)break;if(e=new A(i,n),e.index++,t=!0,null===e.container)return d("pointer.container")}return t||(e=A.Null),this.state.callStack.currentElement.currentPointer=e.copy(),t}TryFollowDefaultInvisibleChoice(){let t=this._state.currentChoices,e=t.filter(t=>t.isInvisibleDefault);if(0==e.length||t.length>e.length)return!1;let i=e[0];return null===i.targetPath?d("choice.targetPath"):null===i.threadAtGeneration?d("choice.threadAtGeneration"):(this.state.callStack.currentThread=i.threadAtGeneration,this.ChoosePath(i.targetPath,!1),!0)}NextSequenceShuffleIndex(){let t=s(this.state.PopEvaluationStack(),C);if(!(t instanceof C))return this.Error("expected number of elements in sequence for shuffle index"),0;let e=this.state.currentPointer.container;if(null===e)return d("seqContainer");if(null===t.value)return d("numElementsIntVal.value");let i=t.value,n=a(this.state.PopEvaluationStack(),C).value;if(null===n)return d("seqCount");let r=n/i,o=n%i,l=e.path.toString(),h=0;for(let t=0,e=l.length;t<e;t++)h+=l.charCodeAt(t)||0;let u=h+r+this.state.storySeed,c=new q(Math.floor(u)),p=[];for(let t=0;t<i;++t)p.push(t);for(let t=0;t<=o;++t){let e=c.next()%p.length,i=p[e];if(p.splice(e,1),t==o)return i}throw new Error("Should never reach here")}Error(t,e=!1){let i=new _(t);throw i.useEndLineNumber=e,i}Warning(t){this.AddError(t,!0)}AddError(t,e=!1,i=!1){let n=this.currentDebugMetadata,r=e?"WARNING":"ERROR";if(null!=n){let e=i?n.endLineNumber:n.startLineNumber;t="RUNTIME "+r+": '"+n.fileName+"' line "+e+": "+t}else t=this.state.currentPointer.isNull?"RUNTIME "+r+": "+t:"RUNTIME "+r+": ("+this.state.currentPointer+"): "+t;this.state.AddError(t,e),e||this.state.ForceEnd()}Assert(t,e=null){if(0==t)throw null==e&&(e="Story assert"),new Error(e+" "+this.currentDebugMetadata)}get currentDebugMetadata(){let t,e=this.state.currentPointer;if(!e.isNull&&null!==e.Resolve()&&(t=e.Resolve().debugMetadata,null!==t))return t;for(let i=this.state.callStack.elements.length-1;i>=0;--i)if(e=this.state.callStack.elements[i].currentPointer,!e.isNull&&null!==e.Resolve()&&(t=e.Resolve().debugMetadata,null!==t))return t;for(let e=this.state.outputStream.length-1;e>=0;--e)if(t=this.state.outputStream[e].debugMetadata,null!==t)return t;return null}get mainContentContainer(){return this._temporaryEvaluationContainer?this._temporaryEvaluationContainer:this._mainContentContainer}}Y.inkVersionCurrent=19,function(t){let e;!function(t){t[t.NoChange=0]="NoChange",t[t.ExtendedBeyondNewline=1]="ExtendedBeyondNewline",t[t.NewlineRemoved=2]="NewlineRemoved"}(e=t.OutputStateChange||(t.OutputStateChange={}))}(Y||(Y={})),t.InkList=g,t.Story=Y,Object.defineProperty(t,"__esModule",{value:!0})}(e)},function(t){t.exports=JSON.parse('{"inkVersion":19,"root":[[{"->":"intro"},["done",{"#n":"g-0"}],null],"done",{"intro":[["^The torchlight flickers off the cave walls.","\\n","ev","str","^Where am I?","/str","/ev",{"*":".^.c-0","flg":20},{"c-0":["\\n","^The cave was found earlier in the day by some kids.","\\n","^They said they moved some rocks out of the way by a creek ","<>","\\n","^near Birmingham","\\n",["ev","str","^Bootleggers","/str","/ev",{"*":".^.c-0","flg":20},{"c-0":["\\n","^I\'d bet anything there\'s a cache of alcohol in there, the miners","\\n","^like to hide it in caves.","\\n",["ev","str","^Look Around","/str","/ev",{"*":".^.c-0","flg":20},{"c-0":["\\n","^You find a %c{red}swiss army knife%c{} on the cave ground","\\n","^A rumble is heard, and the entrance is sealed.","\\n","done",{"#f":5}]}],{"#f":5}]}],{"#f":5}]}],null]}],"listDefs":{}}')},function(t,e,i){"use strict";i.r(e);var n={};i.r(n),i.d(n,"TYPE_TEXT",(function(){return S})),i.d(n,"TYPE_NEWLINE",(function(){return C})),i.d(n,"TYPE_FG",(function(){return b})),i.d(n,"TYPE_BG",(function(){return w})),i.d(n,"measure",(function(){return T})),i.d(n,"tokenize",(function(){return x}));var r=i(0),s=i(3);class a extends s.a{constructor(){super(),this._ctx=document.createElement("canvas").getContext("2d")}schedule(t){requestAnimationFrame(t)}getContainer(){return this._ctx.canvas}setOptions(t){super.setOptions(t);const e=`${t.fontStyle?t.fontStyle+" ":""} ${t.fontSize}px ${t.fontFamily}`;this._ctx.font=e,this._updateSize(),this._ctx.font=e,this._ctx.textAlign="center",this._ctx.textBaseline="middle"}clear(){this._ctx.fillStyle=this._options.bg,this._ctx.fillRect(0,0,this._ctx.canvas.width,this._ctx.canvas.height)}eventToPosition(t,e){let i=this._ctx.canvas,n=i.getBoundingClientRect();return t-=n.left,e-=n.top,t*=i.width/n.width,e*=i.height/n.height,t<0||e<0||t>=i.width||e>=i.height?[-1,-1]:this._normalizedEventToPosition(t,e)}}var o=i(1);class l extends a{constructor(){super(),this._spacingX=0,this._spacingY=0,this._hexSize=0}draw(t,e){let[i,n,r,s,a]=t,o=[(i+1)*this._spacingX,n*this._spacingY+this._hexSize];if(this._options.transpose&&o.reverse(),e&&(this._ctx.fillStyle=a,this._fill(o[0],o[1])),!r)return;this._ctx.fillStyle=s;let l=[].concat(r);for(let t=0;t<l.length;t++)this._ctx.fillText(l[t],o[0],Math.ceil(o[1]))}computeSize(t,e){return this._options.transpose&&(t+=e,t-=e=t-e),[Math.floor(t/this._spacingX)-1,Math.floor((e-2*this._hexSize)/this._spacingY+1)]}computeFontSize(t,e){this._options.transpose&&(t+=e,t-=e=t-e);let i=2*t/((this._options.width+1)*Math.sqrt(3))-1,n=e/(2+1.5*(this._options.height-1)),r=Math.min(i,n),s=this._ctx.font;this._ctx.font="100px "+this._options.fontFamily;let a=Math.ceil(this._ctx.measureText("W").width);this._ctx.font=s;let o=a/100;r=Math.floor(r)+1;let l=2*r/(this._options.spacing*(1+o/Math.sqrt(3)));return Math.ceil(l)-1}_normalizedEventToPosition(t,e){let i;this._options.transpose?(t+=e,t-=e=t-e,i=this._ctx.canvas.width):i=this._ctx.canvas.height;let n=i/this._options.height;return e=Math.floor(e/n),Object(o.mod)(e,2)?(t-=this._spacingX,t=1+2*Math.floor(t/(2*this._spacingX))):t=2*Math.floor(t/(2*this._spacingX)),[t,e]}_fill(t,e){let i=this._hexSize,n=this._options.border;const r=this._ctx;r.beginPath(),this._options.transpose?(r.moveTo(t-i+n,e),r.lineTo(t-i/2+n,e+this._spacingX-n),r.lineTo(t+i/2-n,e+this._spacingX-n),r.lineTo(t+i-n,e),r.lineTo(t+i/2-n,e-this._spacingX+n),r.lineTo(t-i/2+n,e-this._spacingX+n),r.lineTo(t-i+n,e)):(r.moveTo(t,e-i+n),r.lineTo(t+this._spacingX-n,e-i/2+n),r.lineTo(t+this._spacingX-n,e+i/2-n),r.lineTo(t,e+i-n),r.lineTo(t-this._spacingX+n,e+i/2-n),r.lineTo(t-this._spacingX+n,e-i/2+n),r.lineTo(t,e-i+n)),r.fill()}_updateSize(){const t=this._options,e=Math.ceil(this._ctx.measureText("W").width);let i,n;this._hexSize=Math.floor(t.spacing*(t.fontSize+e/Math.sqrt(3))/2),this._spacingX=this._hexSize*Math.sqrt(3)/2,this._spacingY=1.5*this._hexSize,t.transpose?(i="height",n="width"):(i="width",n="height"),this._ctx.canvas[i]=Math.ceil((t.width+1)*this._spacingX),this._ctx.canvas[n]=Math.ceil((t.height-1)*this._spacingY+2*this._hexSize)}}var h=(()=>{class t extends a{constructor(){super(),this._spacingX=0,this._spacingY=0,this._canvasCache={}}setOptions(t){super.setOptions(t),this._canvasCache={}}draw(e,i){t.cache?this._drawWithCache(e):this._drawNoCache(e,i)}_drawWithCache(t){let e,[i,n,r,s,a]=t,o=""+r+s+a;if(o in this._canvasCache)e=this._canvasCache[o];else{let t=this._options.border;e=document.createElement("canvas");let i=e.getContext("2d");if(e.width=this._spacingX,e.height=this._spacingY,i.fillStyle=a,i.fillRect(t,t,e.width-t,e.height-t),r){i.fillStyle=s,i.font=this._ctx.font,i.textAlign="center",i.textBaseline="middle";let t=[].concat(r);for(let e=0;e<t.length;e++)i.fillText(t[e],this._spacingX/2,Math.ceil(this._spacingY/2))}this._canvasCache[o]=e}this._ctx.drawImage(e,i*this._spacingX,n*this._spacingY)}_drawNoCache(t,e){let[i,n,r,s,a]=t;if(e){let t=this._options.border;this._ctx.fillStyle=a,this._ctx.fillRect(i*this._spacingX+t,n*this._spacingY+t,this._spacingX-t,this._spacingY-t)}if(!r)return;this._ctx.fillStyle=s;let o=[].concat(r);for(let t=0;t<o.length;t++)this._ctx.fillText(o[t],(i+.5)*this._spacingX,Math.ceil((n+.5)*this._spacingY))}computeSize(t,e){return[Math.floor(t/this._spacingX),Math.floor(e/this._spacingY)]}computeFontSize(t,e){let i=Math.floor(t/this._options.width),n=Math.floor(e/this._options.height),r=this._ctx.font;this._ctx.font="100px "+this._options.fontFamily;let s=Math.ceil(this._ctx.measureText("W").width);this._ctx.font=r;let a=s/100*n/i;return a>1&&(n=Math.floor(n/a)),Math.floor(n/this._options.spacing)}_normalizedEventToPosition(t,e){return[Math.floor(t/this._spacingX),Math.floor(e/this._spacingY)]}_updateSize(){const t=this._options,e=Math.ceil(this._ctx.measureText("W").width);this._spacingX=Math.ceil(t.spacing*e),this._spacingY=Math.ceil(t.spacing*t.fontSize),t.forceSquareRatio&&(this._spacingX=this._spacingY=Math.max(this._spacingX,this._spacingY)),this._ctx.canvas.width=t.width*this._spacingX,this._ctx.canvas.height=t.height*this._spacingY}}return t.cache=!1,t})();class u extends a{constructor(){super(),this._colorCanvas=document.createElement("canvas")}draw(t,e){let[i,n,r,s,a]=t,o=this._options.tileWidth,l=this._options.tileHeight;if(e&&(this._options.tileColorize?this._ctx.clearRect(i*o,n*l,o,l):(this._ctx.fillStyle=a,this._ctx.fillRect(i*o,n*l,o,l))),!r)return;let h=[].concat(r),u=[].concat(s),c=[].concat(a);for(let t=0;t<h.length;t++){let e=this._options.tileMap[h[t]];if(!e)throw new Error(`Char "${h[t]}" not found in tileMap`);if(this._options.tileColorize){let r=this._colorCanvas,s=r.getContext("2d");s.globalCompositeOperation="source-over",s.clearRect(0,0,o,l);let a=u[t],h=c[t];s.drawImage(this._options.tileSet,e[0],e[1],o,l,0,0,o,l),"transparent"!=a&&(s.fillStyle=a,s.globalCompositeOperation="source-atop",s.fillRect(0,0,o,l)),"transparent"!=h&&(s.fillStyle=h,s.globalCompositeOperation="destination-over",s.fillRect(0,0,o,l)),this._ctx.drawImage(r,i*o,n*l,o,l)}else this._ctx.drawImage(this._options.tileSet,e[0],e[1],o,l,i*o,n*l,o,l)}}computeSize(t,e){return[Math.floor(t/this._options.tileWidth),Math.floor(e/this._options.tileHeight)]}computeFontSize(){throw new Error("Tile backend does not understand font size")}_normalizedEventToPosition(t,e){return[Math.floor(t/this._options.tileWidth),Math.floor(e/this._options.tileHeight)]}_updateSize(){const t=this._options;this._ctx.canvas.width=t.width*t.tileWidth,this._ctx.canvas.height=t.height*t.tileHeight,this._colorCanvas.width=t.tileWidth,this._colorCanvas.height=t.tileHeight}}var c=i(2);class d extends s.a{constructor(){super(),this._uniforms={};try{this._gl=this._initWebGL()}catch(t){alert(t.message)}}static isSupported(){return!!document.createElement("canvas").getContext("webgl2",{preserveDrawingBuffer:!0})}schedule(t){requestAnimationFrame(t)}getContainer(){return this._gl.canvas}setOptions(t){super.setOptions(t),this._updateSize();let e=this._options.tileSet;e&&"complete"in e&&!e.complete?e.addEventListener("load",()=>this._updateTexture(e)):this._updateTexture(e)}draw(t,e){const i=this._gl,n=this._options;let[r,s,a,o,l]=t,h=i.canvas.height-(s+1)*n.tileHeight;if(i.scissor(r*n.tileWidth,h,n.tileWidth,n.tileHeight),e&&(n.tileColorize?i.clearColor(0,0,0,0):i.clearColor(..._(l)),i.clear(i.COLOR_BUFFER_BIT)),!a)return;let u=[].concat(a),c=[].concat(l),d=[].concat(o);i.uniform2fv(this._uniforms.targetPosRel,[r,s]);for(let t=0;t<u.length;t++){let e=this._options.tileMap[u[t]];if(!e)throw new Error(`Char "${u[t]}" not found in tileMap`);i.uniform1f(this._uniforms.colorize,n.tileColorize?1:0),i.uniform2fv(this._uniforms.tilesetPosAbs,e),n.tileColorize&&(i.uniform4fv(this._uniforms.tint,_(d[t])),i.uniform4fv(this._uniforms.bg,_(c[t]))),i.drawArrays(i.TRIANGLE_STRIP,0,4)}}clear(){const t=this._gl;t.clearColor(..._(this._options.bg)),t.scissor(0,0,t.canvas.width,t.canvas.height),t.clear(t.COLOR_BUFFER_BIT)}computeSize(t,e){return[Math.floor(t/this._options.tileWidth),Math.floor(e/this._options.tileHeight)]}computeFontSize(){throw new Error("Tile backend does not understand font size")}eventToPosition(t,e){let i=this._gl.canvas,n=i.getBoundingClientRect();return t-=n.left,e-=n.top,t*=i.width/n.width,e*=i.height/n.height,t<0||e<0||t>=i.width||e>=i.height?[-1,-1]:this._normalizedEventToPosition(t,e)}_initWebGL(){let t=document.createElement("canvas").getContext("webgl2",{preserveDrawingBuffer:!0});window.gl=t;let e=function(t,e,i){const n=t.createShader(t.VERTEX_SHADER);if(t.shaderSource(n,e),t.compileShader(n),!t.getShaderParameter(n,t.COMPILE_STATUS))throw new Error(t.getShaderInfoLog(n)||"");const r=t.createShader(t.FRAGMENT_SHADER);if(t.shaderSource(r,i),t.compileShader(r),!t.getShaderParameter(r,t.COMPILE_STATUS))throw new Error(t.getShaderInfoLog(r)||"");const s=t.createProgram();if(t.attachShader(s,n),t.attachShader(s,r),t.linkProgram(s),!t.getProgramParameter(s,t.LINK_STATUS))throw new Error(t.getProgramInfoLog(s)||"");return s}(t,f,m);return t.useProgram(e),function(t){const e=new Float32Array([0,0,1,0,0,1,1,1]),i=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,i),t.bufferData(t.ARRAY_BUFFER,e,t.STATIC_DRAW),t.enableVertexAttribArray(0),t.vertexAttribPointer(0,2,t.FLOAT,!1,0,0)}(t),p.forEach(i=>this._uniforms[i]=t.getUniformLocation(e,i)),this._program=e,t.enable(t.BLEND),t.blendFuncSeparate(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA,t.ONE,t.ONE_MINUS_SRC_ALPHA),t.enable(t.SCISSOR_TEST),t}_normalizedEventToPosition(t,e){return[Math.floor(t/this._options.tileWidth),Math.floor(e/this._options.tileHeight)]}_updateSize(){const t=this._gl,e=this._options,i=[e.width*e.tileWidth,e.height*e.tileHeight];t.canvas.width=i[0],t.canvas.height=i[1],t.viewport(0,0,i[0],i[1]),t.uniform2fv(this._uniforms.tileSize,[e.tileWidth,e.tileHeight]),t.uniform2fv(this._uniforms.targetSize,i)}_updateTexture(t){!function(t,e){let i=t.createTexture();t.bindTexture(t.TEXTURE_2D,i),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.REPEAT),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.REPEAT),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,0),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,e)}(this._gl,t)}}const p=["targetPosRel","tilesetPosAbs","tileSize","targetSize","colorize","bg","tint"],f="\n#version 300 es\n\nin vec2 tilePosRel;\nout vec2 tilesetPosPx;\n\nuniform vec2 tilesetPosAbs;\nuniform vec2 tileSize;\nuniform vec2 targetSize;\nuniform vec2 targetPosRel;\n\nvoid main() {\n\tvec2 targetPosPx = (targetPosRel + tilePosRel) * tileSize;\n\tvec2 targetPosNdc = ((targetPosPx / targetSize)-0.5)*2.0;\n\ttargetPosNdc.y *= -1.0;\n\n\tgl_Position = vec4(targetPosNdc, 0.0, 1.0);\n\ttilesetPosPx = tilesetPosAbs + tilePosRel * tileSize;\n}".trim(),m="\n#version 300 es\nprecision highp float;\n\nin vec2 tilesetPosPx;\nout vec4 fragColor;\nuniform sampler2D image;\nuniform bool colorize;\nuniform vec4 bg;\nuniform vec4 tint;\n\nvoid main() {\n\tfragColor = vec4(0, 0, 0, 1);\n\n\tvec4 texel = texelFetch(image, ivec2(tilesetPosPx), 0);\n\n\tif (colorize) {\n\t\ttexel.rgb = tint.a * tint.rgb + (1.0-tint.a) * texel.rgb;\n\t\tfragColor.rgb = texel.a*texel.rgb + (1.0-texel.a)*bg.rgb;\n\t\tfragColor.a = texel.a + (1.0-texel.a)*bg.a;\n\t} else {\n\t\tfragColor = texel;\n\t}\n}".trim();let g={};function _(t){if(!(t in g)){let e;if("transparent"==t)e=[0,0,0,0];else if(t.indexOf("rgba")>-1){e=(t.match(/[\d.]+/g)||[]).map(Number);for(let t=0;t<3;t++)e[t]=e[t]/255}else e=c.fromString(t).map(t=>t/255),e.push(1);g[t]=e}return g[t]}var y=i(4);const v=/%([bc]){([^}]*)}/g,S=0,C=1,b=2,w=3;function T(t,e){let i={width:0,height:1},n=x(t,e),r=0;for(let t=0;t<n.length;t++){let e=n[t];switch(e.type){case S:r+=e.value.length;break;case C:i.height++,i.width=Math.max(i.width,r),r=0}}return i.width=Math.max(i.width,r),i}function x(t,e){let i=[],n=0;t.replace(v,(function(e,r,s,a){let o=t.substring(n,a);return o.length&&i.push({type:S,value:o}),i.push({type:"c"==r?b:w,value:s.trim()}),n=a+e.length,""}));let r=t.substring(n);return r.length&&i.push({type:S,value:r}),function(t,e){e||(e=1/0);let i=0,n=0,r=-1;for(;i<t.length;){let s=t[i];if(s.type==C&&(n=0,r=-1),s.type!=S){i++;continue}for(;0==n&&" "==s.value.charAt(0);)s.value=s.value.substring(1);let a=s.value.indexOf("\n");if(-1!=a){s.value=P(t,i,a,!0);let e=s.value.split("");for(;e.length&&" "==e[e.length-1];)e.pop();s.value=e.join("")}if(s.value.length){if(n+s.value.length>e){let a=-1;for(;;){let t=s.value.indexOf(" ",a+1);if(-1==t)break;if(n+t>e)break;a=t}if(-1!=a)s.value=P(t,i,a,!0);else if(-1!=r){let e=t[r],n=e.value.lastIndexOf(" ");e.value=P(t,r,n,!0),i=r}else s.value=P(t,i,e-n,!1)}else n+=s.value.length,-1!=s.value.indexOf(" ")&&(r=i);i++}else t.splice(i,1)}t.push({type:C});let s=null;for(let e=0;e<t.length;e++){let i=t[e];switch(i.type){case S:s=i;break;case C:if(s){let t=s.value.split("");for(;t.length&&" "==t[t.length-1];)t.pop();s.value=t.join("")}s=null}}return t.pop(),t}(i,e)}function P(t,e,i,n){let r={type:C},s={type:S,value:t[e].value.substring(i+(n?1:0))};return t.splice(e+1,0,r,s),t[e].value.substring(0,i)}const E={4:[[0,-1],[1,0],[0,1],[-1,0]],8:[[0,-1],[1,-1],[1,0],[1,1],[0,1],[-1,1],[-1,0],[-1,-1]],6:[[-1,-1],[1,-1],[2,0],[1,1],[-1,1],[-2,0]]},k={hex:l,rect:h,tile:u,"tile-gl":d,term:y.a},O={width:80,height:25,transpose:!1,layout:"rect",fontSize:15,spacing:1,border:0,forceSquareRatio:!1,fontFamily:"monospace",fontStyle:"",fg:"#ccc",bg:"#000",tileWidth:32,tileHeight:32,tileMap:{},tileSet:null,tileColorize:!1};var N=(()=>{class t{constructor(t={}){this._data={},this._dirty=!1,this._options={},t=Object.assign({},O,t),this.setOptions(t),this.DEBUG=this.DEBUG.bind(this),this._tick=this._tick.bind(this),this._backend.schedule(this._tick)}DEBUG(t,e,i){let n=[this._options.bg,this._options.fg];this.draw(t,e,null,null,n[i%n.length])}clear(){this._data={},this._dirty=!0}setOptions(t){if(Object.assign(this._options,t),t.width||t.height||t.fontSize||t.fontFamily||t.spacing||t.layout){if(t.layout){let e=k[t.layout];this._backend=new e}this._backend.setOptions(this._options),this._dirty=!0}return this}getOptions(){return this._options}getContainer(){return this._backend.getContainer()}computeSize(t,e){return this._backend.computeSize(t,e)}computeFontSize(t,e){return this._backend.computeFontSize(t,e)}computeTileSize(t,e){return[Math.floor(t/this._options.width),Math.floor(e/this._options.height)]}eventToPosition(t){let e,i;return"touches"in t?(e=t.touches[0].clientX,i=t.touches[0].clientY):(e=t.clientX,i=t.clientY),this._backend.eventToPosition(e,i)}draw(t,e,i,n,r){n||(n=this._options.fg),r||(r=this._options.bg);let s=`${t},${e}`;this._data[s]=[t,e,i,n,r],!0!==this._dirty&&(this._dirty||(this._dirty={}),this._dirty[s]=!0)}drawText(t,e,i,n){let r=null,s=null,a=t,o=e,l=1;n||(n=this._options.width-t);let h=x(i,n);for(;h.length;){let e=h.shift();switch(e.type){case S:let i=!1,n=!1,h=!1,u=!1;for(let t=0;t<e.value.length;t++){let l=e.value.charCodeAt(t),c=e.value.charAt(t);if("term"===this._options.layout){let t=l>>8;if(17===t||t>=46&&t<=159||t>=172&&t<=215||l>=43360&&l<=43391){this.draw(a+0,o,c,r,s),this.draw(a+1,o,"\t",r,s),a+=2;continue}}h=l>65280&&l<65377||l>65500&&l<65512||l>65518,i=32==c.charCodeAt(0)||12288==c.charCodeAt(0),!u||h||i||a++,h&&!n&&a++,this.draw(a++,o,c,r,s),n=i,u=h}break;case b:r=e.value||null;break;case w:s=e.value||null;break;case C:a=t,o++,l++}}return l}_tick(){if(this._backend.schedule(this._tick),this._dirty){if(!0===this._dirty){this._backend.clear();for(let t in this._data)this._draw(t,!1)}else for(let t in this._dirty)this._draw(t,!0);this._dirty=!1}}_draw(t,e){let i=this._data[t];i[4]!=this._options.bg&&(e=!0),this._backend.draw(i,e)}}return t.Rect=h,t.Hex=l,t.Tile=u,t.TileGL=d,t.Term=y.a,t})();class A{constructor(){this.heap=[],this.timestamp=0}lessThan(t,e){return t.key==e.key?t.timestamp<e.timestamp:t.key<e.key}shift(t){this.heap=this.heap.map(({key:e,value:i,timestamp:n})=>({key:e+t,value:i,timestamp:n}))}len(){return this.heap.length}push(t,e){this.timestamp+=1;const i=this.len();this.heap.push({value:t,timestamp:this.timestamp,key:e}),this.updateUp(i)}pop(){if(0==this.len())throw new Error("no element to pop");const t=this.heap[0];return this.len()>1?(this.heap[0]=this.heap.pop(),this.updateDown(0)):this.heap.pop(),t}find(t){for(let e=0;e<this.len();e++)if(t==this.heap[e].value)return this.heap[e];return null}remove(t){let e=null;for(let i=0;i<this.len();i++)t==this.heap[i].value&&(e=i);return null!=e&&(this.len()>1?(this.heap[e]=this.heap.pop(),this.updateDown(e),!0):(this.heap.pop(),!0))}parentNode(t){return Math.floor((t-1)/2)}leftChildNode(t){return 2*t+1}rightChildNode(t){return 2*t+2}existNode(t){return t>=0&&t<this.heap.length}swap(t,e){const i=this.heap[t];this.heap[t]=this.heap[e],this.heap[e]=i}minNode(t){const e=t.filter(this.existNode.bind(this));let i=e[0];for(const t of e)this.lessThan(this.heap[t],this.heap[i])&&(i=t);return i}updateUp(t){if(0==t)return;const e=this.parentNode(t);this.existNode(e)&&this.lessThan(this.heap[t],this.heap[e])&&(this.swap(t,e),this.updateUp(e))}updateDown(t){const e=this.leftChildNode(t),i=this.rightChildNode(t);if(!this.existNode(e))return;const n=this.minNode([t,e,i]);n!=t&&(this.swap(t,n),this.updateDown(n))}debugPrint(){console.log(this.heap)}}class I{constructor(){this._time=0,this._events=new A}getTime(){return this._time}clear(){return this._events=new A,this}add(t,e){this._events.push(t,e)}get(){if(!this._events.len())return null;let{key:t,value:e}=this._events.pop();return t>0&&(this._time+=t,this._events.shift(-t)),e}getEventTime(t){const e=this._events.find(t);if(e){const{key:t}=e;return t}}remove(t){return this._events.remove(t)}}class W{constructor(){this._queue=new I,this._repeat=[],this._current=null}getTime(){return this._queue.getTime()}add(t,e){return e&&this._repeat.push(t),this}getTimeOf(t){return this._queue.getEventTime(t)}clear(){return this._queue.clear(),this._repeat=[],this._current=null,this}remove(t){let e=this._queue.remove(t),i=this._repeat.indexOf(t);return-1!=i&&this._repeat.splice(i,1),this._current==t&&(this._current=null),e}next(){return this._current=this._queue.get(),this._current}}var F={Simple:class extends W{add(t,e){return this._queue.add(t,0),super.add(t,e)}next(){return null!==this._current&&-1!=this._repeat.indexOf(this._current)&&this._queue.add(this._current,0),super.next()}},Speed:class extends W{add(t,e,i){return this._queue.add(t,void 0!==i?i:1/t.getSpeed()),super.add(t,e)}next(){return this._current&&-1!=this._repeat.indexOf(this._current)&&this._queue.add(this._current,1/this._current.getSpeed()),super.next()}},Action:class extends W{constructor(){super(),this._defaultDuration=1,this._duration=this._defaultDuration}add(t,e,i){return this._queue.add(t,i||this._defaultDuration),super.add(t,e)}clear(){return this._duration=this._defaultDuration,super.clear()}remove(t){return t==this._current&&(this._duration=this._defaultDuration),super.remove(t)}next(){return null!==this._current&&-1!=this._repeat.indexOf(this._current)&&(this._queue.add(this._current,this._duration||this._defaultDuration),this._duration=this._defaultDuration),super.next()}setDuration(t){return this._current&&(this._duration=t),this}}};class R{constructor(t=80,e=25){this._width=t,this._height=e}_fillMap(t){let e=[];for(let i=0;i<this._width;i++){e.push([]);for(let n=0;n<this._height;n++)e[i].push(t)}return e}}class V extends R{constructor(t,e){super(t,e),this._rooms=[],this._corridors=[]}getRooms(){return this._rooms}getCorridors(){return this._corridors}}class M{}class L extends M{constructor(t,e,i,n,r,s){super(),this._x1=t,this._y1=e,this._x2=i,this._y2=n,this._doors={},void 0!==r&&void 0!==s&&this.addDoor(r,s)}static createRandomAt(t,e,i,n,s){let a=s.roomWidth[0],o=s.roomWidth[1],l=r.a.getUniformInt(a,o);a=s.roomHeight[0],o=s.roomHeight[1];let h=r.a.getUniformInt(a,o);if(1==i){let i=e-Math.floor(r.a.getUniform()*h);return new this(t+1,i,t+l,i+h-1,t,e)}if(-1==i){let i=e-Math.floor(r.a.getUniform()*h);return new this(t-l,i,t-1,i+h-1,t,e)}if(1==n){let i=t-Math.floor(r.a.getUniform()*l);return new this(i,e+1,i+l-1,e+h,t,e)}if(-1==n){let i=t-Math.floor(r.a.getUniform()*l);return new this(i,e-h,i+l-1,e-1,t,e)}throw new Error("dx or dy must be 1 or -1")}static createRandomCenter(t,e,i){let n=i.roomWidth[0],s=i.roomWidth[1],a=r.a.getUniformInt(n,s);n=i.roomHeight[0],s=i.roomHeight[1];let o=r.a.getUniformInt(n,s),l=t-Math.floor(r.a.getUniform()*a),h=e-Math.floor(r.a.getUniform()*o);return new this(l,h,l+a-1,h+o-1)}static createRandom(t,e,i){let n=i.roomWidth[0],s=i.roomWidth[1],a=r.a.getUniformInt(n,s);n=i.roomHeight[0],s=i.roomHeight[1];let o=r.a.getUniformInt(n,s),l=t-a-1,h=e-o-1,u=1+Math.floor(r.a.getUniform()*l),c=1+Math.floor(r.a.getUniform()*h);return new this(u,c,u+a-1,c+o-1)}addDoor(t,e){return this._doors[t+","+e]=1,this}getDoors(t){for(let e in this._doors){let i=e.split(",");t(parseInt(i[0]),parseInt(i[1]))}return this}clearDoors(){return this._doors={},this}addDoors(t){let e=this._x1-1,i=this._x2+1,n=this._y1-1,r=this._y2+1;for(let s=e;s<=i;s++)for(let a=n;a<=r;a++)s!=e&&s!=i&&a!=n&&a!=r||t(s,a)||this.addDoor(s,a);return this}debug(){console.log("room",this._x1,this._y1,this._x2,this._y2)}isValid(t,e){let i=this._x1-1,n=this._x2+1,r=this._y1-1,s=this._y2+1;for(let a=i;a<=n;a++)for(let o=r;o<=s;o++)if(a==i||a==n||o==r||o==s){if(!t(a,o))return!1}else if(!e(a,o))return!1;return!0}create(t){let e=this._x1-1,i=this._x2+1,n=this._y1-1,r=this._y2+1,s=0;for(let a=e;a<=i;a++)for(let o=n;o<=r;o++)s=a+","+o in this._doors?2:a==e||a==i||o==n||o==r?1:0,t(a,o,s)}getCenter(){return[Math.round((this._x1+this._x2)/2),Math.round((this._y1+this._y2)/2)]}getLeft(){return this._x1}getRight(){return this._x2}getTop(){return this._y1}getBottom(){return this._y2}}class D extends M{constructor(t,e,i,n){super(),this._startX=t,this._startY=e,this._endX=i,this._endY=n,this._endsWithAWall=!0}static createRandomAt(t,e,i,n,s){let a=s.corridorLength[0],o=s.corridorLength[1],l=r.a.getUniformInt(a,o);return new this(t,e,t+i*l,e+n*l)}debug(){console.log("corridor",this._startX,this._startY,this._endX,this._endY)}isValid(t,e){let i=this._startX,n=this._startY,r=this._endX-i,s=this._endY-n,a=1+Math.max(Math.abs(r),Math.abs(s));r&&(r/=Math.abs(r)),s&&(s/=Math.abs(s));let o=s,l=-r,h=!0;for(let u=0;u<a;u++){let c=i+u*r,d=n+u*s;if(e(c,d)||(h=!1),t(c+o,d+l)||(h=!1),t(c-o,d-l)||(h=!1),!h){a=u,this._endX=c-r,this._endY=d-s;break}}if(0==a)return!1;if(1==a&&t(this._endX+r,this._endY+s))return!1;let u=!t(this._endX+r+o,this._endY+s+l),c=!t(this._endX+r-o,this._endY+s-l);return this._endsWithAWall=t(this._endX+r,this._endY+s),!u&&!c||!this._endsWithAWall}create(t){let e=this._startX,i=this._startY,n=this._endX-e,r=this._endY-i,s=1+Math.max(Math.abs(n),Math.abs(r));n&&(n/=Math.abs(n)),r&&(r/=Math.abs(r));for(let a=0;a<s;a++){t(e+a*n,i+a*r,0)}return!0}createPriorityWalls(t){if(!this._endsWithAWall)return;let e=this._startX,i=this._startY,n=this._endX-e,r=this._endY-i;n&&(n/=Math.abs(n)),r&&(r/=Math.abs(r));let s=r,a=-n;t(this._endX+n,this._endY+r),t(this._endX+s,this._endY+a),t(this._endX-s,this._endY-a)}}const j={room:L,corridor:D};function B(t,e,i){i[e[t+1]]=i[t],e[i[t]]=e[t+1],i[t]=t+1,e[t+1]=t}function G(t,e,i){i[e[t]]=i[t],e[i[t]]=e[t],i[t]=t,e[t]=t}var U={Arena:class extends R{create(t){let e=this._width-1,i=this._height-1;for(let n=0;n<=e;n++)for(let r=0;r<=i;r++){t(n,r,n&&r&&n<e&&r<i?0:1)}return this}},Uniform:class extends V{constructor(t,e,i){super(t,e),this._options={roomWidth:[3,9],roomHeight:[3,5],roomDugPercentage:.1,timeLimit:1e3},Object.assign(this._options,i),this._map=[],this._dug=0,this._roomAttempts=20,this._corridorAttempts=20,this._connected=[],this._unconnected=[],this._digCallback=this._digCallback.bind(this),this._canBeDugCallback=this._canBeDugCallback.bind(this),this._isWallCallback=this._isWallCallback.bind(this)}create(t){let e=Date.now();for(;;){if(Date.now()-e>this._options.timeLimit)return null;if(this._map=this._fillMap(1),this._dug=0,this._rooms=[],this._unconnected=[],this._generateRooms(),!(this._rooms.length<2)&&this._generateCorridors())break}if(t)for(let e=0;e<this._width;e++)for(let i=0;i<this._height;i++)t(e,i,this._map[e][i]);return this}_generateRooms(){let t,e=this._width-2,i=this._height-2;do{if(t=this._generateRoom(),this._dug/(e*i)>this._options.roomDugPercentage)break}while(t)}_generateRoom(){let t=0;for(;t<this._roomAttempts;){t++;let e=L.createRandom(this._width,this._height,this._options);if(e.isValid(this._isWallCallback,this._canBeDugCallback))return e.create(this._digCallback),this._rooms.push(e),e}return null}_generateCorridors(){let t=0;for(;t<this._corridorAttempts;){t++,this._corridors=[],this._map=this._fillMap(1);for(let t=0;t<this._rooms.length;t++){let e=this._rooms[t];e.clearDoors(),e.create(this._digCallback)}for(this._unconnected=r.a.shuffle(this._rooms.slice()),this._connected=[],this._unconnected.length&&this._connected.push(this._unconnected.pop());;){let t=r.a.getItem(this._connected);if(!t)break;let e=this._closestRoom(this._unconnected,t);if(!e)break;let i=this._closestRoom(this._connected,e);if(!i)break;if(!this._connectRooms(e,i))break;if(!this._unconnected.length)return!0}}return!1}_closestRoom(t,e){let i=1/0,n=e.getCenter(),r=null;for(let e=0;e<t.length;e++){let s=t[e],a=s.getCenter(),o=a[0]-n[0],l=a[1]-n[1],h=o*o+l*l;h<i&&(i=h,r=s)}return r}_connectRooms(t,e){let i,n,r,s,a,o,l,h=t.getCenter(),u=e.getCenter(),c=u[0]-h[0],d=u[1]-h[1];if(Math.abs(c)<Math.abs(d)?(r=d>0?2:0,s=(r+2)%4,a=e.getLeft(),o=e.getRight(),l=0):(r=c>0?1:3,s=(r+2)%4,a=e.getTop(),o=e.getBottom(),l=1),i=this._placeInWall(t,r),!i)return!1;if(i[l]>=a&&i[l]<=o){n=i.slice();let t=0;switch(s){case 0:t=e.getTop()-1;break;case 1:t=e.getRight()+1;break;case 2:t=e.getBottom()+1;break;case 3:t=e.getLeft()-1}n[(l+1)%2]=t,this._digLine([i,n])}else if(i[l]<a-1||i[l]>o+1){let t=i[l]-u[l],r=0;switch(s){case 0:case 1:r=t<0?3:1;break;case 2:case 3:r=t<0?1:3}if(s=(s+r)%4,n=this._placeInWall(e,s),!n)return!1;let a=[0,0];a[l]=i[l];let o=(l+1)%2;a[o]=n[o],this._digLine([i,a,n])}else{let t=(l+1)%2;if(n=this._placeInWall(e,s),!n)return!1;let r=Math.round((n[t]+i[t])/2),a=[0,0],o=[0,0];a[l]=i[l],a[t]=r,o[l]=n[l],o[t]=r,this._digLine([i,a,o,n])}return t.addDoor(i[0],i[1]),e.addDoor(n[0],n[1]),l=this._unconnected.indexOf(t),-1!=l&&(this._unconnected.splice(l,1),this._connected.push(t)),l=this._unconnected.indexOf(e),-1!=l&&(this._unconnected.splice(l,1),this._connected.push(e)),!0}_placeInWall(t,e){let i=[0,0],n=[0,0],s=0;switch(e){case 0:n=[1,0],i=[t.getLeft(),t.getTop()-1],s=t.getRight()-t.getLeft()+1;break;case 1:n=[0,1],i=[t.getRight()+1,t.getTop()],s=t.getBottom()-t.getTop()+1;break;case 2:n=[1,0],i=[t.getLeft(),t.getBottom()+1],s=t.getRight()-t.getLeft()+1;break;case 3:n=[0,1],i=[t.getLeft()-1,t.getTop()],s=t.getBottom()-t.getTop()+1}let a=[],o=-2;for(let t=0;t<s;t++){let e=i[0]+t*n[0],r=i[1]+t*n[1];a.push(null),1==this._map[e][r]?o!=t-1&&(a[t]=[e,r]):(o=t,t&&(a[t-1]=null))}for(let t=a.length-1;t>=0;t--)a[t]||a.splice(t,1);return a.length?r.a.getItem(a):null}_digLine(t){for(let e=1;e<t.length;e++){let i=t[e-1],n=t[e],r=new D(i[0],i[1],n[0],n[1]);r.create(this._digCallback),this._corridors.push(r)}}_digCallback(t,e,i){this._map[t][e]=i,0==i&&this._dug++}_isWallCallback(t,e){return!(t<0||e<0||t>=this._width||e>=this._height)&&1==this._map[t][e]}_canBeDugCallback(t,e){return!(t<1||e<1||t+1>=this._width||e+1>=this._height)&&1==this._map[t][e]}},Cellular:class extends R{constructor(t,e,i={}){super(t,e),this._options={born:[5,6,7,8],survive:[4,5,6,7,8],topology:8},this.setOptions(i),this._dirs=E[this._options.topology],this._map=this._fillMap(0)}randomize(t){for(let e=0;e<this._width;e++)for(let i=0;i<this._height;i++)this._map[e][i]=r.a.getUniform()<t?1:0;return this}setOptions(t){Object.assign(this._options,t)}set(t,e,i){this._map[t][e]=i}create(t){let e=this._fillMap(0),i=this._options.born,n=this._options.survive;for(let t=0;t<this._height;t++){let r=1,s=0;6==this._options.topology&&(r=2,s=t%2);for(let a=s;a<this._width;a+=r){let r=this._map[a][t],s=this._getNeighbors(a,t);r&&-1!=n.indexOf(s)?e[a][t]=1:r||-1==i.indexOf(s)||(e[a][t]=1)}}this._map=e,t&&this._serviceCallback(t)}_serviceCallback(t){for(let e=0;e<this._height;e++){let i=1,n=0;6==this._options.topology&&(i=2,n=e%2);for(let r=n;r<this._width;r+=i)t(r,e,this._map[r][e])}}_getNeighbors(t,e){let i=0;for(let n=0;n<this._dirs.length;n++){let r=this._dirs[n],s=t+r[0],a=e+r[1];s<0||s>=this._width||a<0||a>=this._height||(i+=1==this._map[s][a]?1:0)}return i}connect(t,e,i){e||(e=0);let n=[],s={},a=1,o=[0,0];6==this._options.topology&&(a=2,o=[0,1]);for(let t=0;t<this._height;t++)for(let i=o[t%2];i<this._width;i+=a)if(this._freeSpace(i,t,e)){let e=[i,t];s[this._pointKey(e)]=e,n.push([i,t])}let l=n[r.a.getUniformInt(0,n.length-1)],h=this._pointKey(l),u={};for(u[h]=l,delete s[h],this._findConnected(u,s,[l],!1,e);Object.keys(s).length>0;){let t=this._getFromTo(u,s),n=t[0],r=t[1],a={};a[this._pointKey(n)]=n,this._findConnected(a,s,[n],!0,e),(6==this._options.topology?this._tunnelToConnected6:this._tunnelToConnected).call(this,r,n,u,s,e,i);for(let t in a){let i=a[t];this._map[i[0]][i[1]]=e,u[t]=i,delete s[t]}}t&&this._serviceCallback(t)}_getFromTo(t,e){let i,n=[0,0],s=[0,0],a=Object.keys(t),o=Object.keys(e);for(let l=0;l<5;l++){if(a.length<o.length){let i=a;s=t[i[r.a.getUniformInt(0,i.length-1)]],n=this._getClosest(s,e)}else{let i=o;n=e[i[r.a.getUniformInt(0,i.length-1)]],s=this._getClosest(n,t)}if(i=(n[0]-s[0])*(n[0]-s[0])+(n[1]-s[1])*(n[1]-s[1]),i<64)break}return[n,s]}_getClosest(t,e){let i=null,n=null;for(let r in e){let s=e[r],a=(s[0]-t[0])*(s[0]-t[0])+(s[1]-t[1])*(s[1]-t[1]);(null==n||a<n)&&(n=a,i=s)}return i}_findConnected(t,e,i,n,r){for(;i.length>0;){let s,a=i.splice(0,1)[0];s=6==this._options.topology?[[a[0]+2,a[1]],[a[0]+1,a[1]-1],[a[0]-1,a[1]-1],[a[0]-2,a[1]],[a[0]-1,a[1]+1],[a[0]+1,a[1]+1]]:[[a[0]+1,a[1]],[a[0]-1,a[1]],[a[0],a[1]+1],[a[0],a[1]-1]];for(let a=0;a<s.length;a++){let o=this._pointKey(s[a]);null==t[o]&&this._freeSpace(s[a][0],s[a][1],r)&&(t[o]=s[a],n||delete e[o],i.push(s[a]))}}}_tunnelToConnected(t,e,i,n,r,s){let a,o;e[0]<t[0]?(a=e,o=t):(a=t,o=e);for(let t=a[0];t<=o[0];t++){this._map[t][a[1]]=r;let e=[t,a[1]],s=this._pointKey(e);i[s]=e,delete n[s]}s&&a[0]<o[0]&&s(a,[o[0],a[1]]);let l=o[0];e[1]<t[1]?(a=e,o=t):(a=t,o=e);for(let t=a[1];t<o[1];t++){this._map[l][t]=r;let e=[l,t],s=this._pointKey(e);i[s]=e,delete n[s]}s&&a[1]<o[1]&&s([o[0],a[1]],[o[0],o[1]])}_tunnelToConnected6(t,e,i,n,r,s){let a,o;e[0]<t[0]?(a=e,o=t):(a=t,o=e);let l=a[0],h=a[1];for(;l!=o[0]||h!=o[1];){let t=2;h<o[1]?(h++,t=1):h>o[1]&&(h--,t=1),l<o[0]?l+=t:l>o[0]||o[1]%2?l-=t:l+=t,this._map[l][h]=r;let e=[l,h],s=this._pointKey(e);i[s]=e,delete n[s]}s&&s(e,t)}_freeSpace(t,e,i){return t>=0&&t<this._width&&e>=0&&e<this._height&&this._map[t][e]==i}_pointKey(t){return t[0]+"."+t[1]}},Digger:class extends V{constructor(t,e,i={}){super(t,e),this._options=Object.assign({roomWidth:[3,9],roomHeight:[3,5],corridorLength:[3,10],dugPercentage:.2,timeLimit:1e3},i),this._features={room:4,corridor:4},this._map=[],this._featureAttempts=20,this._walls={},this._dug=0,this._digCallback=this._digCallback.bind(this),this._canBeDugCallback=this._canBeDugCallback.bind(this),this._isWallCallback=this._isWallCallback.bind(this),this._priorityWallCallback=this._priorityWallCallback.bind(this)}create(t){this._rooms=[],this._corridors=[],this._map=this._fillMap(1),this._walls={},this._dug=0;let e=(this._width-2)*(this._height-2);this._firstRoom();let i,n=Date.now();do{if(i=0,Date.now()-n>this._options.timeLimit)break;let t=this._findWall();if(!t)break;let e=t.split(","),r=parseInt(e[0]),s=parseInt(e[1]),a=this._getDiggingDirection(r,s);if(!a)continue;let o=0;do{if(o++,this._tryFeature(r,s,a[0],a[1])){this._removeSurroundingWalls(r,s),this._removeSurroundingWalls(r-a[0],s-a[1]);break}}while(o<this._featureAttempts);for(let t in this._walls)this._walls[t]>1&&i++}while(this._dug/e<this._options.dugPercentage||i);if(this._addDoors(),t)for(let e=0;e<this._width;e++)for(let i=0;i<this._height;i++)t(e,i,this._map[e][i]);return this._walls={},this._map=[],this}_digCallback(t,e,i){0==i||2==i?(this._map[t][e]=0,this._dug++):this._walls[t+","+e]=1}_isWallCallback(t,e){return!(t<0||e<0||t>=this._width||e>=this._height)&&1==this._map[t][e]}_canBeDugCallback(t,e){return!(t<1||e<1||t+1>=this._width||e+1>=this._height)&&1==this._map[t][e]}_priorityWallCallback(t,e){this._walls[t+","+e]=2}_firstRoom(){let t=Math.floor(this._width/2),e=Math.floor(this._height/2),i=L.createRandomCenter(t,e,this._options);this._rooms.push(i),i.create(this._digCallback)}_findWall(){let t=[],e=[];for(let i in this._walls){2==this._walls[i]?e.push(i):t.push(i)}let i=e.length?e:t;if(!i.length)return null;let n=r.a.getItem(i.sort());return delete this._walls[n],n}_tryFeature(t,e,i,n){let s=r.a.getWeightedValue(this._features),a=j[s].createRandomAt(t,e,i,n,this._options);return!!a.isValid(this._isWallCallback,this._canBeDugCallback)&&(a.create(this._digCallback),a instanceof L&&this._rooms.push(a),a instanceof D&&(a.createPriorityWalls(this._priorityWallCallback),this._corridors.push(a)),!0)}_removeSurroundingWalls(t,e){let i=E[4];for(let n=0;n<i.length;n++){let r=i[n],s=t+r[0],a=e+r[1];delete this._walls[s+","+a],s=t+2*r[0],a=e+2*r[1],delete this._walls[s+","+a]}}_getDiggingDirection(t,e){if(t<=0||e<=0||t>=this._width-1||e>=this._height-1)return null;let i=null,n=E[4];for(let r=0;r<n.length;r++){let s=n[r],a=t+s[0],o=e+s[1];if(!this._map[a][o]){if(i)return null;i=s}}return i?[-i[0],-i[1]]:null}_addDoors(){let t=this._map;function e(e,i){return 1==t[e][i]}for(let t=0;t<this._rooms.length;t++){let i=this._rooms[t];i.clearDoors(),i.addDoors(e)}}},EllerMaze:class extends R{create(t){let e,i=this._fillMap(1),n=Math.ceil((this._width-2)/2),s=[],a=[];for(let t=0;t<n;t++)s.push(t),a.push(t);for(s.push(n-1),e=1;e+3<this._height;e+=2)for(let t=0;t<n;t++){let n=2*t+1,o=e;i[n][o]=0,t!=s[t+1]&&r.a.getUniform()>9/24&&(B(t,s,a),i[n+1][o]=0),t!=s[t]&&r.a.getUniform()>9/24?G(t,s,a):i[n][o+1]=0}for(let t=0;t<n;t++){let n=2*t+1,o=e;i[n][o]=0,t!=s[t+1]&&(t==s[t]||r.a.getUniform()>9/24)&&(B(t,s,a),i[n+1][o]=0),G(t,s,a)}for(let e=0;e<this._width;e++)for(let n=0;n<this._height;n++)t(e,n,i[e][n]);return this}},DividedMaze:class extends R{constructor(){super(...arguments),this._stack=[],this._map=[]}create(t){let e=this._width,i=this._height;this._map=[];for(let t=0;t<e;t++){this._map.push([]);for(let n=0;n<i;n++){let r=0==t||0==n||t+1==e||n+1==i;this._map[t].push(r?1:0)}}this._stack=[[1,1,e-2,i-2]],this._process();for(let n=0;n<e;n++)for(let e=0;e<i;e++)t(n,e,this._map[n][e]);return this._map=[],this}_process(){for(;this._stack.length;){let t=this._stack.shift();this._partitionRoom(t)}}_partitionRoom(t){let e=[],i=[];for(let i=t[0]+1;i<t[2];i++){let n=this._map[i][t[1]-1],r=this._map[i][t[3]+1];!n||!r||i%2||e.push(i)}for(let e=t[1]+1;e<t[3];e++){let n=this._map[t[0]-1][e],r=this._map[t[2]+1][e];!n||!r||e%2||i.push(e)}if(!e.length||!i.length)return;let n=r.a.getItem(e),s=r.a.getItem(i);this._map[n][s]=1;let a=[],o=[];a.push(o);for(let e=t[0];e<n;e++)this._map[e][s]=1,e%2&&o.push([e,s]);o=[],a.push(o);for(let e=n+1;e<=t[2];e++)this._map[e][s]=1,e%2&&o.push([e,s]);o=[],a.push(o);for(let e=t[1];e<s;e++)this._map[n][e]=1,e%2&&o.push([n,e]);o=[],a.push(o);for(let e=s+1;e<=t[3];e++)this._map[n][e]=1,e%2&&o.push([n,e]);let l=r.a.getItem(a);for(let t=0;t<a.length;t++){let e=a[t];if(e==l)continue;let i=r.a.getItem(e);this._map[i[0]][i[1]]=0}this._stack.push([t[0],t[1],n-1,s-1]),this._stack.push([n+1,t[1],t[2],s-1]),this._stack.push([t[0],s+1,n-1,t[3]]),this._stack.push([n+1,s+1,t[2],t[3]])}},IceyMaze:class extends R{constructor(t,e,i=0){super(t,e),this._regularity=i,this._map=[]}create(t){let e=this._width,i=this._height,n=this._fillMap(1);e-=e%2?1:2,i-=i%2?1:2;let s=0,a=0,o=0,l=0,h=0,u=!1,c=[[0,0],[0,0],[0,0],[0,0]];do{if(s=1+2*Math.floor(r.a.getUniform()*(e-1)/2),a=1+2*Math.floor(r.a.getUniform()*(i-1)/2),h||(n[s][a]=0),!n[s][a]){this._randomize(c);do{0==Math.floor(r.a.getUniform()*(this._regularity+1))&&this._randomize(c),u=!0;for(let t=0;t<4;t++)if(o=s+2*c[t][0],l=a+2*c[t][1],this._isFree(n,o,l,e,i)){n[o][l]=0,n[s+c[t][0]][a+c[t][1]]=0,s=o,a=l,u=!1,h++;break}}while(!u)}}while(h+1<e*i/4);for(let e=0;e<this._width;e++)for(let i=0;i<this._height;i++)t(e,i,n[e][i]);return this._map=[],this}_randomize(t){for(let e=0;e<4;e++)t[e][0]=0,t[e][1]=0;switch(Math.floor(4*r.a.getUniform())){case 0:t[0][0]=-1,t[1][0]=1,t[2][1]=-1,t[3][1]=1;break;case 1:t[3][0]=-1,t[2][0]=1,t[1][1]=-1,t[0][1]=1;break;case 2:t[2][0]=-1,t[3][0]=1,t[0][1]=-1,t[1][1]=1;break;case 3:t[1][0]=-1,t[0][0]=1,t[3][1]=-1,t[2][1]=1}}_isFree(t,e,i,n,r){return!(e<1||i<1||e>=n||i>=r)&&t[e][i]}},Rogue:class extends R{constructor(t,e,i){super(t,e),this.map=[],this.rooms=[],this.connectedCells=[],(i=Object.assign({cellWidth:3,cellHeight:3},i)).hasOwnProperty("roomWidth")||(i.roomWidth=this._calculateRoomSize(this._width,i.cellWidth)),i.hasOwnProperty("roomHeight")||(i.roomHeight=this._calculateRoomSize(this._height,i.cellHeight)),this._options=i}create(t){if(this.map=this._fillMap(1),this.rooms=[],this.connectedCells=[],this._initRooms(),this._connectRooms(),this._connectUnconnectedRooms(),this._createRandomRoomConnections(),this._createRooms(),this._createCorridors(),t)for(let e=0;e<this._width;e++)for(let i=0;i<this._height;i++)t(e,i,this.map[e][i]);return this}_calculateRoomSize(t,e){let i=Math.floor(t/e*.8),n=Math.floor(t/e*.25);return n<2&&(n=2),i<2&&(i=2),[n,i]}_initRooms(){for(let t=0;t<this._options.cellWidth;t++){this.rooms.push([]);for(let e=0;e<this._options.cellHeight;e++)this.rooms[t].push({x:0,y:0,width:0,height:0,connections:[],cellx:t,celly:e})}}_connectRooms(){let t,e,i,n,s,a,o=r.a.getUniformInt(0,this._options.cellWidth-1),l=r.a.getUniformInt(0,this._options.cellHeight-1),h=!1;do{a=[0,2,4,6],a=r.a.shuffle(a);do{if(h=!1,t=a.pop(),e=o+E[8][t][0],i=l+E[8][t][1],!(e<0||e>=this._options.cellWidth||i<0||i>=this._options.cellHeight)){if(n=this.rooms[o][l],n.connections.length>0&&n.connections[0][0]==e&&n.connections[0][1]==i)break;s=this.rooms[e][i],0==s.connections.length&&(s.connections.push([o,l]),this.connectedCells.push([e,i]),o=e,l=i,h=!0)}}while(a.length>0&&0==h)}while(a.length>0)}_connectUnconnectedRooms(){let t,e,i,n=this._options.cellWidth,s=this._options.cellHeight;this.connectedCells=r.a.shuffle(this.connectedCells);for(let a=0;a<this._options.cellWidth;a++)for(let o=0;o<this._options.cellHeight;o++)if(t=this.rooms[a][o],0==t.connections.length){let l=[0,2,4,6];l=r.a.shuffle(l),i=!1;do{let t=l.pop(),r=a+E[8][t][0],h=o+E[8][t][1];if(!(r<0||r>=n||h<0||h>=s)){if(e=this.rooms[r][h],i=!0,0==e.connections.length)break;for(let t=0;t<e.connections.length;t++)if(e.connections[t][0]==a&&e.connections[t][1]==o){i=!1;break}if(i)break}}while(l.length);i?t.connections.push([e.cellx,e.celly]):console.log("-- Unable to connect room.")}}_createRandomRoomConnections(){}_createRooms(){let t,e,i,n,s,a=this._width,o=this._height,l=this._options.cellWidth,h=this._options.cellHeight,u=Math.floor(this._width/l),c=Math.floor(this._height/h),d=this._options.roomWidth,p=this._options.roomHeight;for(let f=0;f<l;f++)for(let l=0;l<h;l++){if(i=u*f,n=c*l,0==i&&(i=1),0==n&&(n=1),t=r.a.getUniformInt(d[0],d[1]),e=r.a.getUniformInt(p[0],p[1]),l>0)for(s=this.rooms[f][l-1];n-(s.y+s.height)<3;)n++;if(f>0)for(s=this.rooms[f-1][l];i-(s.x+s.width)<3;)i++;let h=Math.round(r.a.getUniformInt(0,u-t)/2),m=Math.round(r.a.getUniformInt(0,c-e)/2);for(;i+h+t>=a;)h?h--:t--;for(;n+m+e>=o;)m?m--:e--;i+=h,n+=m,this.rooms[f][l].x=i,this.rooms[f][l].y=n,this.rooms[f][l].width=t,this.rooms[f][l].height=e;for(let r=i;r<i+t;r++)for(let t=n;t<n+e;t++)this.map[r][t]=0}}_getWallPosition(t,e){let i,n,s;return 1==e||3==e?(i=r.a.getUniformInt(t.x+1,t.x+t.width-2),1==e?(n=t.y-2,s=n+1):(n=t.y+t.height+1,s=n-1),this.map[i][s]=0):(n=r.a.getUniformInt(t.y+1,t.y+t.height-2),2==e?(i=t.x+t.width+1,s=i-1):(i=t.x-2,s=i+1),this.map[s][n]=0),[i,n]}_drawCorridor(t,e){let i,n,s,a,o=e[0]-t[0],l=e[1]-t[1],h=t[0],u=t[1],c=[],d=Math.abs(o),p=Math.abs(l),f=r.a.getUniform(),m=f,g=1-f;for(n=o>0?2:6,s=l>0?4:0,d<p?(i=Math.ceil(p*m),c.push([s,i]),c.push([n,d]),i=Math.floor(p*g),c.push([s,i])):(i=Math.ceil(d*m),c.push([n,i]),c.push([s,p]),i=Math.floor(d*g),c.push([n,i])),this.map[h][u]=0;c.length>0;)for(a=c.pop();a[1]>0;)h+=E[8][a[0]][0],u+=E[8][a[0]][1],this.map[h][u]=0,a[1]=a[1]-1}_createCorridors(){let t,e,i,n,r,s=this._options.cellWidth,a=this._options.cellHeight;for(let o=0;o<s;o++)for(let s=0;s<a;s++){t=this.rooms[o][s];for(let s=0;s<t.connections.length;s++)e=t.connections[s],i=this.rooms[e[0]][e[1]],i.cellx>t.cellx?(n=2,r=4):i.cellx<t.cellx?(n=4,r=2):i.celly>t.celly?(n=3,r=1):(n=1,r=3),this._drawCorridor(this._getWallPosition(t,n),this._getWallPosition(i,r))}}}};Math.sqrt(3),Math.sqrt(3);class z{constructor(t){this._scheduler=t,this._lock=1}start(){return this.unlock()}lock(){return this._lock++,this}unlock(){if(!this._lock)throw new Error("Cannot unlock unlocked engine");for(this._lock--;!this._lock;){let t=this._scheduler.next();if(!t)return this.lock();let e=t.act();e&&e.then&&(this.lock(),e.then(this.unlock.bind(this)))}return this}}const q=n;function H(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}var X=function(){function t(){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t)}var e,i,n;return e=t,n=[{key:"key",value:function(t,e){return t+","+e}},{key:"parseKey",value:function(t){var e=t.split(",");return[parseInt(e[0]),parseInt(e[1])]}}],(i=null)&&H(e.prototype,i),n&&H(e,n),t}();function K(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}var J=function(){function t(e,i,n){var r=this;!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),function(t,e,i){e in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i}(this,"handleEvent",(function(t){var e={38:0,33:1,39:2,34:3,40:4,35:5,37:6,36:7},i=t.keyCode;if(i in e){var n=E[8][e[i]],s=r.x+n[0],a=r.y+n[1];if(s+","+a in r.game.map){var o=X.key(r.x,r.y);r.game.display.draw(r.x,r.y,r.game.map[o]),r.x=s,r.y=a,r.draw(),window.removeEventListener("keydown",r),r.game.engine.unlock()}}})),this.x=e,this.y=i,this.game=n}var e,i,n;return e=t,(i=[{key:"draw",value:function(){this.game.display.draw(this.x,this.y,"@","#ff0")}},{key:"act",value:function(){this.game.dialogue.showing||(this.game.engine.lock(),window.addEventListener("keydown",this))}}])&&K(e.prototype,i),n&&K(e,n),t}();function Y(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}var $=i(6).Story,Q=function(){function t(e,i){var n,r,s,a=this;!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),s=function(t){console.log("handling event");var e=a.story.currentChoices;if(e.length>0){var i=event.key;console.log("got input: "+i),i>=1&&i<e.length+1&&(a.story.ChooseChoiceIndex(i-1),a.resetText())}if(13==event.keyCode&&!a.story.canContinue&&e.length<1)return a.showing=!1,a.game.engine.unlock(),void a.game.drawWholeMap();a.continue(),a.draw()},(r="handleEvent")in(n=this)?Object.defineProperty(n,r,{value:s,enumerable:!0,configurable:!0,writable:!0}):n[r]=s,this.game=i,this.story=new $(e),this.padding=10,this.resetText(),this.showing=!1}var e,i,n;return e=t,(i=[{key:"play",value:function(t){this.story.ChoosePathString(t),this.showing=!0,this.continue()}},{key:"draw",value:function(){if(this.showing){console.log("drawing text: "+this.text);var t=this.padding,e=this.padding,i=this.game.width-this.padding,n=this.game.height-this.padding;this.drawBox(t-1,e-1,i+1,n+1),this.drawBorder(t,e,i,n,"-","|","+"),this.drawText()}}},{key:"drawText",value:function(){for(var t=[this.padding+1,this.padding+1],e=0;e<this.text.length;e++){this.game.display.drawText(t[0],t[1],this.text[e],this.textWidth());var i=q.measure(this.text[e]),n=(i.width,i.height);console.log("drawing "+this.text[e]+", y = "+n),t[1]+=n}}},{key:"pushText",value:function(t){this.text.push(t)}},{key:"resetText",value:function(){this.text=[]}},{key:"act",value:function(){this.showing&&(console.log("waiting for input for story"),this.game.engine.lock(),window.addEventListener("keydown",this),this.draw())}},{key:"continue",value:function(){if(this.story.canContinue){for(;this.story.canContinue;)this.pushText(this.story.Continue());for(var t=this.story.currentChoices,e=0;e<t.length;e++){var i=t[e];this.pushText("%c{red}"+(e+1)+"%c{}: "+i.text)}0==t.length&&this.pushText("\nPush %c{red}enter%c{} to continue")}}},{key:"textWidth",value:function(){return this.game.width-2*this.padding}},{key:"drawBox",value:function(t,e,i,n,r){for(var s=t;s<=i;s++)for(var a=e;a<=n;a++)this.game.display.draw(s,a,r)}},{key:"drawBorder",value:function(t,e,i,n,r,s,a){var o=0,l=0;for(o=t;o<=i;o++)this.game.display.draw(o,e,r);for(o=t;o<=i;o++)this.game.display.draw(o,n,r);for(l=e;l<=n;l++)this.game.display.draw(t,l,s);for(l=e;l<=n;l++)this.game.display.draw(i,l,s);this.game.display.draw(t,e,a),this.game.display.draw(t,n,a),this.game.display.draw(i,e,a),this.game.display.draw(i,n,a)}}])&&Y(e.prototype,i),n&&Y(e,n),t}();function Z(t,e){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){if("undefined"==typeof Symbol||!(Symbol.iterator in Object(t)))return;var i=[],n=!0,r=!1,s=void 0;try{for(var a,o=t[Symbol.iterator]();!(n=(a=o.next()).done)&&(i.push(a.value),!e||i.length!==e);n=!0);}catch(t){r=!0,s=t}finally{try{n||null==o.return||o.return()}finally{if(r)throw s}}return i}(t,e)||function(t,e){if(!t)return;if("string"==typeof t)return tt(t,e);var i=Object.prototype.toString.call(t).slice(8,-1);"Object"===i&&t.constructor&&(i=t.constructor.name);if("Map"===i||"Set"===i)return Array.from(t);if("Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i))return tt(t,e)}(t,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function tt(t,e){(null==e||e>t.length)&&(e=t.length);for(var i=0,n=new Array(e);i<e;i++)n[i]=t[i];return n}function et(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}var it=i(7),nt=function(){function t(){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.map={},this.engine=null,this.player=null,this.width=100,this.height=40,this.dialogue=new Q(it,this),this.display=new N({width:this.width,height:this.height}),document.body.appendChild(this.display.getContainer()),this.generateMap();var e=new F.Simple;e.add(this.player,!0),e.add(this.dialogue,!0),this.dialogue.play("intro"),this.engine=new z(e),this.engine.start()}var e,i,n;return e=t,(i=[{key:"generateMap",value:function(){var t=new U.Digger(this.width,this.height),e=[];t.create(function(t,i,n){if(!n){var r=X.key(t,i);e.push(r),this.map[r]="."}}.bind(this)),this.generateBoxes(e),this.createPlayer(e),this.drawWholeMap()}},{key:"createPlayer",value:function(t){var e=Math.floor(r.a.getUniform()*t.length),i=t.splice(e,1)[0],n=Z(X.parseKey(i),2),s=n[0],a=n[1];this.player=new J(s,a,this)}},{key:"drawWholeMap",value:function(){for(var t in this.display.clear(),this.map){var e=Z(X.parseKey(t),2),i=e[0],n=e[1];this.display.draw(i,n,this.map[t])}this.player.draw(),this.dialogue&&this.dialogue.draw()}},{key:"generateBoxes",value:function(t){for(var e=0;e<10;e++){var i=Math.floor(r.a.getUniform()*t.length),n=t.splice(i,1)[0];this.map[n]="*"}}}])&&et(e.prototype,i),n&&et(e,n),t}();document.body.onload=function(){new nt}}]);